{% extends "base.html" %}

{% block title %}Automated Change Tracker - Metabolomics Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Page Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-phenikaa-blue mb-2">ü§ñ Automated Change Tracker</h2>
                    <p class="text-muted mb-0">Real-time file monitoring, automated backups, and version control</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="startTracking" class="btn btn-success">
                        <i class="fas fa-play"></i> Start Tracking
                    </button>
                    <button id="stopTracking" class="btn btn-danger">
                        <i class="fas fa-stop"></i> Stop Tracking
                    </button>
                    <button id="refreshData" class="btn btn-primary">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Service Status Card -->
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded p-3 me-3">
                                    <i class="fas fa-robot fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-muted">Service Status</h6>
                                    <span id="serviceStatus" class="fw-bold">
                                        {% if stats.service_running %}
                                            <span class="text-success">üü¢ Running</span>
                                        {% else %}
                                            <span class="text-danger">üî¥ Stopped</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded p-3 me-3">
                                    <i class="fas fa-folder-open fa-2x text-info"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-muted">Monitoring Path</h6>
                                    <small class="fw-bold">{{ stats.monitoring_path | replace('/mnt/c/', 'C:/') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded p-3 me-3">
                                    <i class="fas fa-save fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-muted">Backup Location</h6>
                                    <small class="fw-bold">{{ stats.backup_path | replace('/mnt/c/', 'C:/') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded p-3 me-3">
                                    <i class="fas fa-clock fa-2x text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-muted">Last Update</h6>
                                    <span id="lastUpdate" class="fw-bold">{{ moment().format('HH:mm:ss') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="col-12 mb-4">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3 d-inline-flex mb-3">
                                <i class="fas fa-exchange-alt fa-2x text-primary"></i>
                            </div>
                            <h3 class="fw-bold mb-1">{{ stats.total_changes or 0 }}</h3>
                            <p class="text-muted mb-0">Total Changes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3 d-inline-flex mb-3">
                                <i class="fas fa-calendar-day fa-2x text-success"></i>
                            </div>
                            <h3 class="fw-bold mb-1">{{ stats.today_changes or 0 }}</h3>
                            <p class="text-muted mb-0">Today's Changes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-3 d-inline-flex mb-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <h3 class="fw-bold mb-1">{{ stats.total_errors or 0 }}</h3>
                            <p class="text-muted mb-0">Errors Detected</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3 d-inline-flex mb-3">
                                <i class="fas fa-chart-line fa-2x text-info"></i>
                            </div>
                            <h3 class="fw-bold mb-1">{{ (stats.recent_activity.values() | sum) or 0 }}</h3>
                            <p class="text-muted mb-0">24h Activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Chart -->
        {% if stats.recent_activity %}
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">üìä Recent Activity Breakdown (24 hours)</h5>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Changes Table -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Recent Changes</h5>
                    <div class="d-flex gap-2">
                        <select id="timeFilter" class="form-select form-select-sm" style="width: auto;">
                            <option value="24">Last 24 hours</option>
                            <option value="72">Last 3 days</option>
                            <option value="168">Last week</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 ps-3">Time</th>
                                    <th class="border-0">File</th>
                                    <th class="border-0">Action</th>
                                    <th class="border-0">Size</th>
                                    <th class="border-0">Status</th>
                                    <th class="border-0">Backup</th>
                                    <th class="border-0">Git</th>
                                </tr>
                            </thead>
                            <tbody id="changesTable">
                                {% for change in recent_changes %}
                                <tr>
                                    <td class="ps-3">
                                        <small class="text-muted">{{ change.created_at | replace('T', ' ') | replace('.000000', '') }}</small>
                                    </td>
                                    <td>
                                        <code class="small">{{ change.file_path }}</code>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if change.change_type == 'created' %}bg-success
                                            {% elif change.change_type == 'modified' %}bg-primary
                                            {% elif change.change_type == 'deleted' %}bg-danger
                                            {% elif change.change_type == 'moved' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {% if change.change_type == 'created' %}‚ûï Created
                                            {% elif change.change_type == 'modified' %}‚úèÔ∏è Modified
                                            {% elif change.change_type == 'deleted' %}üóëÔ∏è Deleted
                                            {% elif change.change_type == 'moved' %}üì¶ Moved
                                            {% else %}{{ change.change_type }}{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ (change.file_size / 1024) | round(1) }} KB</small>
                                    </td>
                                    <td>
                                        {% if change.error_detected %}
                                            <span class="badge bg-danger">
                                                ‚ö†Ô∏è {{ change.change_severity | upper }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">‚úÖ OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if change.backup_path %}
                                            <i class="fas fa-check text-success" title="Backup created"></i>
                                        {% else %}
                                            <i class="fas fa-times text-muted" title="No backup"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if change.git_commit %}
                                            <code class="small">{{ change.git_commit }}</code>
                                        {% else %}
                                            <i class="fas fa-times text-muted" title="No commit"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                {% if not recent_changes %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="fas fa-info-circle mb-2"></i><br>
                                        No recent changes detected
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-robot me-2"></i>
            <strong class="me-auto">Change Tracker</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize activity chart
    {% if stats.recent_activity %}
    const ctx = document.getElementById('activityChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for action, count in stats.recent_activity.items() %}
                '{{ action.title() }} ({{ count }})',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for action, count in stats.recent_activity.items() %}
                    {{ count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#198754', // Created - green
                    '#0d6efd', // Modified - blue  
                    '#dc3545', // Deleted - red
                    '#ffc107'  // Moved - yellow
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    {% endif %}

    // Service control functions
    function showToast(message, isError = false) {
        const toast = document.getElementById('statusToast');
        const toastBody = toast.querySelector('.toast-body');
        toastBody.textContent = message;
        toastBody.className = `toast-body ${isError ? 'text-danger' : 'text-success'}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    function updateLastUpdate() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
    }

    // Start tracking
    document.getElementById('startTracking').addEventListener('click', function() {
        this.disabled = true;
        
        fetch('/start-change-tracking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message);
                document.getElementById('serviceStatus').innerHTML = '<span class="text-success">üü¢ Running</span>';
                updateLastUpdate();
            } else {
                showToast(data.message, true);
            }
        })
        .catch(error => {
            showToast('Failed to start tracking: ' + error.message, true);
        })
        .finally(() => {
            this.disabled = false;
        });
    });

    // Stop tracking
    document.getElementById('stopTracking').addEventListener('click', function() {
        this.disabled = true;
        
        fetch('/stop-change-tracking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message);
                document.getElementById('serviceStatus').innerHTML = '<span class="text-danger">üî¥ Stopped</span>';
                updateLastUpdate();
            } else {
                showToast(data.message, true);
            }
        })
        .catch(error => {
            showToast('Failed to stop tracking: ' + error.message, true);
        })
        .finally(() => {
            this.disabled = false;
        });
    });

    // Refresh data
    document.getElementById('refreshData').addEventListener('click', function() {
        location.reload();
    });

    // Time filter
    document.getElementById('timeFilter').addEventListener('change', function() {
        const hours = this.value;
        
        fetch(`/api/recent-changes/${hours}`)
        .then(response => response.json())
        .then(data => {
            if (data.changes) {
                updateChangesTable(data.changes);
            }
        })
        .catch(error => {
            showToast('Failed to load changes: ' + error.message, true);
        });
    });

    function updateChangesTable(changes) {
        const tbody = document.getElementById('changesTable');
        
        if (changes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="fas fa-info-circle mb-2"></i><br>
                        No changes found for selected time period
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = changes.map(change => `
            <tr>
                <td class="ps-3">
                    <small class="text-muted">${change.created_at.replace('T', ' ').replace('.000000', '')}</small>
                </td>
                <td>
                    <code class="small">${change.file_path}</code>
                </td>
                <td>
                    <span class="badge ${getActionBadgeClass(change.change_type)}">
                        ${getActionIcon(change.change_type)} ${change.change_type.charAt(0).toUpperCase() + change.change_type.slice(1)}
                    </span>
                </td>
                <td>
                    <small class="text-muted">${(change.file_size / 1024).toFixed(1)} KB</small>
                </td>
                <td>
                    ${change.error_detected ? 
                        `<span class="badge bg-danger">‚ö†Ô∏è ${change.change_severity.toUpperCase()}</span>` :
                        '<span class="badge bg-success">‚úÖ OK</span>'
                    }
                </td>
                <td>
                    ${change.backup_path ? 
                        '<i class="fas fa-check text-success" title="Backup created"></i>' :
                        '<i class="fas fa-times text-muted" title="No backup"></i>'
                    }
                </td>
                <td>
                    ${change.git_commit ? 
                        `<code class="small">${change.git_commit}</code>` :
                        '<i class="fas fa-times text-muted" title="No commit"></i>'
                    }
                </td>
            </tr>
        `).join('');
    }

    function getActionBadgeClass(action) {
        const classes = {
            'created': 'bg-success',
            'modified': 'bg-primary',
            'deleted': 'bg-danger',
            'moved': 'bg-warning'
        };
        return classes[action] || 'bg-secondary';
    }

    function getActionIcon(action) {
        const icons = {
            'created': '‚ûï',
            'modified': '‚úèÔ∏è',
            'deleted': 'üóëÔ∏è',
            'moved': 'üì¶'
        };
        return icons[action] || 'üìù';
    }

    // Auto-refresh every 30 seconds when service is running
    setInterval(function() {
        const serviceStatus = document.getElementById('serviceStatus').textContent;
        if (serviceStatus.includes('Running')) {
            // Only refresh stats, not the whole page
            fetch('/api/change-tracker-stats')
            .then(response => response.json())
            .then(stats => {
                // Update statistics cards
                const cards = document.querySelectorAll('.card-body h3');
                if (cards.length >= 4) {
                    cards[0].textContent = stats.total_changes || 0;
                    cards[1].textContent = stats.today_changes || 0;
                    cards[2].textContent = stats.total_errors || 0;
                    cards[3].textContent = Object.values(stats.recent_activity || {}).reduce((a, b) => a + b, 0);
                }
                updateLastUpdate();
            })
            .catch(error => {
                console.log('Stats refresh failed:', error);
            });
        }
    }, 30000);
});
</script>
{% endblock %}