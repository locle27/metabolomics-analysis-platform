{% extends "base.html" %}

{% block title %}Manage Lipids - Metabolomics DB{% endblock %}

{% block extra_css %}
<style>
    .lipid-table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }
    
    .lipid-row {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .lipid-row:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }
    
    .lipid-row.selected {
        background-color: #e3f2fd;
        border-left: 4px solid #007bff;
    }
    
    .lipid-details-panel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        display: none;
    }
    
    .lipid-details-panel.active {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .detail-section {
        background: white;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
    }
    
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 4px;
        margin: -5px -5px 10px -5px;
        font-weight: bold;
        font-size: 14px;
    }
    
    .ion-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        transition: all 0.2s ease;
    }
    
    .ion-card:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .ion-card.main-ion {
        border-left: 4px solid #28a745;
        background: #f0f9f0;
    }
    
    .property-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .property-item {
        display: flex;
        justify-content: between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .property-label {
        font-weight: 600;
        color: #495057;
        min-width: 120px;
    }
    
    .property-value {
        color: #6c757d;
        font-family: 'Courier New', monospace;
    }
    
    .stats-badges {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 15px 0;
    }
    
    .stat-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .lipid-name-cell {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .class-badge {
        background: #007bff;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .search-controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .btn-sm-custom {
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 4px;
    }
    
    .close-details-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 16px;
        cursor: pointer;
    }
    
    .xic-preview {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 150px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="display-6 text-center mb-4">üß¨ Manage Lipids Database</h1>
    
    <!-- Search and Filter Controls -->
    <div class="search-controls">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Search Lipids</label>
                <input type="text" id="search-input" class="form-control" 
                       placeholder="Search: ac120, tg480, pc341, or full names...">
                <small class="form-text text-muted">
                    üí° Try shorthand: "ac120" for AC(12:0), "180" for any 18:0 lipid
                </small>
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Class</label>
                <select id="class-filter" class="form-select">
                    <option value="">All Classes</option>
                    {% for cls in data.classes %}
                    <option value="{{ cls.class_name }}">{{ cls.class_name }} ({{ cls.count }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Extraction Status</label>
                <select id="status-filter" class="form-select">
                    <option value="">All Status</option>
                    <option value="success">Successful Only</option>
                    <option value="with_ions">With Annotated Ions</option>
                    <option value="multi_ion">Multi-Ion Lipids</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Actions</label>
                <div class="d-flex gap-2">
                    <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button id="export-btn" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="stats-badges">
        <span class="stat-badge">üìä Total: {{ data.stats.main_lipids or 0 }}</span>
        <span class="stat-badge">‚úÖ Successful: {{ data.stats.successful_extractions or 0 }}</span>
        <span class="stat-badge">üè∑Ô∏è Classes: {{ data.stats.lipid_classes or 0 }}</span>
        <span class="stat-badge">üîó Ions: {{ data.stats.annotated_ions or 0 }}</span>
        <span class="stat-badge">üìà Multi-Ion: {{ data.stats.multi_ion_lipids or 0 }}</span>
    </div>

    <!-- Lipids Table -->
    <div class="lipid-table-container">
        <div class="table-responsive">
            <table class="table table-hover" id="lipids-table">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Lipid Name</th>
                        <th>Class</th>
                        <th>API Code</th>
                        <th>RT (min)</th>
                        <th>MS/MS</th>
                        <th>Ions</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lipids-tbody">
                    {% for lipid in data.lipids %}
                    <tr class="lipid-row" data-lipid-id="{{ lipid.lipid_id }}" 
                        data-class="{{ lipid.class_name }}" 
                        data-name="{{ lipid.lipid_name | lower }}"
                        data-status="{{ 'success' if lipid.extraction_success else 'failed' }}"
                        data-has-ions="{{ 'true' if lipid.annotated_ions_count > 0 else 'false' }}"
                        data-multi-ion="{{ 'true' if lipid.annotated_ions_count > 1 else 'false' }}">
                        <td>{{ lipid.lipid_id }}</td>
                        <td class="lipid-name-cell">{{ lipid.lipid_name }}</td>
                        <td><span class="class-badge">{{ lipid.class_name or 'Unknown' }}</span></td>
                        <td><code>{{ lipid.api_code }}</code></td>
                        <td>
                            {% if lipid.retention_time %}
                                {{ "%.2f"|format(lipid.retention_time) }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if lipid.precursor_ion and lipid.product_ion %}
                                <small>{{ lipid.precursor_ion }} ‚Üí {{ lipid.product_ion }}</small>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if lipid.annotated_ions_count > 1 %}bg-success{% elif lipid.annotated_ions_count == 1 %}bg-info{% else %}bg-secondary{% endif %}">
                                {{ lipid.annotated_ions_count or 0 }}
                            </span>
                        </td>
                        <td>
                            {% if lipid.extraction_success %}
                                <span class="badge bg-success">Success</span>
                            {% else %}
                                <span class="badge bg-danger">Failed</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm-custom" onclick="toggleDetails({{ lipid.lipid_id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if lipid.annotated_ions_count > 0 %}
                                <button class="btn btn-success btn-sm-custom" onclick="generateChart({{ lipid.lipid_id }})">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    
                    <!-- Detailed View (Initially Hidden) -->
                    <tr id="details-{{ lipid.lipid_id }}" class="lipid-details-panel">
                        <td colspan="9">
                            <div style="position: relative;">
                                <button class="close-details-btn" onclick="closeDetails({{ lipid.lipid_id }})">√ó</button>
                                
                                <h5 class="mb-3">üìã Detailed Information: {{ lipid.lipid_name }}</h5>
                                
                                <div class="row">
                                    <!-- Main Properties -->
                                    <div class="col-md-6">
                                        <div class="detail-section">
                                            <div class="detail-header">üß¨ Main Properties</div>
                                            <div class="property-grid">
                                                <div class="property-item">
                                                    <span class="property-label">Lipid ID:</span>
                                                    <span class="property-value">{{ lipid.lipid_id }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">API Code:</span>
                                                    <span class="property-value">{{ lipid.api_code or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Class:</span>
                                                    <span class="property-value">{{ lipid.class_name or 'Unknown' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Retention Time:</span>
                                                    <span class="property-value">
                                                        {% if lipid.retention_time %}{{ "%.4f"|format(lipid.retention_time) }} min{% else %}N/A{% endif %}
                                                    </span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Precursor Ion:</span>
                                                    <span class="property-value">{{ lipid.precursor_ion or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Product Ion:</span>
                                                    <span class="property-value">{{ lipid.product_ion or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Collision Energy:</span>
                                                    <span class="property-value">{{ lipid.collision_energy or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Polarity:</span>
                                                    <span class="property-value">{{ lipid.polarity or 'N/A' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Extraction Info -->
                                    <div class="col-md-6">
                                        <div class="detail-section">
                                            <div class="detail-header">üìä Extraction Information</div>
                                            <div class="property-grid">
                                                <div class="property-item">
                                                    <span class="property-label">Method:</span>
                                                    <span class="property-value">{{ lipid.extraction_method or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Success:</span>
                                                    <span class="property-value">
                                                        {% if lipid.extraction_success %}‚úÖ Yes{% else %}‚ùå No{% endif %}
                                                    </span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Created:</span>
                                                    <span class="property-value">{{ lipid.created_at or 'N/A' }}</span>
                                                </div>
                                                <div class="property-item">
                                                    <span class="property-label">Internal Standard:</span>
                                                    <span class="property-value">{{ lipid.internal_standard or 'N/A' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- XIC Data Preview -->
                                        <div class="detail-section">
                                            <div class="detail-header">üìà XIC Data Summary</div>
                                            <div class="xic-preview" id="xic-preview-{{ lipid.lipid_id }}">
                                                Loading XIC data...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Annotated Ions Section -->
                                <div class="detail-section">
                                    <div class="detail-header">üîó Annotated Ions ({{ lipid.annotated_ions_count or 0 }} total)</div>
                                    <div id="ions-container-{{ lipid.lipid_id }}">
                                        Loading annotated ions...
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination will go here -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <small class="text-muted">Showing <span id="visible-count">{{ data.lipids|length }}</span> of {{ data.total_count }} lipids</small>
            </div>
            <div>
                <!-- Pagination controls -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDetailLipid = null;

// Search and filter functionality
document.getElementById('search-input').addEventListener('input', filterLipids);
document.getElementById('class-filter').addEventListener('change', filterLipids);
document.getElementById('status-filter').addEventListener('change', filterLipids);

function filterLipids() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const classFilter = document.getElementById('class-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    const rows = document.querySelectorAll('.lipid-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let visible = true;
        
        // Enhanced search filter with shorthand support
        if (searchTerm) {
            const lipidName = row.querySelector('.lipid-name-cell').textContent.toLowerCase();
            const apiCode = row.querySelector('code').textContent.toLowerCase();
            const rowName = row.dataset.name;
            
            // Direct match (existing functionality)
            if (rowName.includes(searchTerm) || lipidName.includes(searchTerm) || apiCode.includes(searchTerm)) {
                visible = true;
            }
            // Shorthand lipid code matching (new feature)
            else if (matchesShorthandCode(lipidName, searchTerm)) {
                visible = true;
            }
            else {
                visible = false;
            }
        }
        
        // Class filter
        if (classFilter && visible && row.dataset.class !== classFilter) {
            visible = false;
        }
        
        // Status filter
        if (statusFilter && visible) {
            switch (statusFilter) {
                case 'success':
                    visible = visible && row.dataset.status === 'success';
                    break;
                case 'with_ions':
                    visible = visible && row.dataset.hasIons === 'true';
                    break;
                case 'multi_ion':
                    visible = visible && row.dataset.multiIon === 'true';
                    break;
            }
        }
        
        if (visible) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Hide details if row is hidden
            const detailsRow = document.getElementById(`details-${row.dataset.lipidId}`);
            if (detailsRow) {
                detailsRow.classList.remove('active');
            }
        }
    });
    
    document.getElementById('visible-count').textContent = visibleCount;
}

function matchesShorthandCode(lipidName, searchTerm) {
    /**
     * Enhanced shorthand matching for lipid codes
     * Examples:
     * - "ac120" matches "ac(12:0)"
     * - "tg480" matches "tg(48:0)" or "tg48_0"
     * - "pc341" matches "pc(34:1)"
     * - "180" matches any lipid with "18:0"
     */
    
    // Remove all special characters for comparison
    const cleanLipid = lipidName.replace(/[():\-\[\]\/\s_]/g, '').toLowerCase();
    const cleanSearch = searchTerm.replace(/[():\-\[\]\/\s_]/g, '').toLowerCase();
    
    // Direct clean match
    if (cleanLipid.includes(cleanSearch)) {
        return true;
    }
    
    // Try to parse shorthand patterns like "ac120" -> "ac12:0"
    const shorthandPattern = /^([a-z]+)(\d+)$/;
    const match = cleanSearch.match(shorthandPattern);
    
    if (match) {
        const [, classPrefix, numbers] = match;
        
        // Try different number splitting patterns
        const patterns = [
            // Pattern 1: last digit as second number (ac120 -> ac(12:0))
            numbers.length >= 2 ? `${classPrefix}${numbers.slice(0, -1)}:${numbers.slice(-1)}` : null,
            
            // Pattern 2: split in half (ac1820 -> ac(18:20))
            numbers.length >= 4 && numbers.length % 2 === 0 ? 
                `${classPrefix}${numbers.slice(0, numbers.length/2)}:${numbers.slice(numbers.length/2)}` : null,
            
            // Pattern 3: try 2-digit splits for longer numbers (tg4801 -> tg(48:01))
            numbers.length >= 4 ? `${classPrefix}${numbers.slice(0, 2)}:${numbers.slice(2)}` : null,
            
            // Pattern 4: try 3-digit splits (tg48016 -> tg(480:16))
            numbers.length >= 5 ? `${classPrefix}${numbers.slice(0, 3)}:${numbers.slice(3)}` : null
        ].filter(Boolean);
        
        // Check if any pattern matches the clean lipid name
        return patterns.some(pattern => cleanLipid.includes(pattern));
    }
    
    // Try numeric-only search (e.g., "120" matches any lipid with "12:0")
    if (/^\d+$/.test(cleanSearch) && cleanSearch.length >= 2) {
        const numbers = cleanSearch;
        const numericPatterns = [
            // Split last digit: "120" -> "12:0"
            numbers.length >= 2 ? `${numbers.slice(0, -1)}:${numbers.slice(-1)}` : null,
            
            // Split in half: "1820" -> "18:20" 
            numbers.length >= 4 && numbers.length % 2 === 0 ? 
                `${numbers.slice(0, numbers.length/2)}:${numbers.slice(numbers.length/2)}` : null
        ].filter(Boolean);
        
        return numericPatterns.some(pattern => cleanLipid.includes(pattern));
    }
    
    return false;
}

function toggleDetails(lipidId) {
    const detailsPanel = document.getElementById(`details-${lipidId}`);
    const row = document.querySelector(`[data-lipid-id="${lipidId}"]`);
    
    // Close any currently open details
    if (currentDetailLipid && currentDetailLipid !== lipidId) {
        closeDetails(currentDetailLipid);
    }
    
    if (detailsPanel.classList.contains('active')) {
        closeDetails(lipidId);
    } else {
        detailsPanel.classList.add('active');
        row.classList.add('selected');
        currentDetailLipid = lipidId;
        
        // Load detailed data
        loadLipidDetails(lipidId);
    }
}

function closeDetails(lipidId) {
    const detailsPanel = document.getElementById(`details-${lipidId}`);
    const row = document.querySelector(`[data-lipid-id="${lipidId}"]`);
    
    detailsPanel.classList.remove('active');
    row.classList.remove('selected');
    
    if (currentDetailLipid === lipidId) {
        currentDetailLipid = null;
    }
}

async function loadLipidDetails(lipidId) {
    try {
        // Load annotated ions
        const ionsResponse = await fetch(`/api/lipid-ions/${lipidId}`);
        const ionsData = await ionsResponse.json();
        
        if (ionsData.status === 'success') {
            displayAnnotatedIons(lipidId, ionsData.ions);
        }
        
        // Load XIC data summary
        const xicResponse = await fetch(`/api/lipid-xic-summary/${lipidId}`);
        const xicData = await xicResponse.json();
        
        if (xicData.status === 'success') {
            displayXICData(lipidId, xicData.xic_summary);
        }
        
    } catch (error) {
        console.error('Error loading lipid details:', error);
    }
}

function displayAnnotatedIons(lipidId, ions) {
    const container = document.getElementById(`ions-container-${lipidId}`);
    
    if (ions.length === 0) {
        container.innerHTML = '<p class="text-muted">No annotated ions found.</p>';
        return;
    }
    
    let html = '<div class="row">';
    
    ions.forEach(ion => {
        html += `
            <div class="col-md-6 mb-2">
                <div class="ion-card ${ion.is_main_lipid ? 'main-ion' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${ion.ion_lipid_name}</strong>
                            ${ion.is_main_lipid ? '<span class="badge bg-success ms-2">Main</span>' : ''}
                            <br>
                            <small class="text-muted">${ion.annotation_type || 'Default'}</small>
                        </div>
                        <div class="text-end">
                            <small>RT: ${ion.retention_time ? parseFloat(ion.retention_time).toFixed(2) + ' min' : 'N/A'}</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small>
                            <strong>MS/MS:</strong> ${ion.precursor_ion || 'N/A'} ‚Üí ${ion.product_ion || 'N/A'}<br>
                            <strong>Code:</strong> ${ion.ion_lipidcode || 'N/A'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayXICData(lipidId, xicSummary) {
    const container = document.getElementById(`xic-preview-${lipidId}`);
    
    if (!xicSummary) {
        container.innerHTML = '<span class="text-muted">No XIC data available</span>';
        return;
    }
    
    container.innerHTML = JSON.stringify(xicSummary, null, 2);
}

function generateChart(lipidId) {
    // Open dual chart view in new tab using the new dual chart system
    window.open(`/dual-chart-view?lipids=${lipidId}`, '_blank');
}

// Refresh functionality
document.getElementById('refresh-btn').addEventListener('click', function() {
    location.reload();
});

// Export functionality
document.getElementById('export-btn').addEventListener('click', function() {
    // Get visible lipids
    const visibleRows = Array.from(document.querySelectorAll('.lipid-row')).filter(row => row.style.display !== 'none');
    const lipidIds = visibleRows.map(row => row.dataset.lipidId);
    
    if (lipidIds.length === 0) {
        alert('No lipids to export');
        return;
    }
    
    // Export as CSV
    window.open(`/api/export-data/csv?lipids=${lipidIds.join(',')}`, '_blank');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentDetailLipid) {
        closeDetails(currentDetailLipid);
    }
});
</script>
{% endblock %}