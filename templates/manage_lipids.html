{% extends "base.html" %}

{% block title %}Lipid Database Management - Metabolomics Platform{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title mb-1">ðŸ§¬ Lipid Database Management</h1>
            <p class="text-muted mb-0">Comprehensive lipid chromatography data overview and management</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportData()">
                <i class="fas fa-download"></i> Export Data
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Professional Management Interface Styles */
    .management-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .management-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        padding: 20px 25px;
        border-bottom: 3px solid var(--primary-orange);
    }
    
    .stats-overview {
        background: #f8f9fa;
        padding: 15px 25px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #495057;
    }
    
    .stat-value {
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 16px;
    }
    
    .search-controls {
        padding: 20px 25px;
        background: white;
        border-bottom: 1px solid #dee2e6;
    }
    
    .search-row {
        display: grid;
        grid-template-columns: 1fr 200px 150px 120px;
        gap: 15px;
        align-items: end;
    }
    
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem rgba(46, 76, 146, 0.15);
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 70vh;
    }
    
    .lipids-table {
        margin: 0;
        font-size: 13px;
    }
    
    .lipids-table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid var(--primary-blue);
        color: var(--primary-blue);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        padding: 12px 10px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .lipids-table tbody tr {
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
    }
    
    .lipids-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .lipids-table td {
        padding: 12px 10px;
        vertical-align: middle;
        border-top: none;
    }
    
    .lipid-name {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: #2c3e50;
        font-size: 13px;
    }
    
    .class-badge {
        background: var(--primary-blue);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .api-code {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 11px;
        color: #6c757d;
        border: 1px solid #e9ecef;
    }
    
    .retention-time {
        font-weight: 600;
        color: var(--primary-blue);
    }
    
    .ms-data {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        color: #6c757d;
        line-height: 1.3;
    }
    
    .ms-arrow {
        color: var(--primary-orange);
        font-weight: bold;
        margin: 0 2px;
    }
    
    .ion-count {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .ion-badge {
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .ion-badge.multiple {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .ion-badge.single {
        background: #cce7f0;
        color: #004085;
        border: 1px solid #a7d4ea;
    }
    
    .ion-badge.none {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-failed {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .peak-intensity {
        font-weight: 600;
        color: var(--primary-orange);
    }
    
    .polarity-indicator {
        font-size: 10px;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .polarity-positive {
        background: #e7f3ff;
        color: #0066cc;
    }
    
    .polarity-negative {
        background: #fff2e7;
        color: #cc6600;
    }
    
    .energy-value {
        font-size: 11px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .internal-standard {
        font-size: 10px;
        background: #fff3cd;
        color: #856404;
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid #ffeaa7;
    }
    
    .no-data {
        color: #adb5bd;
        font-style: italic;
        font-size: 11px;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
        .search-row {
            grid-template-columns: 1fr 180px 130px 100px;
            gap: 10px;
        }
    }
    
    @media (max-width: 768px) {
        .search-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .stats-overview {
            flex-direction: column;
            align-items: stretch;
        }
        
        .table-container {
            max-height: 60vh;
        }
    }
    
    /* Loading and Empty States */
    .loading-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #adb5bd;
    }
    
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-blue);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Management Container -->
    <div class="management-container">
        <!-- Header -->
        <div class="management-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">Database Overview</h4>
                    <p class="mb-0 opacity-75">Complete lipid chromatography database with mass spectrometry data</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-white">
                        <i class="fas fa-database fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Overview -->
        <div class="stats-overview">
            <div class="stat-item">
                <i class="fas fa-flask text-primary"></i>
                <span>Total Lipids:</span>
                <span class="stat-value">{{ data.total_count or 0 }}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-check-circle text-success"></i>
                <span>Successful Extractions:</span>
                <span class="stat-value">{{ data.stats.successful_extractions or 0 }}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-tags text-info"></i>
                <span>Lipid Classes:</span>
                <span class="stat-value">{{ data.classes|length or 0 }}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-atom text-warning"></i>
                <span>Annotated Ions:</span>
                <span class="stat-value">{{ data.stats.total_annotated_ions or 0 }}</span>
            </div>
        </div>
        
        <!-- Search and Filter Controls -->
        <div class="search-controls">
            <div class="search-row">
                <div>
                    <label class="form-label">Search Lipids</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by name, API code, or properties...">
                </div>
                <div>
                    <label class="form-label">Lipid Class</label>
                    <select class="form-select" id="classFilter">
                        <option value="">All Classes</option>
                        {% for class_item in data.classes %}
                        <option value="{{ class_item.class_name }}">{{ class_item.class_name }} ({{ class_item.count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Actions</label>
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Professional Data Table -->
        <div class="table-container">
            <table class="table lipids-table" id="lipidsTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 200px;">Lipid Name</th>
                        <th style="width: 80px;">Class</th>
                        <th style="width: 120px;">API Code</th>
                        <th style="width: 90px;">RT (min)</th>
                        <th style="width: 140px;">MS/MS Transition</th>
                        <th style="width: 80px;">Polarity</th>
                        <th style="width: 70px;">CE (V)</th>
                        <th style="width: 90px;">Ion Count</th>
                        <th style="width: 100px;">Peak Intensity</th>
                        <th style="width: 80px;">Int. Std.</th>
                        <th style="width: 80px;">Status</th>
                    </tr>
                </thead>
                <tbody id="lipidsTableBody">
                    {% for lipid in data.lipids %}
                    <tr data-lipid-id="{{ lipid.lipid_id }}" 
                        data-class="{{ lipid.class_name | lower }}" 
                        data-name="{{ lipid.lipid_name | lower }}"
                        data-api="{{ lipid.api_code | lower }}"
                        data-status="{{ 'success' if lipid.extraction_success else 'failed' }}">
                        
                        <!-- ID -->
                        <td>
                            <span class="text-muted">#{{ lipid.lipid_id }}</span>
                        </td>
                        
                        <!-- Lipid Name -->
                        <td>
                            <div class="lipid-name">{{ lipid.lipid_name }}</div>
                        </td>
                        
                        <!-- Class -->
                        <td>
                            <span class="class-badge">{{ lipid.class_name or 'Unknown' }}</span>
                        </td>
                        
                        <!-- API Code -->
                        <td>
                            {% if lipid.api_code %}
                                <span class="api-code">{{ lipid.api_code }}</span>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- Retention Time -->
                        <td>
                            {% if lipid.retention_time %}
                                <span class="retention-time">{{ "%.2f"|format(lipid.retention_time) }}</span>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- MS/MS Transition -->
                        <td>
                            {% if lipid.precursor_ion and lipid.product_ion %}
                                <div class="ms-data">
                                    {{ lipid.precursor_ion }}<span class="ms-arrow">â†’</span>{{ lipid.product_ion }}
                                </div>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- Polarity -->
                        <td>
                            {% if lipid.polarity %}
                                <span class="polarity-indicator {% if lipid.polarity == 'Positive' %}polarity-positive{% else %}polarity-negative{% endif %}">
                                    {{ lipid.polarity }}
                                </span>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- Collision Energy -->
                        <td>
                            {% if lipid.collision_energy %}
                                <span class="energy-value">{{ lipid.collision_energy }}V</span>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- Ion Count -->
                        <td>
                            <div class="ion-count">
                                {% set ion_count = lipid.annotated_ions_count or 0 %}
                                {% if ion_count > 1 %}
                                    <span class="ion-badge multiple">{{ ion_count }} ions</span>
                                {% elif ion_count == 1 %}
                                    <span class="ion-badge single">1 ion</span>
                                {% else %}
                                    <span class="ion-badge none">0 ions</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Peak Intensity -->
                        <td>
                            {% if lipid.xic_peak_intensity %}
                                <span class="peak-intensity">{{ "%.0f"|format(lipid.xic_peak_intensity) }}</span>
                            {% else %}
                                <span class="no-data">N/A</span>
                            {% endif %}
                        </td>
                        
                        <!-- Internal Standard -->
                        <td>
                            {% if lipid.internal_standard %}
                                <span class="internal-standard">IS</span>
                            {% else %}
                                <span class="no-data">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Status -->
                        <td>
                            {% if lipid.extraction_success %}
                                <span class="status-badge status-success">Success</span>
                            {% else %}
                                <span class="status-badge status-failed">Failed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% if not data.lipids %}
                    <tr>
                        <td colspan="12" class="empty-state">
                            <i class="fas fa-search fa-2x mb-3"></i>
                            <h5>No lipids found</h5>
                            <p class="text-muted">No lipid data available in the database.</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Professional Lipid Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const classFilter = document.getElementById('classFilter');
    const statusFilter = document.getElementById('statusFilter');
    const tableBody = document.getElementById('lipidsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr[data-lipid-id]'));
    
    let currentFilters = {
        search: '',
        class: '',
        status: ''
    };
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        currentFilters.search = this.value.toLowerCase();
        applyFilters();
    });
    
    // Class filter
    classFilter.addEventListener('change', function() {
        currentFilters.class = this.value.toLowerCase();
        applyFilters();
    });
    
    // Status filter
    statusFilter.addEventListener('change', function() {
        currentFilters.status = this.value;
        applyFilters();
    });
    
    function applyFilters() {
        let visibleCount = 0;
        
        rows.forEach(row => {
            const lipidName = row.dataset.name || '';
            const apiCode = row.dataset.api || '';
            const className = row.dataset.class || '';
            const status = row.dataset.status || '';
            
            const matchesSearch = !currentFilters.search || 
                                 lipidName.includes(currentFilters.search) ||
                                 apiCode.includes(currentFilters.search);
            
            const matchesClass = !currentFilters.class || className === currentFilters.class;
            const matchesStatus = !currentFilters.status || status === currentFilters.status;
            
            if (matchesSearch && matchesClass && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update visible count
        updateResultsCount(visibleCount);
    }
    
    function updateResultsCount(count) {
        // You can add a results counter if needed
        console.log(`Showing ${count} of ${rows.length} lipids`);
    }
    
    // Clear filters function
    window.clearFilters = function() {
        searchInput.value = '';
        classFilter.value = '';
        statusFilter.value = '';
        currentFilters = { search: '', class: '', status: '' };
        applyFilters();
    };
    
    // Export data function
    window.exportData = function() {
        // Implement export functionality
        alert('Export functionality would be implemented here');
    };
    
    // Refresh data function
    window.refreshData = function() {
        location.reload();
    };
});
</script>
{% endblock %}