{% extends "base.html" %}

{% block title %}Lipid Selection - Database Analysis{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        padding: 40px 0;
        background: var(--phenikaa-light);
        border-radius: var(--dl-layout-radius-cardradius);
        margin-bottom: 30px;
    }
    
    .page-header h1 {
        color: var(--phenikaa-text-blue);
        font-family: Inter;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .page-header p {
        color: var(--phenikaa-dark);
        font-family: Inter;
        font-size: 16px;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    .lipid-selector {
        background: var(--phenikaa-white);
        border-radius: var(--dl-layout-radius-cardradius);
        padding: var(--dl-layout-space-twounits);
        margin: var(--dl-layout-space-unit) 0;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--phenikaa-orange);
    }
    
    .class-filter-bar {
        background: var(--phenikaa-light);
        border-radius: var(--dl-layout-radius-cardradius);
        padding: var(--dl-layout-space-twounits);
        margin-bottom: var(--dl-layout-space-unit);
        border: 1px solid #e9ecef;
    }
    
    /* Search and Database Section */
    .search-and-database-section {
        margin-bottom: 25px;
        padding: 20px;
        background: var(--phenikaa-white);
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .btn-database {
        border: 2px solid var(--phenikaa-blue);
        color: var(--phenikaa-blue);
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .btn-database:hover {
        background: var(--phenikaa-blue);
        color: var(--phenikaa-white);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(46, 76, 146, 0.3);
    }
    
    /* Professional Class Filter Section */
    .class-filter-section {
        background: var(--phenikaa-white);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .class-filter-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .class-filter-header h6 {
        color: var(--phenikaa-blue);
        font-weight: 600;
        margin: 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .class-filter-header i {
        color: var(--phenikaa-orange);
        font-size: 14px;
    }
    
    /* Class Pills Container */
    .class-pills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }
    
    .class-pill {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        min-height: 36px;
    }
    
    .class-pill:hover {
        border-color: var(--phenikaa-orange);
        background: rgba(233, 75, 0, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(233, 75, 0, 0.15);
    }
    
    .class-pill.active {
        background: var(--phenikaa-blue);
        border-color: var(--phenikaa-blue);
        color: var(--phenikaa-white);
        box-shadow: 0 3px 12px rgba(46, 76, 146, 0.3);
    }
    
    .class-pill-content {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .class-label {
        font-family: Inter;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .class-count-badge {
        background: var(--phenikaa-orange);
        color: var(--phenikaa-white);
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
    }
    
    .class-pill.active .class-count-badge {
        background: var(--phenikaa-white);
        color: var(--phenikaa-blue);
    }
    
    
    .lipid-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
        margin-top: 20px;
    }
    
    .lipid-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 8px 10px;
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
        height: 40px;
        display: flex;
        align-items: center;
    }
    
    .lipid-card:hover {
        border-color: #007bff;
        background: #f8f9fa;
    }
    
    .lipid-card.selected {
        border-color: var(--phenikaa-orange);
        background: rgba(233, 75, 0, 0.1);
    }
    
    .lipid-card .selection-checkbox {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 12px;
        height: 12px;
        border: 1px solid #007bff;
        border-radius: 2px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        color: #007bff;
        font-weight: bold;
    }
    
    .lipid-card.selected .selection-checkbox {
        background: #007bff;
        color: white;
    }
    
    .lipid-name {
        font-family: 'Courier New', monospace;
        font-weight: 500;
        font-size: 13px;
        color: #2c3e50;
        margin: 0;
        padding-right: 18px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .lipid-class-badge {
        background: var(--phenikaa-blue);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 500;
        margin-left: 8px;
    }
    
    .lipid-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
        font-size: 11px;
    }
    
    .selected-lipids-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #FFFFFF !important;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25) !important;
        max-width: 400px;
        min-width: 350px;
        z-index: 9999 !important;
        border: 3px solid #E94B00 !important;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.4s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    .selected-lipids-panel.visible {
        transform: translateY(0);
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Ensure panel content is always visible */
    .selected-lipids-panel * {
        position: relative !important;
        z-index: 10000 !important;
    }
    
    .class-filter-btn {
        border: 2px solid #e9ecef;
        background: var(--phenikaa-white);
        color: var(--phenikaa-dark);
        padding: 8px 15px;
        border-radius: 20px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
        font-family: Inter;
    }
    
    .class-filter-btn:hover {
        border-color: var(--phenikaa-orange);
        color: var(--phenikaa-orange);
    }
    
    .class-filter-btn.active {
        background: var(--phenikaa-orange);
        color: var(--phenikaa-white);
        border-color: var(--phenikaa-orange);
    }
    
    .stats-strip {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 0;
        margin-bottom: 30px;
        border-radius: 10px;
    }
    
    .search-bar {
        max-width: 400px;
        margin: 0 auto 20px auto;
    }
    
    .view-charts-btn {
        background: #E94B00 !important;
        border: 2px solid #E94B00 !important;
        color: #FFFFFF !important;
        padding: 15px 25px !important;
        border-radius: 10px !important;
        font-weight: 700 !important;
        font-size: 16px !important;
        font-family: Inter !important;
        width: 100% !important;
        margin-top: 15px !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        z-index: 10001 !important;
        cursor: pointer !important;
        opacity: 1 !important;
    }
    
    .view-charts-btn:hover {
        background: #BF4408 !important;
        border-color: #BF4408 !important;
        transform: translateY(-3px) !important;
        color: #FFFFFF !important;
        box-shadow: 0 6px 25px rgba(233, 75, 0, 0.5) !important;
    }
    
    .view-charts-btn:disabled {
        background: #6c757d !important;
        border-color: #6c757d !important;
        color: #FFFFFF !important;
        cursor: not-allowed !important;
        transform: none !important;
        box-shadow: none !important;
    }
    
    .clear-selection-btn {
        background: #dc3545 !important;
        border: none !important;
        color: white !important;
        padding: 8px 15px !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        margin-left: 10px !important;
        z-index: 10002 !important;
        position: relative !important;
    }
    
    /* Additional fixes to prevent panel from being covered */
    .selected-lipids-panel h6,
    .selected-lipids-panel button,
    .selected-lipids-panel div {
        z-index: 10000 !important;
        position: relative !important;
    }
    
    /* Ensure no other elements can cover the panel */
    body > * {
        max-z-index: 9998;
    }
    
    /* Force the panel to be on top of everything */
    .selected-lipids-panel {
        isolation: isolate;
    }
    
    /* Remove any potential blur or opacity issues */
    .selected-lipids-panel,
    .selected-lipids-panel * {
        filter: none !important;
        -webkit-filter: none !important;
        blur: none !important;
    }
    
    /* Professional Loading Indicator */
    .loading-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
        padding: 60px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        margin: 20px 0;
    }
    
    .loading-content {
        text-align: center;
        max-width: 400px;
    }
    
    .spinner-container {
        margin-bottom: 30px;
    }
    
    .metabolomics-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #e9ecef;
        border-top: 4px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-title {
        color: var(--primary-blue);
        font-family: Inter;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .loading-text {
        color: #6c757d;
        font-family: Inter;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 25px;
    }
    
    .loading-text i {
        color: var(--primary-orange);
        margin-right: 8px;
        width: 16px;
    }
    
    .loading-progress {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progress-bar {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, var(--primary-blue), var(--primary-orange));
        border-radius: 2px;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.7; transform: scaleX(0.8); }
        50% { opacity: 1; transform: scaleX(1); }
    }
    
    /* Clean lipid card content structure */
    .card-content {
        width: 100%;
    }
    
    .lipid-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        font-size: 11px;
    }
    
    .class-badge {
        background: var(--primary-blue);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 500;
    }
    
    .rt-info {
        color: #6c757d;
        font-size: 11px;
    }
    
    .ions-count {
        color: var(--primary-orange);
        font-size: 11px;
        font-weight: 500;
        text-align: center;
        margin-top: 5px;
    }
    
    /* Only show failed status when needed */
    .status-badge.failed {
        background: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 9px;
        font-weight: 500;
        margin-left: 5px;
    }
    
    /* Responsive Design for Pills */
    @media (max-width: 768px) {
        .search-and-database-section .row {
            flex-direction: column;
            gap: 15px;
        }
        
        .search-and-database-section .col-md-3 {
            text-align: center !important;
        }
        
        .btn-database {
            width: 100%;
            max-width: 200px;
        }
        
        .class-pills-container {
            justify-content: center;
        }
        
        .class-pill {
            font-size: 12px;
            padding: 6px 12px;
            min-height: 32px;
        }
        
        .class-label {
            font-size: 12px;
        }
        
        .class-count-badge {
            font-size: 10px;
            padding: 1px 4px;
        }
        
        .select-all-mini {
            width: 18px;
            height: 18px;
            font-size: 7px;
        }
    }
    
    @media (max-width: 576px) {
        .class-filter-section {
            padding: 15px;
        }
        
        .class-pills-container {
            gap: 6px;
        }
        
        .class-pill {
            font-size: 11px;
            padding: 4px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Lipid Selector -->
    <div class="lipid-selector">
        <h2 class="text-center mb-4">ðŸ§¬ Select Lipids for Analysis</h2>
        
        <!-- Enhanced Search Section -->
        <div class="search-and-database-section">
            <div class="search-bar">
                <input type="text" id="search-input" class="form-control form-control-lg" 
                       placeholder="ðŸ” Search lipids (e.g., ac120, tg480, pc341, or full names...)"
                       autocomplete="off">
                <div class="search-tips mt-2">
                    <small class="form-text text-muted">
                        ðŸ’¡ <strong>Quick tips:</strong> Type "ac120" for AC(12:0) â€¢ "tg480" for TG(48:0) â€¢ "180" for any 18:0 lipid
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Professional Class Filter -->
        <div class="class-filter-section">
            <div class="class-filter-header">
                <h6><i class="fas fa-filter"></i> Filter by Lipid Class</h6>
            </div>
            
            <!-- Class Pills Container -->
            <div class="class-pills-container" id="class-boxes">
                <!-- All Classes Pill -->
                <div class="class-pill active" data-class="all" onclick="selectClassBox(this, 'all')">
                    <div class="class-pill-content">
                        <span class="class-label">All Classes</span>
                        <span class="class-count-badge">{{ data.classes | sum(attribute='count') or 0 }}</span>
                    </div>
                </div>
                
                <!-- Individual Class Pills -->
                {% for cls in data.classes %}
                <div class="class-pill" data-class="{{ cls.class_name }}" onclick="selectClassBox(this, '{{ cls.class_name }}')">
                    <div class="class-pill-content">
                        <span class="class-label">{{ cls.class_name }}</span>
                        <span class="class-count-badge">{{ cls.count or 0 }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Professional Loading Indicator -->
        {% if data.lazy_loading %}
        <div id="loading-indicator" class="loading-indicator" style="display: flex;">
            <div class="loading-content">
                <div class="spinner-container">
                    <div class="metabolomics-spinner"></div>
                </div>
                <h4 class="loading-title">Loading Metabolomics Database</h4>
                <p class="loading-text">
                    <i class="fas fa-database"></i> Connecting to PostgreSQL...<br>
                    <i class="fas fa-flask"></i> Loading 800+ lipid compounds...<br>
                    <i class="fas fa-chart-line"></i> Preparing interactive analysis...
                </p>
                <div class="loading-progress">
                    <div class="progress-bar"></div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Lipid Grid -->
        <div id="lipid-grid" class="lipid-grid">
            {% if not data.lazy_loading %}
            {% for lipid in data.lipids %}
            <div class="lipid-card" 
                 data-lipid-id="{{ lipid.lipid_id }}" 
                 data-class="{{ lipid.class_name }}"
                 data-name="{{ lipid.lipid_name | lower }}"
                 onclick="toggleLipidSelection(this)">
                
                <div class="selection-checkbox"></div>
                <div class="lipid-name">{{ lipid.lipid_name }}</div>
                <span class="lipid-class-badge">{{ lipid.class_name }}</span>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        
        
        <!-- No Results Message -->
        <div id="no-results" class="text-center py-5" style="display: none;">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No lipids match your search criteria</h5>
            <p class="text-muted">Try adjusting your search or filter settings</p>
        </div>
    </div>

    <!-- Selected Lipids Panel (Fixed Position) -->
    <div id="selected-panel" class="selected-lipids-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0"><strong>Selected Lipids</strong></h6>
            <button class="clear-selection-btn btn btn-sm" onclick="clearAllSelections()">
                Clear All
            </button>
        </div>
        
        <div id="selected-list" class="mb-3">
            <!-- Selected lipids will be listed here -->
        </div>
        
        <button id="optimized-charts-btn" class="view-charts-btn btn btn-primary" 
                onclick="viewOptimizedCharts()" disabled>
            <i class="fas fa-chart-area me-2"></i>
            View Interactive Charts (<span id="btn-count">0</span>)
        </button>
    </div>
</div>

<!-- Database Table Modal -->
<div class="modal fade" id="databaseModal" tabindex="-1" aria-labelledby="databaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="databaseModalLabel">
                    <i class="fas fa-database"></i> Lipid Database Overview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Database table content will be loaded here -->
                <div id="modal-table-container">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading database table...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportDatabaseData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedLipids = new Set();
let allLipids = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if NOT using lazy loading
    {% if not data.lazy_loading %}
    // Store all lipid data for filtering
    document.querySelectorAll('.lipid-card').forEach(card => {
        allLipids.push({
            id: card.dataset.lipidId,
            name: card.dataset.name,
            class: card.dataset.class,
            element: card
        });
    });
    {% endif %}
    
    // Setup search functionality
    setupSearch();
    setupClassFilters();
    updateSelectedPanel();
});

function toggleLipidSelection(cardElement) {
    const lipidId = cardElement.dataset.lipidId;
    const lipidName = cardElement.querySelector('.lipid-name').textContent;
    
    if (selectedLipids.has(lipidId)) {
        // Deselect
        selectedLipids.delete(lipidId);
        cardElement.classList.remove('selected');
        cardElement.querySelector('.selection-checkbox').innerHTML = '';
    } else {
        // Select
        selectedLipids.add(lipidId);
        cardElement.classList.add('selected');
        cardElement.querySelector('.selection-checkbox').innerHTML = 'âœ“';
    }
    
    updateSelectedPanel();
    updateStats();
}

function updateSelectedPanel() {
    const panel = document.getElementById('selected-panel');
    const list = document.getElementById('selected-list');
    const optimizedBtn = document.getElementById('optimized-charts-btn');
    
    if (selectedLipids.size === 0) {
        panel.classList.remove('visible');
        optimizedBtn.disabled = true;
        return;
    }
    
    panel.classList.add('visible');
    optimizedBtn.disabled = false;
    
    // Build selected lipids list
    let listHTML = '';
    selectedLipids.forEach(lipidId => {
        const card = document.querySelector(`[data-lipid-id="${lipidId}"]`);
        const name = card.querySelector('.lipid-name').textContent;
        const className = card.dataset.class;
        
        listHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <div>
                    <div class="lipid-name" style="font-size: 12px;">${name}</div>
                    <small class="text-muted">${className}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deselectLipid('${lipidId}')"
                        style="padding: 2px 6px; font-size: 12px;">Ã—</button>
            </div>
        `;
    });
    
    list.innerHTML = listHTML;
    document.getElementById('btn-count').textContent = selectedLipids.size;
    document.getElementById('btn-count-2').textContent = selectedLipids.size;
}

function deselectLipid(lipidId) {
    const card = document.querySelector(`[data-lipid-id="${lipidId}"]`);
    if (card) {
        toggleLipidSelection(card);
    }
}

function clearAllSelections() {
    selectedLipids.forEach(lipidId => {
        const card = document.querySelector(`[data-lipid-id="${lipidId}"]`);
        if (card) {
            card.classList.remove('selected');
            card.querySelector('.selection-checkbox').innerHTML = '';
        }
    });
    
    selectedLipids.clear();
    updateSelectedPanel();
    updateStats();
}

function updateStats() {
    document.getElementById('selected-count').textContent = selectedLipids.size;
}

function setupSearch() {
    const searchInput = document.getElementById('search-input');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        filterLipids();
    });
}

function setupClassFilters() {
    // Initialize class boxes instead of dropdown
    initializeClassBoxes();
}

function initializeClassBoxes() {
    const classPills = document.querySelectorAll('.class-pill');
    classPills.forEach(pill => {
        pill.addEventListener('click', function(e) {
            const className = this.dataset.class;
            selectClassBox(this, className);
        });
    });
    
    console.log(`âœ… Initialized ${classPills.length} class filter pills`);
}

function selectClassBox(pillElement, className) {
    // Remove active class from all pills
    document.querySelectorAll('.class-pill').forEach(pill => {
        pill.classList.remove('active');
    });
    
    // Add active class to selected pill
    pillElement.classList.add('active');
    
    // Update global filter state
    window.selectedClass = className;
    
    console.log('Class filter changed to:', className);
    
    // Apply filtering
    filterLipids();
}


function filterLipids() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const selectedClass = window.selectedClass || 'all';
    
    let visibleCount = 0;
    
    // Get all lipid cards from DOM (works with both lazy and non-lazy loading)
    const lipidCards = document.querySelectorAll('.lipid-card');
    
    lipidCards.forEach(card => {
        let visible = true;
        
        const lipidName = card.dataset.name || card.querySelector('.lipid-name')?.textContent?.toLowerCase() || '';
        const lipidClass = card.dataset.class || '';
        
        // If there's a search term, ignore class filter and search across all classes
        if (searchTerm) {
            // Enhanced search filter with shorthand support - searches ALL classes
            if (lipidName.includes(searchTerm) || lipidClass.toLowerCase().includes(searchTerm)) {
                visible = true;
            }
            // Shorthand lipid code matching (new feature)
            else if (matchesShorthandCode(lipidName, searchTerm)) {
                visible = true;
            }
            else {
                visible = false;
            }
        } else {
            // Only apply class filter when there's no search term
            if (selectedClass !== 'all' && selectedClass !== '' && lipidClass !== selectedClass) {
                visible = false;
            }
        }
        
        if (visible) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    const noResults = document.getElementById('no-results');
    if (visibleCount === 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
    
    // Visual feedback: highlight "All Classes" pill when searching
    if (searchTerm) {
        // When searching, visually indicate we're searching all classes
        const allClassesPill = document.querySelector('.class-pill[data-class="all"]');
        if (allClassesPill && !allClassesPill.classList.contains('active')) {
            // Add subtle visual cue that we're searching across all classes
            allClassesPill.style.border = '2px dashed var(--phenikaa-orange)';
            allClassesPill.style.opacity = '0.7';
        }
    } else {
        // Reset visual state when not searching
        const allClassesPill = document.querySelector('.class-pill[data-class="all"]');
        if (allClassesPill) {
            allClassesPill.style.border = '';
            allClassesPill.style.opacity = '';
        }
    }
}

function matchesShorthandCode(lipidName, searchTerm) {
    /**
     * Enhanced shorthand matching for lipid codes
     * Examples:
     * - "ac120" matches "ac(12:0)"
     * - "tg480" matches "tg(48:0)" or "tg48_0"
     * - "pc341" matches "pc(34:1)"
     * - "180" matches any lipid with "18:0"
     */
    
    // Remove all special characters for comparison
    const cleanLipid = lipidName.replace(/[():\-\[\]\/\s_]/g, '').toLowerCase();
    const cleanSearch = searchTerm.replace(/[():\-\[\]\/\s_]/g, '').toLowerCase();
    
    // Direct clean match
    if (cleanLipid.includes(cleanSearch)) {
        return true;
    }
    
    // Try to parse shorthand patterns like "ac120" -> "ac12:0"
    const shorthandPattern = /^([a-z]+)(\d+)$/;
    const match = cleanSearch.match(shorthandPattern);
    
    if (match) {
        const [, classPrefix, numbers] = match;
        
        // Try different number splitting patterns
        const patterns = [
            // Pattern 1: last digit as second number (ac120 -> ac(12:0))
            numbers.length >= 2 ? `${classPrefix}${numbers.slice(0, -1)}:${numbers.slice(-1)}` : null,
            
            // Pattern 2: split in half (ac1820 -> ac(18:20))
            numbers.length >= 4 && numbers.length % 2 === 0 ? 
                `${classPrefix}${numbers.slice(0, numbers.length/2)}:${numbers.slice(numbers.length/2)}` : null,
            
            // Pattern 3: try 2-digit splits for longer numbers (tg4801 -> tg(48:01))
            numbers.length >= 4 ? `${classPrefix}${numbers.slice(0, 2)}:${numbers.slice(2)}` : null,
            
            // Pattern 4: try 3-digit splits (tg48016 -> tg(480:16))
            numbers.length >= 5 ? `${classPrefix}${numbers.slice(0, 3)}:${numbers.slice(3)}` : null
        ].filter(Boolean);
        
        // Check if any pattern matches the clean lipid name
        return patterns.some(pattern => cleanLipid.includes(pattern));
    }
    
    // Try numeric-only search (e.g., "120" matches any lipid with "12:0")
    if (/^\d+$/.test(cleanSearch) && cleanSearch.length >= 2) {
        const numbers = cleanSearch;
        const numericPatterns = [
            // Split last digit: "120" -> "12:0"
            numbers.length >= 2 ? `${numbers.slice(0, -1)}:${numbers.slice(-1)}` : null,
            
            // Split in half: "1820" -> "18:20" 
            numbers.length >= 4 && numbers.length % 2 === 0 ? 
                `${numbers.slice(0, numbers.length/2)}:${numbers.slice(numbers.length/2)}` : null
        ].filter(Boolean);
        
        return numericPatterns.some(pattern => cleanLipid.includes(pattern));
    }
    
    return false;
}

function viewSelectedCharts() {
    if (selectedLipids.size === 0) {
        alert('Please select at least one lipid to view charts.');
        return;
    }
    
    // Convert Set to Array for URL parameters
    const lipidIds = Array.from(selectedLipids);
    
    // Create URL with selected lipid IDs
    const url = `/multi-chart-view?lipids=${lipidIds.join(',')}`;
    
    // Open in new tab or same tab
    window.location.href = url;
}

function viewOptimizedCharts() {
    if (selectedLipids.size === 0) {
        alert('Please select at least one lipid to view charts.');
        return;
    }
    
    // Convert Set to Array for URL parameters
    const lipidIds = Array.from(selectedLipids);
    
    // Create URL with selected lipid IDs for dual chart view
    const url = `/dual-chart-view?lipids=${lipidIds.join(',')}`;
    
    // Open in new tab
    window.open(url, '_blank');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + A to select all visible
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        selectAllVisible();
    }
    
    // Escape to clear all selections
    if (e.key === 'Escape') {
        clearAllSelections();
    }
});

function selectAllVisible() {
    document.querySelectorAll('.lipid-card').forEach(card => {
        if (card.style.display !== 'none' && !card.classList.contains('selected')) {
            toggleLipidSelection(card);
        }
    });
}

// Lazy Loading System for Instant Page Load
document.addEventListener('DOMContentLoaded', function() {
    {% if data.lazy_loading %}
    // Show loading indicator and load lipids asynchronously
    loadLipidsAsync();
    {% endif %}
});

function loadLipidsAsync() {
    const lipidGrid = document.querySelector('.lipid-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    // Show professional loading indicator
    if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
    }
    
    // Disable filter controls while loading
    const searchInput = document.querySelector('#search-input');
    const classFilters = document.querySelectorAll('.class-filter');
    if (searchInput) searchInput.disabled = true;
    classFilters.forEach(filter => filter.disabled = true);
    
    console.log('ðŸš€ Loading lipids asynchronously...');
    
    fetch('/api/load-lipids')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(`âœ… Loaded ${data.count} lipids in ${data.query_time}`);
                
                // Populate lipid grid
                populateLipidGrid(data.lipids);
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // Re-enable controls
                if (searchInput) searchInput.disabled = false;
                classFilters.forEach(filter => filter.disabled = false);
                
                // Initialize all lipids for filtering
                initializeLipidsData(data.lipids);
                
                console.log('ðŸŽ‰ Dashboard ready for interaction');
                
            } else {
                console.error('âŒ Failed to load lipids:', data.message);
                showErrorMessage('Failed to load lipids: ' + data.message);
            }
        })
        .catch(error => {
            console.error('âŒ Network error loading lipids:', error);
            showErrorMessage('Network error loading lipids. Please refresh the page.');
        });
}

function populateLipidGrid(lipids) {
    const lipidGrid = document.querySelector('.lipid-grid');
    if (!lipidGrid) return;
    
    // Clear existing placeholder content
    lipidGrid.innerHTML = '';
    
    // Add each lipid card
    lipids.forEach(lipid => {
        const card = createLipidCard(lipid);
        lipidGrid.appendChild(card);
    });
}

function createLipidCard(lipid) {
    const card = document.createElement('div');
    card.className = 'lipid-card';
    card.setAttribute('data-lipid-id', lipid.lipid_id);
    card.setAttribute('data-class', lipid.class_name);
    card.setAttribute('data-name', lipid.lipid_name.toLowerCase());
    card.onclick = () => toggleLipidSelection(card);
    
    // Only show failed status if needed, otherwise clean interface
    const statusIndicator = !lipid.extraction_success ? 
        '<span class="status-badge failed">âœ— Failed</span>' : '';
    
    card.innerHTML = `
        <div class="selection-checkbox"></div>
        <div class="lipid-name">${lipid.lipid_name}</div>
        <span class="lipid-class-badge">${lipid.class_name}</span>
    `;
    
    return card;
}

function initializeLipidsData(lipids) {
    // Store lipids data globally for filtering
    allLipids = lipids.map(lipid => ({
        id: lipid.lipid_id,
        name: lipid.lipid_name.toLowerCase(),
        class: lipid.class_name,
        element: document.querySelector(`[data-lipid-id="${lipid.lipid_id}"]`)
    }));
    
    console.log(`âœ… Initialized ${allLipids.length} lipids for filtering`);
}

function showErrorMessage(message) {
    const lipidGrid = document.querySelector('.lipid-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    
    if (lipidGrid) {
        lipidGrid.innerHTML = `
            <div class="error-message" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i><br>
                <strong>Error Loading Data</strong><br>
                ${message}
                <br><br>
                <button onclick="location.reload()" class="btn btn-phenikaa">
                    <i class="fas fa-refresh"></i> Reload Page
                </button>
            </div>
        `;
    }
}

// Database Modal Functions
function openDatabaseModal() {
    const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
    modal.show();
    
    // Load database table content
    loadDatabaseTable();
}

function loadDatabaseTable() {
    const container = document.getElementById('modal-table-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading database table...</p>
        </div>
    `;
    
    // Fetch database content from the public API
    fetch('/api/database-view')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Build table HTML
                const tableHTML = buildDatabaseTable(data);
                container.innerHTML = tableHTML;
                
                // Initialize search functionality
                initializeModalTableSearch();
            } else {
                container.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading database table:', error);
            container.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading database table: ${error.message}
                </div>
            `;
        });
}

function buildDatabaseTable(data) {
    const stats = data.stats;
    const lipids = data.lipids;
    const classes = data.classes;
    
    const classOptions = classes.map(cls => 
        `<option value="${cls.class_name}">${cls.class_name} (${cls.count})</option>`
    ).join('');
    
    const lipidRows = lipids.map(lipid => `
        <tr data-lipid-id="${lipid.lipid_id}" data-name="${lipid.lipid_name.toLowerCase()}" 
            data-class="${lipid.class_name}" data-api="${lipid.api_code}" data-status="success">
            <td>${lipid.lipid_id}</td>
            <td class="lipid-name">${lipid.lipid_name}</td>
            <td>${lipid.api_code || 'N/A'}</td>
            <td><span class="badge bg-primary">${lipid.class_name}</span></td>
            <td>${lipid.retention_time ? parseFloat(lipid.retention_time).toFixed(2) + ' min' : 'N/A'}</td>
            <td>${lipid.precursor_ion || 'N/A'}</td>
            <td>${lipid.product_ion || 'N/A'}</td>
            <td><span class="badge bg-success">âœ“ Success</span></td>
        </tr>
    `).join('');
    
    return `
        <div class="management-container p-3">
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6>Total Lipids</h6>
                            <h3>${data.total_count}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6>Classes</h6>
                            <h3>${classes.length}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h6>Success Rate</h6>
                            <h3>100%</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search lipids...">
                </div>
                <div class="col-md-4">
                    <select id="classFilter" class="form-control">
                        <option value="">All Classes</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-4">
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                    </select>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Lipid Name</th>
                            <th>API Code</th>
                            <th>Class</th>
                            <th>Retention Time</th>
                            <th>Precursor Ion</th>
                            <th>Product Ion</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lipidRows}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function initializeModalTableSearch() {
    // Reinitialize the search functionality for the modal table
    const searchInput = document.querySelector('#databaseModal #searchInput');
    const classFilter = document.querySelector('#databaseModal #classFilter');
    const statusFilter = document.querySelector('#databaseModal #statusFilter');
    
    if (searchInput && classFilter && statusFilter) {
        const tableRows = Array.from(document.querySelectorAll('#databaseModal tbody tr[data-lipid-id]'));
        
        function applyModalFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedClass = classFilter.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            
            let visibleCount = 0;
            
            tableRows.forEach(row => {
                const lipidName = row.dataset.name || '';
                const apiCode = row.dataset.api || '';
                const className = row.dataset.class || '';
                const status = row.dataset.status || '';
                
                const matchesSearch = !searchTerm || 
                                     lipidName.includes(searchTerm) ||
                                     apiCode.includes(searchTerm);
                
                const matchesClass = !selectedClass || className === selectedClass;
                const matchesStatus = !selectedStatus || status === selectedStatus;
                
                if (matchesSearch && matchesClass && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        searchInput.addEventListener('input', applyModalFilters);
        classFilter.addEventListener('change', applyModalFilters);
        statusFilter.addEventListener('change', applyModalFilters);
    }
}

function exportDatabaseData() {
    // Implement data export functionality
    alert('Export functionality would be implemented here');
}
</script>
{% endblock %}