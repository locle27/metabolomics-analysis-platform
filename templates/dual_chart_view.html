{% extends "base.html" %}

{% block title %}Interactive Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block body_class %}chart-analysis{% endblock %}

{% block hero %}
<div class="hero-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 text-center">
                <h1 class="hero-title">Interactive Dual Chart Analysis</h1>
                <p class="hero-subtitle">Advanced 2D Area-Based Hover Detection System</p>
                <div class="hero-stats">
                    <span class="stat-item">{{ selected_lipids|length }} Lipids Selected</span>
                    <span class="stat-separator">‚Ä¢</span>
                    <span class="stat-item">Professional Chart Analysis</span>
                    <span class="stat-separator">‚Ä¢</span>
                    <span class="stat-item">Real-time XIC Visualization</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Selected Lipids Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="lipids-summary-card">
                <h4 class="mb-3">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Selected Lipids for Analysis
                </h4>
                <div class="lipids-grid">
                    {% for lipid in selected_lipids %}
                    <div class="lipid-card" data-lipid-id="{{ lipid.lipid_id }}">
                        <div class="lipid-header">
                            <h5 class="lipid-name">{{ lipid.lipid_name }}</h5>
                            <span class="lipid-class">{{ lipid.class_name }}</span>
                        </div>
                        <div class="lipid-details">
                            <span class="retention-time">RT: {{ "%.2f"|format(lipid.retention_time) }} min</span>
                            <span class="annotations-count">{{ lipid.annotated_ions_count }} annotations</span>
                        </div>
                        <button class="btn btn-primary btn-sm view-charts-btn" 
                                onclick="loadChartsForLipid({{ lipid.lipid_id }})">
                            <i class="fas fa-chart-area me-1"></i>View Charts
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Display Area -->
    <div class="row">
        <div class="col-12">
            <div class="charts-container" id="charts-container" style="display: none;">
                <!-- Chart Navigation -->
                <div class="chart-navigation mb-3">
                    <h4 id="current-lipid-title">Loading Charts...</h4>
                    <div class="chart-controls">
                        <button class="btn btn-outline-secondary btn-sm" onclick="previousLipid()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="lipid-counter" class="mx-3">1 / {{ selected_lipids|length }}</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="nextLipid()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Dual Charts Layout -->
                <div class="dual-charts-layout">
                    <!-- Chart 1: Focused View -->
                    <div class="chart-panel">
                        <div class="chart-header">
                            <h5>
                                <i class="fas fa-search-plus text-primary me-2"></i>
                                Chart 1: Focused View (RT ¬± 0.6 min)
                            </h5>
                            <div class="chart-info">
                                <span class="chart-status" id="chart1-status">Click to activate zoom</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chart1" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Overview -->
                    <div class="chart-panel">
                        <div class="chart-header">
                            <h5>
                                <i class="fas fa-chart-line text-success me-2"></i>
                                Chart 2: Full Overview (0-16 min)
                            </h5>
                            <div class="chart-info">
                                <span class="chart-status" id="chart2-status">Click to activate zoom</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chart2" class="chart-canvas"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Professional Information Panel (300px width) -->
                <div class="info-panel-container">
                    <div class="info-panel" id="info-panel">
                        <div class="info-header">
                            <h6>
                                <i class="fas fa-info-circle text-info me-2"></i>
                                üìä Lipid Information Panel (300px width)
                            </h6>
                        </div>
                        <div class="info-content" id="info-content">
                            <p class="text-muted">Hover over colored integration areas to see detailed information...</p>
                        </div>
                    </div>
                </div>

                <!-- Shared Legend -->
                <div class="shared-legend">
                    <h6 class="legend-title">
                        <i class="fas fa-palette me-2"></i>
                        Annotation Legend
                    </h6>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #1f77b4;"></span>
                            <span class="legend-label">Current Lipid</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #2ed573;"></span>
                            <span class="legend-label">Similar MRM</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ff4757;"></span>
                            <span class="legend-label">+2 Isotope</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loading-indicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading charts...</span>
        </div>
        <p class="mt-2">Loading chart data...</p>
    </div>

    <!-- Error Display -->
    <div class="alert alert-danger" id="error-display" style="display: none;">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Chart Loading Error</h5>
        <p id="error-message">Failed to load chart data.</p>
        <button class="btn btn-outline-danger btn-sm" onclick="retryChartLoad()">
            <i class="fas fa-redo me-1"></i>Retry
        </button>
    </div>
</div>

<style>
/* Professional Chart Analysis Styles */
.hero-section {
    background: linear-gradient(135deg, #2E4C92 0%, #213671 100%);
    color: white;
    padding: 60px 0;
    margin-bottom: 0;
}

.hero-stats {
    margin-top: 20px;
}

.stat-item {
    font-size: 14px;
    font-weight: 500;
}

.stat-separator {
    margin: 0 15px;
    opacity: 0.7;
}

.lipids-summary-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.lipids-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.lipid-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.lipid-card:hover {
    border-color: #2E4C92;
    box-shadow: 0 4px 15px rgba(46, 76, 146, 0.2);
}

.lipid-card.active {
    border-color: #2E4C92;
    background: #f0f4ff;
}

.lipid-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
}

.lipid-name {
    font-size: 16px;
    font-weight: 600;
    color: #2E4C92;
    margin: 0;
}

.lipid-class {
    background: #2E4C92;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.lipid-details {
    display: flex;
    justify-content: between;
    margin-bottom: 15px;
    font-size: 14px;
    color: #666;
}

.charts-container {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.chart-navigation {
    display: flex;
    justify-content: between;
    align-items: center;
    padding-bottom: 20px;
    border-bottom: 2px solid #f8f9fa;
}

.dual-charts-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin: 30px 0;
}

.chart-panel {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
}

.chart-panel.active {
    border-color: #2E4C92;
}

.chart-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.chart-container {
    position: relative;
    height: 400px;
    background: white;
    border-radius: 8px;
    padding: 10px;
}

.chart-canvas {
    width: 100% !important;
    height: 100% !important;
    cursor: crosshair;
}

.chart-canvas.zoom-active {
    border: 2px solid #2E4C92;
    cursor: grab;
}

.chart-canvas.zoom-active:active {
    cursor: grabbing;
}

.info-panel-container {
    margin: 30px 0;
}

.info-panel {
    background: #f0f4ff;
    border: 2px solid #2E4C92;
    border-radius: 10px;
    padding: 20px;
    min-height: 120px;
    width: 300px; /* Fixed 300px width as requested */
    margin: 0 auto;
}

.info-header {
    border-bottom: 1px solid #d0d9ff;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.info-content {
    font-size: 14px;
    line-height: 1.6;
}

.shared-legend {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.legend-title {
    color: #2E4C92;
    margin-bottom: 15px;
    font-weight: 600;
}

.legend-items {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid #ccc;
}

.legend-label {
    font-size: 14px;
    color: #555;
    font-weight: 500;
}

.loading-indicator {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.chart-status {
    font-size: 12px;
    color: #666;
    font-weight: normal;
}

/* Responsive Design */
@media (max-width: 768px) {
    .dual-charts-layout {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .chart-navigation {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .legend-items {
        justify-content: center;
    }
    
    .info-panel {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js with Zoom Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// Global chart management
let chart1 = null;
let chart2 = null;
let currentLipidIndex = 0;
let selectedLipidIds = {{ selected_lipid_ids|tojson }};
let selectedLipids = {{ selected_lipids|tojson }};
let isLoadingCharts = false;
let currentChartData = null;

// Chart activation state
let chart1Active = false;
let chart2Active = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Dual Chart Analysis Page Loaded');
    console.log('üìä Selected Lipids:', selectedLipids.length);
    
    // Auto-load first lipid if available
    if (selectedLipids.length > 0) {
        loadChartsForLipid(selectedLipids[0].lipid_id);
    }
    
    // Add global click handler for chart deactivation
    document.addEventListener('click', function(event) {
        const clickedChart = event.target.closest('.chart-canvas');
        if (!clickedChart) {
            // Clicked outside charts - deactivate all
            deactivateAllCharts();
        }
    });
});

function loadChartsForLipid(lipidId) {
    if (isLoadingCharts) return;
    
    isLoadingCharts = true;
    showLoading();
    hideError();
    
    console.log(`üìà Loading charts for lipid ID: ${lipidId}`);
    
    // Update current lipid index
    currentLipidIndex = selectedLipids.findIndex(lipid => lipid.lipid_id === lipidId);
    updateNavigationDisplay();
    
    // Update active lipid card
    document.querySelectorAll('.lipid-card').forEach(card => {
        card.classList.remove('active');
        if (parseInt(card.dataset.lipidId) === lipidId) {
            card.classList.add('active');
        }
    });
    
    // Fetch chart data
    fetch(`/api/dual-chart-data/${lipidId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Chart data received:', data);
            currentChartData = data;
            initializeDualCharts(data);
            showCharts();
            isLoadingCharts = false;
        })
        .catch(error => {
            console.error('‚ùå Error loading chart data:', error);
            showError(`Failed to load chart data: ${error.message}`);
            isLoadingCharts = false;
        });
}

function initializeDualCharts(chartData) {
    console.log('üé® Initializing dual charts...');
    
    try {
        // Destroy existing charts
        if (chart1) {
            chart1.destroy();
            chart1 = null;
        }
        if (chart2) {
            chart2.destroy();
            chart2 = null;
        }
        
        // Create Chart 1 (Focused View)
        const chart1Config = createChartConfig(chartData.chart1, 'Chart 1: Focused View', 1);
        chart1 = createChart('chart1', chart1Config);
        console.log('‚úÖ Chart 1 initialized');
        
        // Create Chart 2 (Overview)
        const chart2Config = createChartConfig(chartData.chart2, 'Chart 2: Overview', 2);
        chart2 = createChart('chart2', chart2Config);
        console.log('‚úÖ Chart 2 initialized');
        
        // Update title
        const lipidInfo = chartData.lipid_info;
        document.getElementById('current-lipid-title').textContent = 
            `${lipidInfo.lipid_name} (${lipidInfo.class_name}) - RT: ${lipidInfo.retention_time.toFixed(2)} min`;
        
        console.log('üéØ Dual charts initialization complete');
        
    } catch (error) {
        console.error('‚ùå Error initializing charts:', error);
        showError(`Chart initialization failed: ${error.message}`);
    }
}

function createChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        throw new Error(`Canvas element ${canvasId} not found`);
    }
    
    const ctx = canvas.getContext('2d');
    
    // Ensure Chart.js is available
    if (typeof Chart === 'undefined') {
        throw new Error('Chart.js library not loaded');
    }
    
    // Check for zoom plugin
    if (!Chart.registry.plugins.get('zoom')) {
        console.warn('‚ö†Ô∏è Chart.js zoom plugin not available - zoom functionality disabled');
        // Remove zoom plugin from config
        if (config.plugins) {
            delete config.plugins.zoom;
        }
    }
    
    try {
        const chart = new Chart(ctx, config);
        
        // Add click handler for activation
        canvas.addEventListener('click', function(event) {
            event.stopPropagation();
            if (canvasId === 'chart1') {
                activateChart1();
            } else {
                activateChart2();
            }
        });
        
        // Add 2D area-based hover detection
        canvas.addEventListener('mousemove', function(event) {
            handle2DAreaHover(event, chart, canvasId === 'chart1' ? 1 : 2);
        });
        
        return chart;
    } catch (error) {
        console.error(`‚ùå Error creating chart ${canvasId}:`, error);
        throw error;
    }
}

function createChartConfig(chartData, title, chartNumber) {
    const config = {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 0, // Clean chart appearance - no dots
                    hoverRadius: 0
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    color: '#2E4C92'
                },
                legend: {
                    display: false  // We use shared legend
                },
                tooltip: {
                    enabled: false  // We use external info panel
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Retention Time (minutes)',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        stepSize: 1, // 1-minute intervals as requested
                        callback: function(value) {
                            return Math.floor(value); // Show 0,1,2,3... not 0,2,4,6...
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Intensity',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    // Compressed Y-axis: start close to minimum data value
                    beginAtZero: false,
                    grace: '2%' // Start at ~2% above lowest point
                }
            },
            onHover: function(event, elements) {
                // Standard Chart.js hover handling
                if (elements.length === 0) {
                    updateInfoPanel(null);
                }
            }
        }
    };
    
    // Add zoom plugin if available
    if (typeof Chart !== 'undefined' && Chart.registry && Chart.registry.plugins.get('zoom')) {
        config.plugins.zoom = {
            zoom: {
                wheel: {
                    enabled: false  // Disabled by default
                },
                pinch: {
                    enabled: false  // Disabled by default
                },
                drag: {
                    enabled: false  // Disabled by default
                }
            },
            pan: {
                enabled: false  // Disabled by default
            }
        };
    }
    
    return config;
}

// üöÄ REVOLUTIONARY 2D AREA-BASED HOVER DETECTION SYSTEM
function handle2DAreaHover(event, chart, chartNumber) {
    if (!currentChartData) return;
    
    const rect = event.target.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    // Convert pixel coordinates to data coordinates
    const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
    const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
    const dataY = chart.scales.y.getValueForPixel(canvasPosition.y);
    
    // Check if mouse is within any integration area
    const hoveredLipid = findHoveredIntegrationArea(dataX, dataY, chartNumber);
    
    if (hoveredLipid) {
        updateInfoPanel(hoveredLipid);
        event.target.style.cursor = 'pointer';
    } else {
        updateInfoPanel(null);
        event.target.style.cursor = 'crosshair';
    }
}

function findHoveredIntegrationArea(mouseX, mouseY, chartNumber) {
    if (!currentChartData) return null;
    
    const chartKey = chartNumber === 1 ? 'chart1' : 'chart2';
    const chartData = currentChartData[chartKey];
    
    if (!chartData || !chartData.datasets) return null;
    
    let smallestArea = null;
    let smallestAreaSize = Infinity;
    
    // Check each dataset for integration areas
    chartData.datasets.forEach(dataset => {
        if (dataset.integration_area && dataset.integration_bounds) {
            const bounds = dataset.integration_bounds;
            const timeStart = bounds.time_start;
            const timeEnd = bounds.time_end;
            const intensityMax = bounds.intensity_max;
            
            // Check if mouse is within 2D rectangular area
            const inTimeRange = mouseX >= timeStart && mouseX <= timeEnd;
            const inIntensityRange = mouseY >= 0 && mouseY <= intensityMax;
            
            if (inTimeRange && inIntensityRange) {
                // Calculate area size (prefer smaller/more specific areas)
                const areaSize = (timeEnd - timeStart) * intensityMax;
                
                if (areaSize < smallestAreaSize) {
                    smallestAreaSize = areaSize;
                    smallestArea = {
                        name: dataset.lipid_name || dataset.label,
                        class: dataset.lipid_class || 'Unknown',
                        retentionTime: dataset.retention_time || ((timeStart + timeEnd) / 2).toFixed(2),
                        integrationStart: timeStart.toFixed(2),
                        integrationEnd: timeEnd.toFixed(2),
                        precursorMass: dataset.precursor_mass || 'N/A',
                        productMass: dataset.product_mass || 'N/A',
                        annotation: dataset.annotation_type || 'Current lipid',
                        color: dataset.borderColor || '#1f77b4'
                    };
                }
            }
        }
    });
    
    return smallestArea;
}

function updateInfoPanel(lipidData) {
    const infoContent = document.getElementById('info-content');
    
    if (!lipidData) {
        infoContent.innerHTML = '<p class="text-muted">Hover over colored integration areas to see detailed information...</p>';
        return;
    }
    
    // Display detailed lipid information with color-coded badge
    const badgeColor = lipidData.color;
    const annotationText = lipidData.annotation;
    
    // Determine annotation icon
    let annotationIcon = 'üìç';
    if (annotationText.includes('Current')) annotationIcon = 'üîµ';
    else if (annotationText.includes('Similar')) annotationIcon = 'üü¢';
    else if (annotationText.includes('isotope')) annotationIcon = 'üî¥';
    
    infoContent.innerHTML = `
        <div class="lipid-info-details">
            <h6 class="text-primary mb-2">
                ${annotationIcon} ${lipidData.name}
            </h6>
            <div class="info-grid">
                <div class="info-row">
                    <strong>Lipid name:</strong> ${lipidData.name}
                </div>
                <div class="info-row">
                    <strong>Lipid class:</strong> ${lipidData.class}
                </div>
                <div class="info-row">
                    <strong>Retention time:</strong> ${lipidData.retentionTime} minutes
                </div>
                <div class="info-row">
                    <strong>Integration start:</strong> ${lipidData.integrationStart} minutes
                </div>
                <div class="info-row">
                    <strong>Integration end:</strong> ${lipidData.integrationEnd} minutes
                </div>
                <div class="info-row">
                    <strong>Precursor mass:</strong> ${lipidData.precursorMass} m/z
                </div>
                <div class="info-row">
                    <strong>Product mass:</strong> ${lipidData.productMass} m/z
                </div>
                <div class="info-row">
                    <strong>Annotation:</strong> 
                    <span class="badge ms-1" style="background-color: ${badgeColor}; color: white; border: 1px solid #ccc;">
                        ${annotationIcon} ${annotationText.toUpperCase()}
                    </span>
                </div>
            </div>
        </div>
    `;
}

function activateChart1() {
    chart1Active = true;
    chart2Active = false;
    
    // Update visual state
    document.querySelector('#chart1').closest('.chart-panel').classList.add('active');
    document.querySelector('#chart2').closest('.chart-panel').classList.remove('active');
    
    // Update status
    document.getElementById('chart1-status').textContent = 'Zoom active - wheel to zoom, Shift+drag to pan';
    document.getElementById('chart2-status').textContent = 'Click to activate zoom';
    
    // Enable zoom on chart1 if plugin available
    if (chart1 && chart1.options.plugins && chart1.options.plugins.zoom) {
        chart1.options.plugins.zoom.zoom.wheel.enabled = true;
        chart1.options.plugins.zoom.zoom.pinch.enabled = true;
        chart1.options.plugins.zoom.pan.enabled = true;
        chart1.update('none');
    }
    
    // Disable zoom on chart2
    if (chart2 && chart2.options.plugins && chart2.options.plugins.zoom) {
        chart2.options.plugins.zoom.zoom.wheel.enabled = false;
        chart2.options.plugins.zoom.zoom.pinch.enabled = false;
        chart2.options.plugins.zoom.pan.enabled = false;
        chart2.update('none');
    }
    
    console.log('üéØ Chart 1 activated');
}

function activateChart2() {
    chart1Active = false;
    chart2Active = true;
    
    // Update visual state
    document.querySelector('#chart1').closest('.chart-panel').classList.remove('active');
    document.querySelector('#chart2').closest('.chart-panel').classList.add('active');
    
    // Update status
    document.getElementById('chart1-status').textContent = 'Click to activate zoom';
    document.getElementById('chart2-status').textContent = 'Zoom active - wheel to zoom, Shift+drag to pan';
    
    // Enable zoom on chart2 if plugin available
    if (chart2 && chart2.options.plugins && chart2.options.plugins.zoom) {
        chart2.options.plugins.zoom.zoom.wheel.enabled = true;
        chart2.options.plugins.zoom.zoom.pinch.enabled = true;
        chart2.options.plugins.zoom.pan.enabled = true;
        chart2.update('none');
    }
    
    // Disable zoom on chart1
    if (chart1 && chart1.options.plugins && chart1.options.plugins.zoom) {
        chart1.options.plugins.zoom.zoom.wheel.enabled = false;
        chart1.options.plugins.zoom.zoom.pinch.enabled = false;
        chart1.options.plugins.zoom.pan.enabled = false;
        chart1.update('none');
    }
    
    console.log('üéØ Chart 2 activated');
}

function deactivateAllCharts() {
    chart1Active = false;
    chart2Active = false;
    
    // Update visual state
    document.querySelectorAll('.chart-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Update status
    document.getElementById('chart1-status').textContent = 'Click to activate zoom';
    document.getElementById('chart2-status').textContent = 'Click to activate zoom';
    
    // Disable zoom on both charts
    [chart1, chart2].forEach(chart => {
        if (chart && chart.options.plugins && chart.options.plugins.zoom) {
            chart.options.plugins.zoom.zoom.wheel.enabled = false;
            chart.options.plugins.zoom.zoom.pinch.enabled = false;
            chart.options.plugins.zoom.pan.enabled = false;
            chart.update('none');
        }
    });
    
    console.log('üéØ All charts deactivated');
}

function nextLipid() {
    if (currentLipidIndex < selectedLipids.length - 1) {
        currentLipidIndex++;
        loadChartsForLipid(selectedLipids[currentLipidIndex].lipid_id);
    }
}

function previousLipid() {
    if (currentLipidIndex > 0) {
        currentLipidIndex--;
        loadChartsForLipid(selectedLipids[currentLipidIndex].lipid_id);
    }
}

function updateNavigationDisplay() {
    const counter = document.getElementById('lipid-counter');
    if (counter) {
        counter.textContent = `${currentLipidIndex + 1} / ${selectedLipids.length}`;
    }
}

function showLoading() {
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('charts-container').style.display = 'none';
}

function showCharts() {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('charts-container').style.display = 'block';
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-display').style.display = 'block';
    document.getElementById('loading-indicator').style.display = 'none';
}

function hideError() {
    document.getElementById('error-display').style.display = 'none';
}

function retryChartLoad() {
    if (selectedLipids.length > 0) {
        loadChartsForLipid(selectedLipids[currentLipidIndex].lipid_id);
    }
}

// Prevent page scroll when zooming charts
document.addEventListener('wheel', function(event) {
    if (chart1Active || chart2Active) {
        const chartElement = event.target.closest('.chart-canvas');
        if (chartElement) {
            event.preventDefault();
        }
    }
}, { passive: false });

// Double-click to reset zoom
document.addEventListener('dblclick', function(event) {
    const chartElement = event.target.closest('.chart-canvas');
    if (chartElement) {
        const chartId = chartElement.id;
        const chart = chartId === 'chart1' ? chart1 : chart2;
        
        if (chart && chart.resetZoom) {
            chart.resetZoom();
            console.log(`üîÑ ${chartId} zoom reset`);
        }
        
        // Deactivate after reset
        deactivateAllCharts();
    }
});

console.log('üìä COMPLETE Dual Chart Analysis Script Loaded Successfully');
console.log('üöÄ Features: 2D Area Hover Detection, Click-to-Zoom, Compressed Y-axis, External Info Panel');
</script>
{% endblock %}