{% extends "base.html" %}

{% block title %}Interactive Dual Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }
    
    .lipid-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
        text-align: center;
    }
    
    .lipid-title {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 18px;
        color: #2c3e50;
        margin: 0;
    }
    
    .lipid-info {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
    }
    
    .info-badge {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .info-toggle-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .info-toggle-btn-friendly {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        margin-left: 15px;
    }
    
    .info-toggle-btn-friendly:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
    }
    
    .info-toggle-btn-friendly i {
        margin-right: 8px;
    }
    
    .info-toggle-btn:hover {
        background: #218838;
    }
    
    .info-toggle-btn.active {
        background: #dc3545;
    }
    
    .info-toggle-btn.active:hover {
        background: #c82333;
    }
    
    /* Professional Zoom Controls Dropdown */
    .zoom-controls-btn {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 15px;
        box-shadow: 0 3px 12px rgba(0, 123, 255, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .zoom-controls-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4);
    }
    
    .zoom-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        border: 1px solid #e9ecef;
        min-width: 280px;
        z-index: 1000;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }
    
    .zoom-dropdown-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 13px;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .zoom-dropdown-item {
        width: 100%;
        background: none;
        border: none;
        padding: 12px 16px;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: #495057;
    }
    
    .zoom-dropdown-item:hover {
        background: #f8f9fa;
        color: #007bff;
    }
    
    .zoom-dropdown-item.reset {
        color: #dc3545;
    }
    
    .zoom-dropdown-item.reset:hover {
        background: #f8d7da;
        color: #721c24;
    }
    
    .zoom-dropdown-item.admin {
        color: #28a745;
        font-weight: 500;
    }
    
    .zoom-dropdown-item.admin:hover {
        background: #d4edda;
        color: #155724;
    }
    
    .zoom-dropdown-divider {
        height: 1px;
        background: #dee2e6;
        margin: 4px 0;
    }
    
    .zoom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .zoom-modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
    }
    
    .zoom-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .zoom-form h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        text-align: center;
    }
    
    .zoom-form label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .zoom-form input {
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
    }
    
    .zoom-form input:focus {
        border-color: #007bff;
        outline: none;
    }
    
    .zoom-form-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }
    
    .zoom-form-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
    }
    
    .btn-save:hover {
        background: #218838;
    }
    
    .btn-cancel {
        background: #6c757d;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #545b62;
    }
    
    .detailed-info-panel {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        display: none;
    }
    
    .info-section {
        margin-bottom: 20px;
    }
    
    .info-section:last-child {
        margin-bottom: 0;
    }
    
    .info-section h4 {
        color: #2c3e50;
        font-size: 16px;
        margin-bottom: 10px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .dual-charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    /* Shared legend container */
    .shared-legend {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .legend-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .legend-items {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }
    
    .legend-color {
        width: 16px;
        height: 3px;
        border-radius: 2px;
    }
    
    .legend-color.dashed {
        border: 1px dashed;
        background: none;
        height: 1px;
    }
    
    /* Remove custom tooltip styling - using external panel instead */
    
    .single-chart-container {
        position: relative;
        background: #fafafa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
    }
    
    .chart-canvas {
        position: relative;
        height: 300px;
        cursor: pointer;
    }
    
    .chart-lipid-name {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 4px 12px;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 12px;
        color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        pointer-events: none;
        border: 1px solid #e9ecef;
    }
    
    .chart-canvas canvas {
        transition: border 0.2s ease;
    }
    
    .chart-canvas canvas:hover {
        border: 1px solid #ccc !important;
    }
    
    .chart-title {
        display: none !important; /* Hide chart titles completely */
    }
    
    .loading-state {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        color: #666;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .error-state {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 6px;
        border: 1px solid #f5c6cb;
        text-align: center;
    }
    
    .annotated-ions-section {
        margin-top: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
    }
    
    .section-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .ions-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .ion-item {
        background: white;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        font-size: 12px;
    }
    
    .ion-name {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .ion-details {
        color: #666;
        margin-top: 4px;
    }
    
    .lipid-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .detail-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid #007bff;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-value {
        color: #2c3e50;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        font-weight: 500;
        background: #f8f9fa;
        padding: 2px 8px;
        border-radius: 4px;
    }
    
    .detail-value.highlight {
        background: #e3f2fd;
        color: #1976d2;
        font-weight: 600;
    }
    
    .back-button {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #f8f9fa;
        color: #495057;
        text-decoration: none;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        transition: all 0.2s ease;
    }
    
    .back-button:hover {
        background: #e9ecef;
        color: #495057;
        text-decoration: none;
    }
    
    .instructions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 13px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr !important;
        }
        
        .dual-charts-container {
            grid-template-columns: 1fr !important;
            gap: 10px;
        }
        
        .legend-items {
            justify-content: flex-start;
            gap: 15px;
        }
        
        .chart-canvas {
            height: 250px;
        }
    }
    
    @media (max-width: 768px) {
        .lipid-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .legend-items {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <a href="{{ url_for('clean_dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
    

    <!-- Charts for each selected lipid -->
    {% for lipid in selected_lipids %}
    <div class="chart-container" id="lipid-container-{{ lipid.lipid_id }}">
        <!-- Lipid Header -->
        <div class="lipid-header">
            <h2 class="lipid-title text-center">{{ lipid.lipid_name }}</h2>
            <div class="lipid-info justify-content-center">
                <span class="info-badge">{{ lipid.class_name }}</span>
                <span class="info-badge">ID: {{ lipid.lipid_id }}</span>
                <span class="info-badge">{{ lipid.annotated_ions_count }} Ions</span>
                <button class="info-toggle-btn-friendly" onclick="toggleDetailedInfo({{ lipid.lipid_id }})" id="toggle-btn-{{ lipid.lipid_id }}">
                    <i class="fas fa-info-circle"></i> View Details
                </button>
                
                <!-- Professional Zoom Controls Dropdown -->
                <div class="zoom-controls-dropdown" style="position: relative; display: inline-block;">
                    <button class="zoom-controls-btn" onclick="toggleZoomDropdown({{ lipid.lipid_id }})" id="zoom-dropdown-btn-{{ lipid.lipid_id }}">
                        <i class="fas fa-search-plus"></i> Zoom Controls <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="zoom-dropdown-menu" id="zoom-dropdown-{{ lipid.lipid_id }}" style="display: none;">
                        <div class="zoom-dropdown-header">
                            <i class="fas fa-chart-line"></i> Chart Zoom Settings
                        </div>
                        <button class="zoom-dropdown-item" onclick="showZoomSettings({{ lipid.lipid_id }}, 'chart1')">
                            <i class="fas fa-expand-arrows-alt"></i> Set Chart 1 Zoom
                        </button>
                        <button class="zoom-dropdown-item" onclick="showZoomSettings({{ lipid.lipid_id }}, 'chart2')">
                            <i class="fas fa-expand-arrows-alt"></i> Set Chart 2 Zoom
                        </button>
                        <div class="zoom-dropdown-divider"></div>
                        <button class="zoom-dropdown-item reset" onclick="restoreDefaults({{ lipid.lipid_id }})">
                            <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shared Legend -->
        <div class="shared-legend" id="legend-{{ lipid.lipid_id }}" style="display: none;">
            <div class="legend-title">Chart Legend</div>
            <div class="legend-items" id="legend-items-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Charts and Info Panel Grid -->
        <div class="charts-grid">
            <!-- Charts Container -->
            <div class="dual-charts-container">
                <div class="single-chart-container">
                    <div class="chart-canvas">
                        <canvas id="chart1-{{ lipid.lipid_id }}"></canvas>
                    </div>
                </div>
                
                <div class="single-chart-container">
                    <div class="chart-canvas">
                        <canvas id="chart2-{{ lipid.lipid_id }}"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Information Panel (Hidden by default) -->
        <div class="detailed-info-panel" id="detailed-info-{{ lipid.lipid_id }}" style="display: none;">
            <!-- Comprehensive Lipid Information -->
            <div class="info-section">
                <h4>Lipid Details</h4>
                <div id="detailed-lipid-info-{{ lipid.lipid_id }}" class="lipid-details-grid">
                    <!-- Will be populated by JavaScript with comprehensive lipid data -->
                </div>
            </div>
            
            <!-- Annotated Ions Section -->
            <div class="info-section" id="detailed-ions-{{ lipid.lipid_id }}">
                <h4>Annotated Ions: <span id="detailed-ions-count-{{ lipid.lipid_id }}">0</span></h4>
                <div class="ions-summary" id="detailed-ions-summary-{{ lipid.lipid_id }}">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading-state" id="loading-{{ lipid.lipid_id }}">
            <div>
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Loading dual chart data for {{ lipid.lipid_name }}...</span>
            </div>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="error-{{ lipid.lipid_id }}" style="display: none;">
            <strong>Error loading charts:</strong> 
            <span id="error-message-{{ lipid.lipid_id }}"></span>
        </div>
        
        <!-- Annotated Ions Section -->
        <div class="annotated-ions-section" id="ions-section-{{ lipid.lipid_id }}" style="display: none;">
            <div class="section-title">
                Annotated Ions: <span id="ions-count-{{ lipid.lipid_id }}">0</span>
            </div>
            <div class="ions-summary" id="ions-summary-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Individual Zoom Settings Modal -->
    <div class="zoom-modal" id="zoom-modal">
        <div class="zoom-modal-content">
            <div class="zoom-form">
                <h3 id="zoom-modal-title">Set Zoom Range for Lipid</h3>
                <div>
                    <label for="zoom-start">Start Time (minutes):</label>
                    <input type="number" id="zoom-start" step="0.01" min="0" max="20" placeholder="0.00">
                </div>
                <div>
                    <label for="zoom-end">End Time (minutes):</label>
                    <input type="number" id="zoom-end" step="0.01" min="0.1" max="30" placeholder="16.00">
                </div>
                <div class="zoom-form-buttons">
                    <button class="btn-cancel" onclick="closeZoomModal()">Cancel</button>
                    <button class="btn-save" onclick="saveZoomModalSettings()">Save & Apply</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// Chart instances storage
const chartInstances = {};
const chartData = {};

// Register Chart.js zoom plugin - Fixed CDN compatibility
try {
    // Check if zoom plugin is available (multiple possible global names)
    if (typeof window.chartjsPluginZoom !== 'undefined') {
        Chart.register(window.chartjsPluginZoom);
        console.log('‚úÖ Chart.js zoom plugin registered successfully via chartjsPluginZoom');
    } else if (typeof window.ChartZoom !== 'undefined') {
        Chart.register(window.ChartZoom);
        console.log('‚úÖ Chart.js zoom plugin registered successfully via ChartZoom');
    } else if (typeof ChartZoom !== 'undefined') {
        Chart.register(ChartZoom);
        console.log('‚úÖ Chart.js zoom plugin registered successfully via global ChartZoom');
    } else {
        console.warn('‚ö†Ô∏è Chart.js zoom plugin not found - zoom features will be disabled');
        console.log('Available globals:', Object.keys(window).filter(key => key.toLowerCase().includes('zoom')));
    }
} catch (error) {
    console.warn('‚ö†Ô∏è Failed to register Chart.js zoom plugin:', error);
}

// Individual zoom settings storage with database persistence
let individualZoomSettings = {};
let adminDefaultSettings = {};
let currentZoomLipidId = null;
let currentZoomChart = null;
let isAdmin = {{ 'true' if current_user.is_authenticated and current_user.is_admin() else 'false' }};

// Load zoom settings from database
async function loadZoomSettings() {
    try {
        const response = await fetch('/api/zoom-settings');
        const result = await response.json();
        
        if (result.status === 'success') {
            individualZoomSettings = result.settings || {};
            console.log('üîÑ Loaded zoom settings from database:', individualZoomSettings);
        } else {
            console.warn('Failed to load zoom settings:', result.message);
            individualZoomSettings = {};
        }
    } catch (error) {
        console.warn('Failed to load zoom settings from database:', error);
        individualZoomSettings = {};
    }
}

// Save zoom settings to database
async function saveZoomSettings(lipidId, chartType, zoomStart, zoomEnd) {
    try {
        const response = await fetch('/api/zoom-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lipid_id: lipidId,
                chart_type: chartType,
                zoom_start: zoomStart,
                zoom_end: zoomEnd
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            console.log('üíæ Saved zoom settings to database:', result.setting);
            // Update local cache
            const settingsKey = `${lipidId}_${chartType}`;
            individualZoomSettings[settingsKey] = {
                start: zoomStart,
                end: zoomEnd
            };
        } else {
            console.error('Failed to save zoom settings:', result.message);
        }
    } catch (error) {
        console.error('Failed to save zoom settings to database:', error);
    }
}

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', async function() {
    // Load saved zoom settings from database first
    await loadZoomSettings();
    
    {% for lipid in selected_lipids %}
        initializeDualCharts({{ lipid.lipid_id }});
    {% endfor %}
});

// Individual zoom modal functions
function showZoomSettings(lipidId, chartType) {
    // Close dropdown
    document.querySelectorAll('.zoom-dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
    
    currentZoomLipidId = lipidId;
    currentZoomChart = chartType;
    const modal = document.getElementById('zoom-modal');
    const title = document.getElementById('zoom-modal-title');
    const startInput = document.getElementById('zoom-start');
    const endInput = document.getElementById('zoom-end');
    
    // Get lipid name
    const lipidName = document.querySelector(`#lipid-container-${lipidId} .lipid-title`).textContent;
    const chartName = chartType === 'chart1' ? 'Chart 1' : 'Chart 2';
    title.textContent = `Set Zoom Range for ${lipidName} - ${chartName}`;
    
    // Load existing settings if any
    const existing = individualZoomSettings[`${lipidId}_${chartType}`];
    if (existing) {
        startInput.value = existing.start;
        endInput.value = existing.end;
    } else {
        startInput.value = '';
        endInput.value = '';
    }
    
    modal.style.display = 'flex';
}

function closeZoomModal() {
    document.getElementById('zoom-modal').style.display = 'none';
    currentZoomLipidId = null;
    currentZoomChart = null;
}

async function saveZoomModalSettings() {
    if (!currentZoomLipidId || !currentZoomChart) return;
    
    const startValue = parseFloat(document.getElementById('zoom-start').value);
    const endValue = parseFloat(document.getElementById('zoom-end').value);
    
    if (isNaN(startValue) || isNaN(endValue) || startValue >= endValue) {
        alert('Please enter valid start and end times (start must be less than end)');
        return;
    }
    
    // Save to database
    await saveZoomSettings(currentZoomLipidId, currentZoomChart, startValue, endValue);
    
    // Apply zoom immediately
    applyIndividualZoom(currentZoomLipidId, currentZoomChart);
    
    closeZoomModal();
}

// Apply individual zoom to specific lipid chart
function applyIndividualZoom(lipidId, chartType) {
    const settingsKey = `${lipidId}_${chartType}`;
    const settings = individualZoomSettings[settingsKey];
    if (!settings || !chartInstances[lipidId]) {
        console.log(`‚ùå Cannot apply zoom - settings: ${!!settings}, chartInstances: ${!!chartInstances[lipidId]}`);
        return;
    }
    
    try {
        const chart = chartInstances[lipidId][chartType];
        if (!chart) {
            console.log(`‚ùå Chart instance not found for ${lipidId} ${chartType}`);
            return;
        }
        
        console.log(`üéØ Applying individual zoom to ${lipidId} ${chartType}: ${settings.start.toFixed(2)} - ${settings.end.toFixed(2)} minutes`);
        console.log(`üìä Current chart state:`, chart.scales.x.min, 'to', chart.scales.x.max);
        
        // ROBUST ZOOM APPLICATION - Prioritize most reliable methods
        let zoomApplied = false;
        
        // Method 1: Direct scale options update (MOST RELIABLE - use first)
        try {
            console.log('üìä Method 1: Direct scale options update (primary)');
            if (chart.scales && chart.scales.x) {
                chart.scales.x.options.min = settings.start;
                chart.scales.x.options.max = settings.end;
                
                // CRITICAL: Force immediate update without animation
                chart.update('none');
                
                console.log('‚úÖ Zoom applied via scale options (primary method)');
                zoomApplied = true;
            } else {
                console.warn('‚ö†Ô∏è Chart scales not available');
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Scale options update failed:', e);
        }
        
        // Method 2: Chart.js zoom plugin (backup - often unreliable)
        if (!zoomApplied && typeof chart.zoom === 'function') {
            try {
                console.log('üìä Method 2: Chart.js zoom plugin (backup)');
                chart.zoom({
                    x: {
                        min: settings.start,
                        max: settings.end
                    }
                });
                console.log('‚úÖ Zoom applied via chart.zoom()');
                zoomApplied = true;
            } catch (e) {
                console.warn('‚ö†Ô∏è chart.zoom() failed:', e);
            }
        }
        
        // Method 3: Chart options update (final fallback)
        if (!zoomApplied) {
            try {
                console.log('üìä Method 3: Chart options update (fallback)');
                if (chart.options && chart.options.scales && chart.options.scales.x) {
                    chart.options.scales.x.min = settings.start;
                    chart.options.scales.x.max = settings.end;
                    chart.update('active');
                    console.log('‚úÖ Zoom applied via chart options');
                    zoomApplied = true;
                } else {
                    console.warn('‚ö†Ô∏è Chart options scales not available');
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Chart options update failed:', e);
            }
        }
        
        // Final verification with increased tolerance and delay
        setTimeout(() => {
            const currentMin = chart.scales.x.min;
            const currentMax = chart.scales.x.max;
            console.log(`üîç Zoom verification for ${lipidId} ${chartType}: Currently showing ${currentMin.toFixed(2)} - ${currentMax.toFixed(2)}, Expected: ${settings.start.toFixed(2)} - ${settings.end.toFixed(2)}`);
            
            // More lenient tolerance for verification (0.2 instead of 0.1)
            const tolerance = 0.2;
            const minDiff = Math.abs(currentMin - settings.start);
            const maxDiff = Math.abs(currentMax - settings.end);
            
            if (minDiff > tolerance || maxDiff > tolerance) {
                console.warn(`‚ö†Ô∏è Zoom not applied correctly! Min diff: ${minDiff.toFixed(3)}, Max diff: ${maxDiff.toFixed(3)}`);
                console.warn(`‚ö†Ô∏è Attempting force update with multiple methods...`);
                
                // Try multiple force update methods
                try {
                    // Method 1: Direct scale update
                    chart.scales.x.options.min = settings.start;
                    chart.scales.x.options.max = settings.end;
                    chart.update('none');
                    
                    // Method 2: Also update chart options as backup
                    if (chart.options.scales && chart.options.scales.x) {
                        chart.options.scales.x.min = settings.start;
                        chart.options.scales.x.max = settings.end;
                    }
                    
                    // Final verification after force update
                    setTimeout(() => {
                        const newMin = chart.scales.x.min;
                        const newMax = chart.scales.x.max;
                        console.log(`üîç After force update: ${newMin.toFixed(2)} - ${newMax.toFixed(2)}`);
                    }, 50);
                    
                } catch (forceError) {
                    console.error(`‚ùå Force update failed:`, forceError);
                }
            } else {
                console.log(`‚úÖ Zoom successfully applied and verified (tolerance: ¬±${tolerance})`);
            }
        }, 250);
        
        // Add visual indicator
        const canvas = chart.canvas;
        canvas.style.borderTop = '3px solid #007bff';
        canvas.style.borderLeft = '3px solid #007bff';
        canvas.title = `Individual Zoom: ${settings.start.toFixed(2)} - ${settings.end.toFixed(2)} minutes`;
        
        // Add individual zoom badge
        addIndividualZoomBadge(lipidId, chartType);
        
    } catch (error) {
        console.error(`‚ùå Failed to apply individual zoom to ${lipidId} ${chartType}:`, error);
        console.error('Error details:', error.stack);
    }
}

// Add visual badge for individual zoom
function addIndividualZoomBadge(lipidId, chartType) {
    try {
        const chartIndex = chartType === 'chart1' ? 1 : 2;
        const chartContainer = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(${chartIndex})`);
        if (!chartContainer) return;
        
        // Remove existing badge
        const existingBadge = chartContainer.querySelector('.individual-zoom-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        const settingsKey = `${lipidId}_${chartType}`;
        const settings = individualZoomSettings[settingsKey];
        if (!settings) return;
        
        // Create individual zoom badge
        const badge = document.createElement('div');
        badge.className = 'individual-zoom-badge';
        
        // Check if this is an admin default
        const isAdminDefault = settings.is_admin_default || false;
        
        badge.innerHTML = `
            <i class="fas ${isAdminDefault ? 'fa-crown' : 'fa-user-cog'}"></i> 
            ${chartType.toUpperCase()}: ${settings.start.toFixed(1)}-${settings.end.toFixed(1)}min
            ${isAdminDefault ? ' (Admin)' : ''}
        `;
        badge.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, ${isAdminDefault ? '#28a745, #218838' : '#007bff, #0056b3'});
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(${isAdminDefault ? '40, 167, 69' : '0, 123, 255'}, 0.3);
            pointer-events: none;
        `;
        
        chartContainer.style.position = 'relative';
        chartContainer.appendChild(badge);
    } catch (error) {
        console.warn('Could not add individual zoom badge:', error);
    }
}

// Restore defaults function
async function restoreDefaults(lipidId) {
    // Close dropdown
    document.querySelectorAll('.zoom-dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
    
    try {
        // Delete from database
        const response = await fetch(`/api/zoom-settings/${lipidId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            console.log(`‚úÖ Deleted zoom settings from database for lipid ${lipidId}`);
        }
        
        // Remove zoom settings for both charts from local cache
        delete individualZoomSettings[`${lipidId}_chart1`];
        delete individualZoomSettings[`${lipidId}_chart2`];
        
        // Reset both charts to default zoom
        if (chartInstances[lipidId]) {
            if (chartInstances[lipidId].chart1) {
                if (chartInstances[lipidId].chart1.resetZoom) {
                    chartInstances[lipidId].chart1.resetZoom();
                }
                chartInstances[lipidId].chart1.canvas.style.borderTop = '';
                chartInstances[lipidId].chart1.canvas.style.borderLeft = '';
                chartInstances[lipidId].chart1.canvas.title = '';
            }
            if (chartInstances[lipidId].chart2) {
                if (chartInstances[lipidId].chart2.resetZoom) {
                    chartInstances[lipidId].chart2.resetZoom();
                }
                chartInstances[lipidId].chart2.canvas.style.borderTop = '';
                chartInstances[lipidId].chart2.canvas.style.borderLeft = '';
                chartInstances[lipidId].chart2.canvas.title = '';
            }
        }
        
        // Remove badges
        const chart1Container = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(1)`);
        const chart2Container = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(2)`);
        
        if (chart1Container) {
            const badge1 = chart1Container.querySelector('.individual-zoom-badge');
            if (badge1) badge1.remove();
        }
        if (chart2Container) {
            const badge2 = chart2Container.querySelector('.individual-zoom-badge');
            if (badge2) badge2.remove();
        }
        
        console.log(`üîÑ Restored defaults for lipid ${lipidId} and removed from database`);
    } catch (error) {
        console.warn('Error restoring defaults:', error);
    }
}



// Professional dropdown functionality
function toggleZoomDropdown(lipidId) {
    const dropdown = document.getElementById(`zoom-dropdown-${lipidId}`);
    const isVisible = dropdown.style.display !== 'none';
    
    // Close all other dropdowns first
    document.querySelectorAll('.zoom-dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
    
    // Toggle current dropdown
    dropdown.style.display = isVisible ? 'none' : 'block';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.zoom-controls-dropdown')) {
        document.querySelectorAll('.zoom-dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

async function initializeDualCharts(lipidId) {
    try {
        // Show loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'flex';
        document.getElementById(`error-${lipidId}`).style.display = 'none';
        
        // Hide charts initially
        const chartsGrid = document.querySelector(`#lipid-container-${lipidId} .charts-grid`);
        chartsGrid.style.display = 'none';
        
        // Fetch dual chart data
        const response = await fetch(`/api/dual-chart-data/${lipidId}`);
        const result = await response.json();
        
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || 'Failed to load chart data');
        }
        
        // Store data
        chartData[lipidId] = result.data;
        
        // DEBUG: Log chart data to understand what we're getting
        console.log(`üìä DEBUG - Lipid ${lipidId} API Response:`, result);
        console.log(`üìä DEBUG - Chart1 config:`, result.data.chart1);
        console.log(`üìä DEBUG - Chart2 config:`, result.data.chart2);
        console.log(`üìä DEBUG - Chart1 datasets:`, result.data.chart1?.data?.datasets);
        console.log(`üìä DEBUG - Chart2 datasets:`, result.data.chart2?.data?.datasets);
        
        // Hide loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        
        // Show charts
        chartsGrid.style.display = 'grid';
        
        // Create both charts
        createChart(lipidId, 'chart1', result.data.chart1);
        createChart(lipidId, 'chart2', result.data.chart2);
        
        // Add double-click reset functionality
        addDoubleClickReset(lipidId, 'chart1');
        addDoubleClickReset(lipidId, 'chart2');
        
        // Apply individual zoom settings after short delay to ensure chart is fully initialized
        setTimeout(() => {
            if (individualZoomSettings[`${lipidId}_chart1`]) {
                console.log(`üéØ Applying saved zoom to Chart 1 for lipid ${lipidId}:`, individualZoomSettings[`${lipidId}_chart1`]);
                applyIndividualZoom(lipidId, 'chart1');
            }
            if (individualZoomSettings[`${lipidId}_chart2`]) {
                console.log(`üéØ Applying saved zoom to Chart 2 for lipid ${lipidId}:`, individualZoomSettings[`${lipidId}_chart2`]);
                applyIndividualZoom(lipidId, 'chart2');
            }
        }, 200);
        
        // Store data for detailed info panel
        window.chartData = window.chartData || {};
        window.chartData[lipidId] = {
            datasets: result.data.chart1.data.datasets,
            annotatedIons: result.data.annotated_ions
        };
        
    } catch (error) {
        console.error(`Error initializing charts for lipid ${lipidId}:`, error);
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        document.getElementById(`error-${lipidId}`).style.display = 'block';
        document.getElementById(`error-message-${lipidId}`).textContent = error.message;
    }
}

function createChart(lipidId, chartType, chartConfig) {
    console.log(`üé® DEBUG - Creating chart ${chartType} for lipid ${lipidId}`);
    console.log(`üé® DEBUG - Chart config received:`, chartConfig);
    console.log(`üé® DEBUG - Chart datasets:`, chartConfig?.data?.datasets);
    console.log(`üé® DEBUG - Chart data points:`, chartConfig?.data?.datasets?.[0]?.data);
    
    const canvasId = `${chartType}-${lipidId}`;
    const ctx = document.getElementById(canvasId);
    
    if (!ctx) {
        console.error(`‚ùå Canvas element not found: ${canvasId}`);
        return;
    }
    
    console.log(`‚úÖ Canvas found: ${canvasId}`);
    const context = ctx.getContext('2d');
    
    // Ensure chartConfig.options exists
    if (!chartConfig.options) {
        chartConfig.options = {};
    }
    
    // Ensure chartConfig.options.plugins exists
    if (!chartConfig.options.plugins) {
        chartConfig.options.plugins = {};
    }
    
    // Safe chart config - completely override any problematic backend settings
    if (chartConfig.options && chartConfig.options.scales) {
        // X-axis: Smart time formatting that prevents overlapping
        if (chartConfig.options.scales.x) {
            // Calculate dynamic tick limit based on zoom level
            const xRange = (chartConfig.options.scales.x.max || 16) - (chartConfig.options.scales.x.min || 0);
            let maxTicks;
            if (xRange <= 1) maxTicks = 4;        // Very zoomed: 4 ticks max
            else if (xRange <= 2) maxTicks = 6;   // Moderately zoomed: 6 ticks max  
            else if (xRange <= 4) maxTicks = 8;   // Slightly zoomed: 8 ticks max
            else maxTicks = 12;                   // Full view: 12 ticks max
            
            chartConfig.options.scales.x.ticks = {
                maxTicksLimit: maxTicks,
                callback: function(value) {
                    // Smart formatting based on zoom level
                    const xRange = (chartConfig.options.scales.x.max || 16) - (chartConfig.options.scales.x.min || 0);
                    
                    if (xRange <= 1) {
                        // Very zoomed: show 2 decimal places for precision
                        return value.toFixed(2);
                    } else if (xRange <= 2) {
                        // Moderately zoomed: show 1 decimal place
                        return value.toFixed(1);
                    } else {
                        // Normal/wide view: round to 1 decimal place
                        return Math.round(value * 10) / 10;
                    }
                },
                // Ensure minimum spacing between ticks to prevent overlap
                minRotation: 0,
                maxRotation: 0,
                autoSkip: true,
                autoSkipPadding: 5
            };
        }
        
        // Y-axis: Safe intensity formatting
        if (chartConfig.options.scales.y) {
            chartConfig.options.scales.y.ticks = {
                maxTicksLimit: 6,
                callback: function(value, index) {
                    // HIDE the first (lowest) intensity axis number to avoid ugly small numbers
                    if (index === 0) {
                        return ''; // Hide the first/lowest tick label
                    }
                    
                    // Safe number formatting - avoid any decimal precision issues
                    if (value >= 1000) {
                        return Math.round(value / 100) * 100; // Round to nearest 100
                    } else if (value >= 100) {
                        return Math.round(value);
                    } else {
                        return Math.round(value * 10) / 10; // Round to 1 decimal safely
                    }
                }
            };
        }
    }
    
    // Add zoom and pan functionality - CLICK TO ACTIVATE
    // Store chart active state
    if (!window.activeCharts) {
        window.activeCharts = new Set();
    }
    
    const chartId = `${chartType}-${lipidId}`;
    
    // Only add zoom plugin if it's available
    try {
        if (Chart.registry && Chart.registry.plugins.get('zoom')) {
            chartConfig.options.plugins.zoom = {
                zoom: {
                    wheel: {
                        enabled: false,  // Disabled by default
                        speed: 0.1
                    },
                    pinch: {
                        enabled: false   // Disabled by default
                    },
                    drag: {
                        enabled: false,  // Disabled by default
                        backgroundColor: 'rgba(225, 225, 225, 0.3)'
                    },
                    mode: 'x'  // Only zoom/pan on X-axis (retention time)
                },
                pan: {
                    enabled: false,  // Disabled by default
                    mode: 'x',       // Only pan on X-axis
                    modifierKey: 'shift'  // Hold shift to pan
                }
            };
        } else {
            console.warn(`‚ö†Ô∏è Zoom plugin not available for chart ${chartId} - zoom features disabled`);
        }
    } catch (error) {
        console.warn(`‚ö†Ô∏è Error configuring zoom plugin for chart ${chartId}:`, error);
    }
    
    // Disable tooltips for cleaner charts
    if (chartConfig.options && chartConfig.options.plugins) {
        chartConfig.options.plugins.tooltip = {
            enabled: false
        };
    }
    
    // Store chart instance
    if (!chartInstances[lipidId]) {
        chartInstances[lipidId] = {};
    }
    
    const chart = new Chart(context, chartConfig);
    chartInstances[lipidId][chartType] = chart;
    
    console.log(`‚úÖ Chart instance created for ${canvasId}:`, chart);
    console.log(`‚úÖ Chart data:`, chart.data);
    console.log(`‚úÖ Chart datasets:`, chart.data?.datasets);
    console.log(`‚úÖ Chart canvas:`, chart.canvas);
    
    // Add click-to-activate zoom functionality
    chart.canvas.addEventListener('click', function() {
        try {
            // Activate zoom for this chart (only if zoom plugin is available)
            if (chart.options.plugins && chart.options.plugins.zoom) {
                chart.options.plugins.zoom.zoom.wheel.enabled = true;
                chart.options.plugins.zoom.zoom.pinch.enabled = true;
                chart.options.plugins.zoom.zoom.drag.enabled = true;
                chart.options.plugins.zoom.pan.enabled = true;
            }
            
            // Add visual indicator that chart is active
            chart.canvas.style.border = '2px solid #007bff';
            chart.canvas.style.borderRadius = '4px';
            
            // Deactivate other charts
            Object.keys(chartInstances).forEach(lid => {
                Object.keys(chartInstances[lid]).forEach(ctype => {
                    if (lid != lipidId || ctype != chartType) {
                        const otherChart = chartInstances[lid][ctype];
                        try {
                            if (otherChart.options.plugins && otherChart.options.plugins.zoom) {
                                otherChart.options.plugins.zoom.zoom.wheel.enabled = false;
                                otherChart.options.plugins.zoom.zoom.pinch.enabled = false;
                                otherChart.options.plugins.zoom.zoom.drag.enabled = false;
                                otherChart.options.plugins.zoom.pan.enabled = false;
                            }
                        } catch (error) {
                            console.warn('Error deactivating chart zoom:', error);
                        }
                        otherChart.canvas.style.border = '';
                        otherChart.canvas.style.borderRadius = '';
                    }
                });
            });
            
            // Safe chart update with error handling
            try {
                chart.update('none');
            } catch (updateError) {
                console.warn('Chart update failed, skipping:', updateError);
            }
        } catch (error) {
            console.error('Error activating chart zoom:', error);
        }
    });
    
    // Add double-click to deactivate
    chart.canvas.addEventListener('dblclick', function() {
        deactivateChart(chart, chart.canvas);
    });
    
    // Store chart reference for global deactivation
    if (!window.allChartInstances) {
        window.allChartInstances = [];
    }
    window.allChartInstances.push({chart: chart, canvas: chart.canvas});
}

function createSharedLegend(lipidId, datasets) {
    const legendContainer = document.getElementById(`legend-items-${lipidId}`);
    const legendSection = document.getElementById(`legend-${lipidId}`);
    
    if (!legendContainer || !datasets) return;
    
    let legendHTML = '';
    
    // Add main chromatogram line
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color" style="background-color: #1f77b4;"></div>
            <span>Chromatogram</span>
        </div>
    `;
    
    // Add integration areas (skip boundary lines and chromatogram)
    datasets.forEach(dataset => {
        if (dataset.label !== 'Chromatogram' && 
            !dataset.label.startsWith('_boundary_line') && 
            dataset.lipid_info) {
            
            const color = dataset.borderColor || '#40E0D0';
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${color}; opacity: 0.3;"></div>
                    <span>${dataset.lipid_info.lipid_name}</span>
                </div>
            `;
        }
    });
    
    // Add boundary lines
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color dashed" style="border-color: rgba(70, 130, 180, 0.9);"></div>
            <span>Integration Boundaries</span>
        </div>
    `;
    
    legendContainer.innerHTML = legendHTML;
    legendSection.style.display = 'block';
}

function populateAnnotatedIons(lipidId, annotatedIons) {
    const ionsSection = document.getElementById(`ions-section-${lipidId}`);
    const ionsCount = document.getElementById(`ions-count-${lipidId}`);
    const ionsSummary = document.getElementById(`ions-summary-${lipidId}`);
    
    if (!annotatedIons || annotatedIons.length === 0) {
        ionsSection.style.display = 'none';
        return;
    }
    
    // Update count
    ionsCount.textContent = annotatedIons.length;
    
    // Build ions summary
    let summaryHTML = '';
    annotatedIons.forEach(ion => {
        const borderColor = ion.color || '#007bff';
        
        summaryHTML += `
            <div class="ion-item" style="border-left-color: ${borderColor};">
                <div class="ion-name">${ion.lipid_name}</div>
                <div class="ion-details">
                    <div><strong>Type:</strong> ${ion.annotation_type}</div>
                    <div><strong>RT:</strong> ${ion.retention_time} min</div>
                    <div><strong>MS/MS:</strong> ${ion.precursor_ion} ‚Üí ${ion.product_ion} m/z</div>
                    <div><strong>Integration:</strong> ${ion.integration_start} - ${ion.integration_end} min</div>
                </div>
            </div>
        `;
    });
    
    ionsSummary.innerHTML = summaryHTML;
    ionsSection.style.display = 'block';
}

// Toggle detailed information panel
function toggleDetailedInfo(lipidId) {
    const detailedPanel = document.getElementById(`detailed-info-${lipidId}`);
    const toggleBtn = document.getElementById(`toggle-btn-${lipidId}`);
    
    if (detailedPanel.style.display === 'none' || detailedPanel.style.display === '') {
        // Show detailed info
        detailedPanel.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
        toggleBtn.classList.add('active');
        
        // Populate detailed lipid information and ions
        if (window.chartData && window.chartData[lipidId]) {
            populateDetailedLipidInfo(lipidId, window.chartData[lipidId].datasets, window.chartData[lipidId].mainLipidData);
            populateDetailedIons(lipidId, window.chartData[lipidId].annotatedIons);
        }
    } else {
        // Hide detailed info
        detailedPanel.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-info-circle"></i> Show Details';
        toggleBtn.classList.remove('active');
    }
}

function populateDetailedLipidInfo(lipidId, datasets, mainLipidData) {
    const infoContainer = document.getElementById(`detailed-lipid-info-${lipidId}`);
    
    if (!infoContainer || !datasets) return;
    
    // Find the main lipid dataset (Current lipid annotation)
    const mainDataset = datasets.find(dataset => 
        dataset.lipid_info && dataset.lipid_info.annotation === 'Current lipid'
    );
    
    if (!mainDataset) return;
    
    const lipidInfo = mainDataset.lipid_info;
    
    // Create comprehensive lipid information display
    let detailsHTML = `
        <div class="detail-card">
            <div class="detail-row">
                <span class="detail-label">Code</span>
                <span class="detail-value highlight">${lipidInfo.lipidcode || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Name</span>
                <span class="detail-value highlight">${lipidInfo.lipidstring || lipidInfo.lipid_name}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Class</span>
                <span class="detail-value">${lipidInfo.class || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Precursor Ion</span>
                <span class="detail-value">${lipidInfo.precursor_ion || 'N/A'} m/z</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product Ion</span>
                <span class="detail-value">${lipidInfo.product_ion || 'N/A'} m/z</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Retention Time</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.retention_time).toFixed(5)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Collision Energy</span>
                <span class="detail-value">${lipidInfo.collision_energy || 'N/A'} eV</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Polarity</span>
                <span class="detail-value">${lipidInfo.polarity || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detail-card">
            <div class="detail-row">
                <span class="detail-label">Fragmentation</span>
                <span class="detail-value">${lipidInfo.fragmentation || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ISTD</span>
                <span class="detail-value">${lipidInfo.istd || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Response Factor</span>
                <span class="detail-value">${lipidInfo.response_factor || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Integration Start</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.int_start).toFixed(7)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Integration End</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.int_end).toFixed(7)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">XIC Data Points</span>
                <span class="detail-value">${lipidInfo.xic_data_points || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Max Intensity</span>
                <span class="detail-value">${parseFloat(lipidInfo.max_intensity).toFixed(1)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Avg Intensity</span>
                <span class="detail-value">${parseFloat(lipidInfo.avg_intensity).toFixed(2)}</span>
            </div>
        </div>
    `;
    
    infoContainer.innerHTML = detailsHTML;
}

function populateDetailedIons(lipidId, annotatedIons) {
    const ionsSection = document.getElementById(`detailed-ions-${lipidId}`);
    const ionsCount = document.getElementById(`detailed-ions-count-${lipidId}`);
    const ionsSummary = document.getElementById(`detailed-ions-summary-${lipidId}`);
    
    if (!annotatedIons || annotatedIons.length === 0) {
        ionsSection.style.display = 'none';
        return;
    }
    
    // Update count
    ionsCount.textContent = annotatedIons.length;
    
    // Build ions summary
    let summaryHTML = '';
    annotatedIons.forEach(ion => {
        const borderColor = ion.color || '#007bff';
        
        summaryHTML += `
            <div class="ion-item" style="border-left-color: ${borderColor};">
                <div class="ion-name">${ion.lipid_name}</div>
                <div class="ion-details">
                    <div><strong>Type:</strong> ${ion.annotation_type}</div>
                    <div><strong>RT:</strong> ${ion.retention_time} min</div>
                    <div><strong>MS/MS:</strong> ${ion.precursor_ion} ‚Üí ${ion.product_ion} m/z</div>
                    <div><strong>Integration:</strong> ${ion.integration_start} - ${ion.integration_end} min</div>
                </div>
            </div>
        `;
    });
    
    ionsSummary.innerHTML = summaryHTML;
    ionsSection.style.display = 'block';
}


// Chart interaction handlers
function resetZoom(lipidId) {
    try {
        if (chartInstances[lipidId]) {
            if (chartInstances[lipidId].chart1 && chartInstances[lipidId].chart1.resetZoom) {
                chartInstances[lipidId].chart1.resetZoom();
            }
            if (chartInstances[lipidId].chart2 && chartInstances[lipidId].chart2.resetZoom) {
                chartInstances[lipidId].chart2.resetZoom();
                
                // Reapply individual zoom settings after reset
                setTimeout(() => {
                    if (individualZoomSettings[lipidId]) {
                        applyIndividualZoom(lipidId);
                    }
                }, 100);
            }
        }
    } catch (error) {
        console.warn('Error resetting zoom:', error);
    }
}

// Keyboard shortcuts for zoom control
document.addEventListener('keydown', function(e) {
    if (e.key === 'r' || e.key === 'R') {
        // Reset all charts zoom and reapply admin settings
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    } else if (e.key === '0') {
        // Reset all charts zoom with 0 key and reapply admin settings
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    }
});

// Double-click to reset zoom on individual charts
function addDoubleClickReset(lipidId, chartType) {
    const canvas = document.getElementById(`${chartType}-${lipidId}`);
    if (canvas) {
        canvas.addEventListener('dblclick', function() {
            try {
                if (chartInstances[lipidId] && chartInstances[lipidId][chartType]) {
                    const chart = chartInstances[lipidId][chartType];
                    
                    // Safe reset zoom with error handling
                    try {
                        if (chart.resetZoom) {
                            chart.resetZoom();
                        }
                    } catch (resetError) {
                        console.warn('Chart reset zoom failed in double-click:', resetError);
                    }
                    
                    // Reapply individual zoom settings for Chart 2
                    if (chartType === 'chart2') {
                        setTimeout(() => {
                            if (individualZoomSettings[lipidId]) {
                                applyIndividualZoom(lipidId);
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error in double-click reset:', error);
            }
        });
    }
}

// Deactivate chart function
function deactivateChart(chart, canvas) {
    try {
        if (chart.options.plugins && chart.options.plugins.zoom) {
            chart.options.plugins.zoom.zoom.wheel.enabled = false;
            chart.options.plugins.zoom.zoom.pinch.enabled = false;
            chart.options.plugins.zoom.zoom.drag.enabled = false;
            chart.options.plugins.zoom.pan.enabled = false;
        }
        canvas.style.border = '';
        canvas.style.borderRadius = '';
        
        // Safe reset zoom with error handling
        try {
            if (chart.resetZoom) {
                chart.resetZoom();
            }
        } catch (resetError) {
            console.warn('Chart reset zoom failed, skipping:', resetError);
        }
        
        // Safe chart update with error handling
        try {
            chart.update('none');
        } catch (updateError) {
            console.warn('Chart update failed, skipping:', updateError);
        }
        
        // Reapply individual zoom settings if this is Chart 2
        const canvasId = canvas.id;
        const matches = canvasId.match(/chart2-(\d+)/);
        if (matches) {
            const lipidId = matches[1];
            setTimeout(() => {
                if (individualZoomSettings[lipidId]) {
                    applyIndividualZoom(lipidId);
                }
            }, 100);
        }
    } catch (error) {
        console.error('Error deactivating chart:', error);
    }
}

// Global click handler to deactivate charts when clicking outside
document.addEventListener('click', function(event) {
    if (window.allChartInstances) {
        let clickedOnChart = false;
        
        // Check if click was on any chart canvas
        window.allChartInstances.forEach(({canvas}) => {
            if (canvas.contains(event.target) || canvas === event.target) {
                clickedOnChart = true;
            }
        });
        
        // If clicked outside all charts, deactivate all
        if (!clickedOnChart) {
            window.allChartInstances.forEach(({chart, canvas}) => {
                deactivateChart(chart, canvas);
            });
        }
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('zoom-modal');
    if (event.target === modal) {
        closeZoomModal();
    }
});

// Resize handler
window.addEventListener('resize', function() {
    Object.keys(chartInstances).forEach(lipidId => {
        Object.keys(chartInstances[lipidId]).forEach(chartType => {
            chartInstances[lipidId][chartType].resize();
        });
    });
});
</script>
{% endblock %}