{% extends "base.html" %}

{% block title %}Interactive Dual Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }
    
    .lipid-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .lipid-title {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 18px;
        color: #2c3e50;
        margin: 0;
    }
    
    .lipid-info {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .info-badge {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .info-toggle-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .info-toggle-btn:hover {
        background: #218838;
    }
    
    .info-toggle-btn.active {
        background: #dc3545;
    }
    
    .info-toggle-btn.active:hover {
        background: #c82333;
    }
    
    .zoom-settings-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-left: 8px;
    }
    
    .zoom-settings-btn:hover {
        background: #0056b3;
    }
    
    .zoom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .zoom-modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
    }
    
    .zoom-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .zoom-form h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        text-align: center;
    }
    
    .zoom-form label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .zoom-form input {
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
    }
    
    .zoom-form input:focus {
        border-color: #007bff;
        outline: none;
    }
    
    .zoom-form-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }
    
    .zoom-form-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
    }
    
    .btn-save:hover {
        background: #218838;
    }
    
    .btn-cancel {
        background: #6c757d;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #545b62;
    }
    
    .detailed-info-panel {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        display: none;
    }
    
    .info-section {
        margin-bottom: 20px;
    }
    
    .info-section:last-child {
        margin-bottom: 0;
    }
    
    .info-section h4 {
        color: #2c3e50;
        font-size: 16px;
        margin-bottom: 10px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .dual-charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    /* Shared legend container */
    .shared-legend {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .legend-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .legend-items {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }
    
    .legend-color {
        width: 16px;
        height: 3px;
        border-radius: 2px;
    }
    
    .legend-color.dashed {
        border: 1px dashed;
        background: none;
        height: 1px;
    }
    
    /* Remove custom tooltip styling - using external panel instead */
    
    .single-chart-container {
        position: relative;
        background: #fafafa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
    }
    
    .chart-canvas {
        position: relative;
        height: 300px;
        cursor: pointer;
    }
    
    .chart-lipid-name {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 4px 12px;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 12px;
        color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        pointer-events: none;
        border: 1px solid #e9ecef;
    }
    
    .chart-canvas canvas {
        transition: border 0.2s ease;
    }
    
    .chart-canvas canvas:hover {
        border: 1px solid #ccc !important;
    }
    
    .chart-title {
        display: none !important; /* Hide chart titles completely */
    }
    
    .loading-state {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        color: #666;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .error-state {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 6px;
        border: 1px solid #f5c6cb;
        text-align: center;
    }
    
    .annotated-ions-section {
        margin-top: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
    }
    
    .section-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .ions-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .ion-item {
        background: white;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        font-size: 12px;
    }
    
    .ion-name {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .ion-details {
        color: #666;
        margin-top: 4px;
    }
    
    .lipid-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .detail-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid #007bff;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-value {
        color: #2c3e50;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        font-weight: 500;
        background: #f8f9fa;
        padding: 2px 8px;
        border-radius: 4px;
    }
    
    .detail-value.highlight {
        background: #e3f2fd;
        color: #1976d2;
        font-weight: 600;
    }
    
    .back-button {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #f8f9fa;
        color: #495057;
        text-decoration: none;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        transition: all 0.2s ease;
    }
    
    .back-button:hover {
        background: #e9ecef;
        color: #495057;
        text-decoration: none;
    }
    
    .instructions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 13px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr !important;
        }
        
        .dual-charts-container {
            grid-template-columns: 1fr !important;
            gap: 10px;
        }
        
        .legend-items {
            justify-content: flex-start;
            gap: 15px;
        }
        
        .chart-canvas {
            height: 250px;
        }
    }
    
    @media (max-width: 768px) {
        .lipid-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .legend-items {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <a href="{{ url_for('clean_dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
    
    <!-- Instructions -->
    <div class="instructions">
        <strong>üìä Interactive Charts:</strong> Dual chart visualization with zoom functionality<br>
        <strong>üñ±Ô∏è Controls:</strong> Click chart to activate zoom | Mouse wheel to zoom | Shift+drag to pan | Double-click to deactivate zoom
    </div>

    <!-- Charts for each selected lipid -->
    {% for lipid in selected_lipids %}
    <div class="chart-container" id="lipid-container-{{ lipid.lipid_id }}">
        <!-- Lipid Header -->
        <div class="lipid-header">
            <h2 class="lipid-title">{{ lipid.lipid_name }}</h2>
            <div class="lipid-info">
                <span class="info-badge">{{ lipid.class_name }}</span>
                <span class="info-badge">ID: {{ lipid.lipid_id }}</span>
                <span class="info-badge">{{ lipid.annotated_ions_count }} Ions</span>
                <button class="info-toggle-btn" onclick="toggleDetailedInfo({{ lipid.lipid_id }})" id="toggle-btn-{{ lipid.lipid_id }}">
                    <i class="fas fa-info-circle"></i> Show Details
                </button>
                {% if current_user.is_authenticated and current_user.is_admin() %}
                <button class="zoom-settings-btn" onclick="showZoomSettings({{ lipid.lipid_id }}, 'chart1')" id="zoom-btn-chart1-{{ lipid.lipid_id }}">
                    <i class="fas fa-search-plus"></i> Set Zoom Chart 1
                </button>
                <button class="zoom-settings-btn" onclick="showZoomSettings({{ lipid.lipid_id }}, 'chart2')" id="zoom-btn-chart2-{{ lipid.lipid_id }}">
                    <i class="fas fa-search-plus"></i> Set Zoom Chart 2
                </button>
                <button class="zoom-settings-btn" onclick="restoreDefaults({{ lipid.lipid_id }})" id="restore-btn-{{ lipid.lipid_id }}" style="background: #dc3545;">
                    <i class="fas fa-undo"></i> Restore Defaults
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Shared Legend -->
        <div class="shared-legend" id="legend-{{ lipid.lipid_id }}" style="display: none;">
            <div class="legend-title">Chart Legend</div>
            <div class="legend-items" id="legend-items-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Charts and Info Panel Grid -->
        <div class="charts-grid">
            <!-- Charts Container -->
            <div class="dual-charts-container">
                <div class="single-chart-container">
                    <div class="chart-canvas">
                        <canvas id="chart1-{{ lipid.lipid_id }}"></canvas>
                    </div>
                </div>
                
                <div class="single-chart-container">
                    <div class="chart-canvas">
                        <canvas id="chart2-{{ lipid.lipid_id }}"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Information Panel (Hidden by default) -->
        <div class="detailed-info-panel" id="detailed-info-{{ lipid.lipid_id }}" style="display: none;">
            <!-- Comprehensive Lipid Information -->
            <div class="info-section">
                <h4>Lipid Details</h4>
                <div id="detailed-lipid-info-{{ lipid.lipid_id }}" class="lipid-details-grid">
                    <!-- Will be populated by JavaScript with comprehensive lipid data -->
                </div>
            </div>
            
            <!-- Annotated Ions Section -->
            <div class="info-section" id="detailed-ions-{{ lipid.lipid_id }}">
                <h4>Annotated Ions: <span id="detailed-ions-count-{{ lipid.lipid_id }}">0</span></h4>
                <div class="ions-summary" id="detailed-ions-summary-{{ lipid.lipid_id }}">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading-state" id="loading-{{ lipid.lipid_id }}">
            <div>
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Loading dual chart data for {{ lipid.lipid_name }}...</span>
            </div>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="error-{{ lipid.lipid_id }}" style="display: none;">
            <strong>Error loading charts:</strong> 
            <span id="error-message-{{ lipid.lipid_id }}"></span>
        </div>
        
        <!-- Annotated Ions Section -->
        <div class="annotated-ions-section" id="ions-section-{{ lipid.lipid_id }}" style="display: none;">
            <div class="section-title">
                Annotated Ions: <span id="ions-count-{{ lipid.lipid_id }}">0</span>
            </div>
            <div class="ions-summary" id="ions-summary-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Individual Zoom Settings Modal -->
    <div class="zoom-modal" id="zoom-modal">
        <div class="zoom-modal-content">
            <div class="zoom-form">
                <h3 id="zoom-modal-title">Set Zoom Range for Lipid</h3>
                <div>
                    <label for="zoom-start">Start Time (minutes):</label>
                    <input type="number" id="zoom-start" step="0.01" min="0" max="20" placeholder="0.00">
                </div>
                <div>
                    <label for="zoom-end">End Time (minutes):</label>
                    <input type="number" id="zoom-end" step="0.01" min="0.1" max="30" placeholder="16.00">
                </div>
                <div class="zoom-form-buttons">
                    <button class="btn-cancel" onclick="closeZoomModal()">Cancel</button>
                    <button class="btn-save" onclick="saveZoomModalSettings()">Save & Apply</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// Chart instances storage
const chartInstances = {};
const chartData = {};

// Register Chart.js zoom plugin
Chart.register(ChartZoom);

// Individual zoom settings storage with localStorage persistence
let individualZoomSettings = {};
let currentZoomLipidId = null;
let currentZoomChart = null;

// Load zoom settings from localStorage
function loadZoomSettings() {
    try {
        const saved = localStorage.getItem('metabolomics_zoom_settings');
        if (saved) {
            individualZoomSettings = JSON.parse(saved);
            console.log('üîÑ Loaded zoom settings from localStorage:', individualZoomSettings);
        }
    } catch (error) {
        console.warn('Failed to load zoom settings from localStorage:', error);
        individualZoomSettings = {};
    }
}

// Save zoom settings to localStorage
function saveZoomSettings() {
    try {
        localStorage.setItem('metabolomics_zoom_settings', JSON.stringify(individualZoomSettings));
        console.log('üíæ Saved zoom settings to localStorage:', individualZoomSettings);
    } catch (error) {
        console.warn('Failed to save zoom settings to localStorage:', error);
    }
}

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load saved zoom settings first
    loadZoomSettings();
    
    {% for lipid in selected_lipids %}
        initializeDualCharts({{ lipid.lipid_id }});
    {% endfor %}
});

// Individual zoom modal functions
function showZoomSettings(lipidId, chartType) {
    currentZoomLipidId = lipidId;
    currentZoomChart = chartType;
    const modal = document.getElementById('zoom-modal');
    const title = document.getElementById('zoom-modal-title');
    const startInput = document.getElementById('zoom-start');
    const endInput = document.getElementById('zoom-end');
    
    // Get lipid name
    const lipidName = document.querySelector(`#lipid-container-${lipidId} .lipid-title`).textContent;
    const chartName = chartType === 'chart1' ? 'Chart 1' : 'Chart 2';
    title.textContent = `Set Zoom Range for ${lipidName} - ${chartName}`;
    
    // Load existing settings if any
    const existing = individualZoomSettings[`${lipidId}_${chartType}`];
    if (existing) {
        startInput.value = existing.start;
        endInput.value = existing.end;
    } else {
        startInput.value = '';
        endInput.value = '';
    }
    
    modal.style.display = 'flex';
}

function closeZoomModal() {
    document.getElementById('zoom-modal').style.display = 'none';
    currentZoomLipidId = null;
    currentZoomChart = null;
}

function saveZoomModalSettings() {
    if (!currentZoomLipidId || !currentZoomChart) return;
    
    const startValue = parseFloat(document.getElementById('zoom-start').value);
    const endValue = parseFloat(document.getElementById('zoom-end').value);
    
    if (isNaN(startValue) || isNaN(endValue) || startValue >= endValue) {
        alert('Please enter valid start and end times (start must be less than end)');
        return;
    }
    
    // Save individual zoom settings with chart type
    const settingsKey = `${currentZoomLipidId}_${currentZoomChart}`;
    individualZoomSettings[settingsKey] = {
        start: startValue,
        end: endValue
    };
    
    // Save to localStorage
    saveZoomSettings();
    
    // Apply zoom immediately
    applyIndividualZoom(currentZoomLipidId, currentZoomChart);
    
    closeZoomModal();
}

// Apply individual zoom to specific lipid chart
function applyIndividualZoom(lipidId, chartType) {
    const settingsKey = `${lipidId}_${chartType}`;
    const settings = individualZoomSettings[settingsKey];
    if (!settings || !chartInstances[lipidId]) return;
    
    try {
        const chart = chartInstances[lipidId][chartType];
        if (chart) {
            console.log(`üéØ Applying individual zoom to ${lipidId} ${chartType}: ${settings.start.toFixed(2)} - ${settings.end.toFixed(2)} minutes`);
            
            // Reset and apply zoom
            chart.resetZoom('none');
            chart.zoomScale('x', {
                min: settings.start,
                max: settings.end
            }, 'none');
            
            // Add visual indicator
            const canvas = chart.canvas;
            canvas.style.borderTop = '3px solid #007bff';
            canvas.style.borderLeft = '3px solid #007bff';
            canvas.title = `Individual Zoom: ${settings.start.toFixed(2)} - ${settings.end.toFixed(2)} minutes`;
            
            // Add individual zoom badge
            addIndividualZoomBadge(lipidId, chartType);
        }
    } catch (error) {
        console.error(`Failed to apply individual zoom to ${lipidId} ${chartType}:`, error);
    }
}

// Add visual badge for individual zoom
function addIndividualZoomBadge(lipidId, chartType) {
    try {
        const chartIndex = chartType === 'chart1' ? 1 : 2;
        const chartContainer = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(${chartIndex})`);
        if (!chartContainer) return;
        
        // Remove existing badge
        const existingBadge = chartContainer.querySelector('.individual-zoom-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        const settingsKey = `${lipidId}_${chartType}`;
        const settings = individualZoomSettings[settingsKey];
        if (!settings) return;
        
        // Create individual zoom badge
        const badge = document.createElement('div');
        badge.className = 'individual-zoom-badge';
        badge.innerHTML = `
            <i class="fas fa-user-cog"></i> 
            ${chartType.toUpperCase()}: ${settings.start.toFixed(1)}-${settings.end.toFixed(1)}min
        `;
        badge.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            pointer-events: none;
        `;
        
        chartContainer.style.position = 'relative';
        chartContainer.appendChild(badge);
    } catch (error) {
        console.warn('Could not add individual zoom badge:', error);
    }
}

// Restore defaults function
function restoreDefaults(lipidId) {
    // Remove zoom settings for both charts
    delete individualZoomSettings[`${lipidId}_chart1`];
    delete individualZoomSettings[`${lipidId}_chart2`];
    
    // Save updated settings to localStorage
    saveZoomSettings();
    
    // Reset both charts to default zoom
    if (chartInstances[lipidId]) {
        if (chartInstances[lipidId].chart1) {
            chartInstances[lipidId].chart1.resetZoom();
            chartInstances[lipidId].chart1.canvas.style.borderTop = '';
            chartInstances[lipidId].chart1.canvas.style.borderLeft = '';
            chartInstances[lipidId].chart1.canvas.title = '';
        }
        if (chartInstances[lipidId].chart2) {
            chartInstances[lipidId].chart2.resetZoom();
            chartInstances[lipidId].chart2.canvas.style.borderTop = '';
            chartInstances[lipidId].chart2.canvas.style.borderLeft = '';
            chartInstances[lipidId].chart2.canvas.title = '';
        }
    }
    
    // Remove badges
    const chart1Container = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(1)`);
    const chart2Container = document.querySelector(`#lipid-container-${lipidId} .single-chart-container:nth-child(2)`);
    
    if (chart1Container) {
        const badge1 = chart1Container.querySelector('.individual-zoom-badge');
        if (badge1) badge1.remove();
    }
    if (chart2Container) {
        const badge2 = chart2Container.querySelector('.individual-zoom-badge');
        if (badge2) badge2.remove();
    }
    
    console.log(`üîÑ Restored defaults for lipid ${lipidId} and saved to localStorage`);
}

async function initializeDualCharts(lipidId) {
    try {
        // Show loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'flex';
        document.getElementById(`error-${lipidId}`).style.display = 'none';
        
        // Hide charts initially
        const chartsGrid = document.querySelector(`#lipid-container-${lipidId} .charts-grid`);
        chartsGrid.style.display = 'none';
        
        // Fetch dual chart data
        const response = await fetch(`/api/dual-chart-data/${lipidId}`);
        const result = await response.json();
        
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || 'Failed to load chart data');
        }
        
        // Store data
        chartData[lipidId] = result.data;
        
        // Hide loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        
        // Show charts
        chartsGrid.style.display = 'grid';
        
        // Create both charts
        createChart(lipidId, 'chart1', result.data.chart1);
        createChart(lipidId, 'chart2', result.data.chart2);
        
        // Add double-click reset functionality
        addDoubleClickReset(lipidId, 'chart1');
        addDoubleClickReset(lipidId, 'chart2');
        
        // Apply individual zoom settings if any exist
        setTimeout(() => {
            if (individualZoomSettings[`${lipidId}_chart1`]) {
                applyIndividualZoom(lipidId, 'chart1');
            }
            if (individualZoomSettings[`${lipidId}_chart2`]) {
                applyIndividualZoom(lipidId, 'chart2');
            }
        }, 500);
        
        // Store data for detailed info panel
        window.chartData = window.chartData || {};
        window.chartData[lipidId] = {
            datasets: result.data.chart1.data.datasets,
            annotatedIons: result.data.annotated_ions
        };
        
    } catch (error) {
        console.error(`Error initializing charts for lipid ${lipidId}:`, error);
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        document.getElementById(`error-${lipidId}`).style.display = 'block';
        document.getElementById(`error-message-${lipidId}`).textContent = error.message;
    }
}

function createChart(lipidId, chartType, chartConfig) {
    const canvasId = `${chartType}-${lipidId}`;
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Enhance chart config with JavaScript callbacks for better formatting
    if (chartConfig.options && chartConfig.options.scales && chartConfig.options.scales.y) {
        chartConfig.options.scales.y.ticks = {
            ...chartConfig.options.scales.y.ticks,
            callback: function(value, index) {
                // HIDE the first (lowest) intensity axis number to avoid ugly small numbers
                // but keep the chart drawing exactly as before
                if (index === 0) {
                    return ''; // Hide the first/lowest tick label
                }
                
                // Format remaining numbers normally
                if (value >= 1000) {
                    return value.toExponential(1);
                } else if (value >= 100) {
                    return Math.round(value).toString();
                } else if (value >= 10) {
                    return value.toFixed(1);
                } else {
                    return value.toFixed(2);
                }
            }
        };
    }
    
    // Add zoom and pan functionality - CLICK TO ACTIVATE
    if (!chartConfig.options.plugins) {
        chartConfig.options.plugins = {};
    }
    
    // Store chart active state
    if (!window.activeCharts) {
        window.activeCharts = new Set();
    }
    
    const chartId = `${chartType}-${lipidId}`;
    
    chartConfig.options.plugins.zoom = {
        zoom: {
            wheel: {
                enabled: false,  // Disabled by default
                speed: 0.1
            },
            pinch: {
                enabled: false   // Disabled by default
            },
            drag: {
                enabled: false,  // Disabled by default
                backgroundColor: 'rgba(225, 225, 225, 0.3)'
            },
            mode: 'x'  // Only zoom/pan on X-axis (retention time)
        },
        pan: {
            enabled: false,  // Disabled by default
            mode: 'x',       // Only pan on X-axis
            modifierKey: 'shift'  // Hold shift to pan
        }
    };
    
    // Professional 2D Area-Based Hover Detection System
    if (chartConfig.options && chartConfig.options.plugins) {
        // Disable tooltips completely - we're using onHover instead
        chartConfig.options.plugins.tooltip = {
            enabled: false
        };
        
        // Add custom onHover event for 2D area detection
        chartConfig.options.onHover = function(event, elements, chart) {
            // Get mouse position relative to chart canvas
            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
            
            // Convert canvas position to data coordinates
            const mouseX = chart.scales.x.getValueForPixel(canvasPosition.x);
            const mouseY = chart.scales.y.getValueForPixel(canvasPosition.y);
            
            console.log('=== 2D AREA HOVER DEBUG ===');
            console.log(`Mouse position: X=${mouseX?.toFixed(2)}, Y=${mouseY?.toFixed(0)}`);
            
            // Find which integration area the mouse is within
            let hoveredLipid = null;
            
            // Check each dataset for integration area bounds
            chart.data.datasets.forEach((dataset, idx) => {
                if (dataset.lipid_info && dataset.integration_range) {
                    // Calculate 2D bounds for this integration area
                    const timeStart = dataset.integration_range.start;
                    const timeEnd = dataset.integration_range.end;
                    
                    // Find min/max intensity within this integration area
                    let minIntensity = Infinity;
                    let maxIntensity = -Infinity;
                    
                    dataset.data.forEach(point => {
                        if (point.x >= timeStart && point.x <= timeEnd) {
                            minIntensity = Math.min(minIntensity, point.y);
                            maxIntensity = Math.max(maxIntensity, point.y);
                        }
                    });
                    
                    // Check if mouse is within this 2D rectangular area
                    const inTimeRange = mouseX >= timeStart && mouseX <= timeEnd;
                    const inIntensityRange = mouseY >= 0 && mouseY <= maxIntensity; // From baseline to peak
                    
                    console.log(`Dataset ${idx}: ${dataset.lipid_info.lipid_name} (${dataset.lipid_info.annotation})`);
                    console.log(`  Time range: ${timeStart.toFixed(2)} - ${timeEnd.toFixed(2)} | In range: ${inTimeRange}`);
                    console.log(`  Intensity range: 0 - ${maxIntensity.toFixed(0)} | In range: ${inIntensityRange}`);
                    console.log(`  Mouse in 2D area: ${inTimeRange && inIntensityRange}`);
                    
                    if (inTimeRange && inIntensityRange) {
                        // Mouse is within this integration area
                        if (!hoveredLipid) {
                            hoveredLipid = { dataset: dataset };
                        } else {
                            // Multiple matches - prefer the one with smaller area (more specific)
                            const currentArea = (timeEnd - timeStart) * maxIntensity;
                            const existingTimeRange = hoveredLipid.dataset.integration_range.end - hoveredLipid.dataset.integration_range.start;
                            const existingMaxIntensity = Math.max(...hoveredLipid.dataset.data.map(p => p.y));
                            const existingArea = existingTimeRange * existingMaxIntensity;
                            
                            if (currentArea < existingArea) {
                                hoveredLipid = { dataset: dataset };
                                console.log(`  -> Selected (smaller area: ${currentArea.toFixed(0)} vs ${existingArea.toFixed(0)})`);
                            }
                        }
                    }
                }
            });
            
            console.log(`Final selection: ${hoveredLipid ? hoveredLipid.dataset.lipid_info.annotation : 'None'}`);
        };
    }
    
    // Store chart instance
    if (!chartInstances[lipidId]) {
        chartInstances[lipidId] = {};
    }
    
    const chart = new Chart(ctx, chartConfig);
    chartInstances[lipidId][chartType] = chart;
    
    // Add click-to-activate zoom functionality
    ctx.canvas.addEventListener('click', function() {
        // Activate zoom for this chart
        chart.options.plugins.zoom.zoom.wheel.enabled = true;
        chart.options.plugins.zoom.zoom.pinch.enabled = true;
        chart.options.plugins.zoom.zoom.drag.enabled = true;
        chart.options.plugins.zoom.pan.enabled = true;
        
        // Add visual indicator that chart is active
        ctx.canvas.style.border = '2px solid #007bff';
        ctx.canvas.style.borderRadius = '4px';
        
        // Deactivate other charts
        Object.keys(chartInstances).forEach(lid => {
            Object.keys(chartInstances[lid]).forEach(ctype => {
                if (lid != lipidId || ctype != chartType) {
                    const otherChart = chartInstances[lid][ctype];
                    otherChart.options.plugins.zoom.zoom.wheel.enabled = false;
                    otherChart.options.plugins.zoom.zoom.pinch.enabled = false;
                    otherChart.options.plugins.zoom.zoom.drag.enabled = false;
                    otherChart.options.plugins.zoom.pan.enabled = false;
                    otherChart.canvas.style.border = '';
                    otherChart.canvas.style.borderRadius = '';
                }
            });
        });
        
        chart.update('none');
    });
    
    // Add double-click to deactivate
    ctx.canvas.addEventListener('dblclick', function() {
        deactivateChart(chart, ctx.canvas);
    });
    
    // Store chart reference for global deactivation
    if (!window.allChartInstances) {
        window.allChartInstances = [];
    }
    window.allChartInstances.push({chart: chart, canvas: ctx.canvas});
}

function createSharedLegend(lipidId, datasets) {
    const legendContainer = document.getElementById(`legend-items-${lipidId}`);
    const legendSection = document.getElementById(`legend-${lipidId}`);
    
    if (!legendContainer || !datasets) return;
    
    let legendHTML = '';
    
    // Add main chromatogram line
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color" style="background-color: #1f77b4;"></div>
            <span>Chromatogram</span>
        </div>
    `;
    
    // Add integration areas (skip boundary lines and chromatogram)
    datasets.forEach(dataset => {
        if (dataset.label !== 'Chromatogram' && 
            !dataset.label.startsWith('_boundary_line') && 
            dataset.lipid_info) {
            
            const color = dataset.borderColor || '#40E0D0';
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${color}; opacity: 0.3;"></div>
                    <span>${dataset.lipid_info.lipid_name}</span>
                </div>
            `;
        }
    });
    
    // Add boundary lines
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color dashed" style="border-color: rgba(70, 130, 180, 0.9);"></div>
            <span>Integration Boundaries</span>
        </div>
    `;
    
    legendContainer.innerHTML = legendHTML;
    legendSection.style.display = 'block';
}

function populateAnnotatedIons(lipidId, annotatedIons) {
    const ionsSection = document.getElementById(`ions-section-${lipidId}`);
    const ionsCount = document.getElementById(`ions-count-${lipidId}`);
    const ionsSummary = document.getElementById(`ions-summary-${lipidId}`);
    
    if (!annotatedIons || annotatedIons.length === 0) {
        ionsSection.style.display = 'none';
        return;
    }
    
    // Update count
    ionsCount.textContent = annotatedIons.length;
    
    // Build ions summary
    let summaryHTML = '';
    annotatedIons.forEach(ion => {
        const borderColor = ion.color || '#007bff';
        
        summaryHTML += `
            <div class="ion-item" style="border-left-color: ${borderColor};">
                <div class="ion-name">${ion.lipid_name}</div>
                <div class="ion-details">
                    <div><strong>Type:</strong> ${ion.annotation_type}</div>
                    <div><strong>RT:</strong> ${ion.retention_time} min</div>
                    <div><strong>MS/MS:</strong> ${ion.precursor_ion} ‚Üí ${ion.product_ion} m/z</div>
                    <div><strong>Integration:</strong> ${ion.integration_start} - ${ion.integration_end} min</div>
                </div>
            </div>
        `;
    });
    
    ionsSummary.innerHTML = summaryHTML;
    ionsSection.style.display = 'block';
}

// Toggle detailed information panel
function toggleDetailedInfo(lipidId) {
    const detailedPanel = document.getElementById(`detailed-info-${lipidId}`);
    const toggleBtn = document.getElementById(`toggle-btn-${lipidId}`);
    
    if (detailedPanel.style.display === 'none' || detailedPanel.style.display === '') {
        // Show detailed info
        detailedPanel.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
        toggleBtn.classList.add('active');
        
        // Populate detailed lipid information and ions
        if (window.chartData && window.chartData[lipidId]) {
            populateDetailedLipidInfo(lipidId, window.chartData[lipidId].datasets, window.chartData[lipidId].mainLipidData);
            populateDetailedIons(lipidId, window.chartData[lipidId].annotatedIons);
        }
    } else {
        // Hide detailed info
        detailedPanel.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-info-circle"></i> Show Details';
        toggleBtn.classList.remove('active');
    }
}

function populateDetailedLipidInfo(lipidId, datasets, mainLipidData) {
    const infoContainer = document.getElementById(`detailed-lipid-info-${lipidId}`);
    
    if (!infoContainer || !datasets) return;
    
    // Find the main lipid dataset (Current lipid annotation)
    const mainDataset = datasets.find(dataset => 
        dataset.lipid_info && dataset.lipid_info.annotation === 'Current lipid'
    );
    
    if (!mainDataset) return;
    
    const lipidInfo = mainDataset.lipid_info;
    
    // Create comprehensive lipid information display
    let detailsHTML = `
        <div class="detail-card">
            <div class="detail-row">
                <span class="detail-label">Code</span>
                <span class="detail-value highlight">${lipidInfo.lipidcode || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Name</span>
                <span class="detail-value highlight">${lipidInfo.lipidstring || lipidInfo.lipid_name}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Class</span>
                <span class="detail-value">${lipidInfo.class || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Precursor Ion</span>
                <span class="detail-value">${lipidInfo.precursor_ion || 'N/A'} m/z</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product Ion</span>
                <span class="detail-value">${lipidInfo.product_ion || 'N/A'} m/z</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Retention Time</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.retention_time).toFixed(5)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Collision Energy</span>
                <span class="detail-value">${lipidInfo.collision_energy || 'N/A'} eV</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Polarity</span>
                <span class="detail-value">${lipidInfo.polarity || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detail-card">
            <div class="detail-row">
                <span class="detail-label">Fragmentation</span>
                <span class="detail-value">${lipidInfo.fragmentation || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ISTD</span>
                <span class="detail-value">${lipidInfo.istd || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Response Factor</span>
                <span class="detail-value">${lipidInfo.response_factor || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Integration Start</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.int_start).toFixed(7)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Integration End</span>
                <span class="detail-value highlight">${parseFloat(lipidInfo.int_end).toFixed(7)} min</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">XIC Data Points</span>
                <span class="detail-value">${lipidInfo.xic_data_points || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Max Intensity</span>
                <span class="detail-value">${parseFloat(lipidInfo.max_intensity).toFixed(1)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Avg Intensity</span>
                <span class="detail-value">${parseFloat(lipidInfo.avg_intensity).toFixed(2)}</span>
            </div>
        </div>
    `;
    
    infoContainer.innerHTML = detailsHTML;
}

function populateDetailedIons(lipidId, annotatedIons) {
    const ionsSection = document.getElementById(`detailed-ions-${lipidId}`);
    const ionsCount = document.getElementById(`detailed-ions-count-${lipidId}`);
    const ionsSummary = document.getElementById(`detailed-ions-summary-${lipidId}`);
    
    if (!annotatedIons || annotatedIons.length === 0) {
        ionsSection.style.display = 'none';
        return;
    }
    
    // Update count
    ionsCount.textContent = annotatedIons.length;
    
    // Build ions summary
    let summaryHTML = '';
    annotatedIons.forEach(ion => {
        const borderColor = ion.color || '#007bff';
        
        summaryHTML += `
            <div class="ion-item" style="border-left-color: ${borderColor};">
                <div class="ion-name">${ion.lipid_name}</div>
                <div class="ion-details">
                    <div><strong>Type:</strong> ${ion.annotation_type}</div>
                    <div><strong>RT:</strong> ${ion.retention_time} min</div>
                    <div><strong>MS/MS:</strong> ${ion.precursor_ion} ‚Üí ${ion.product_ion} m/z</div>
                    <div><strong>Integration:</strong> ${ion.integration_start} - ${ion.integration_end} min</div>
                </div>
            </div>
        `;
    });
    
    ionsSummary.innerHTML = summaryHTML;
    ionsSection.style.display = 'block';
}


// Chart interaction handlers
function resetZoom(lipidId) {
    if (chartInstances[lipidId]) {
        if (chartInstances[lipidId].chart1) {
            chartInstances[lipidId].chart1.resetZoom();
        }
        if (chartInstances[lipidId].chart2) {
            chartInstances[lipidId].chart2.resetZoom();
            
            // Reapply individual zoom settings after reset
            setTimeout(() => {
                if (individualZoomSettings[lipidId]) {
                    applyIndividualZoom(lipidId);
                }
            }, 100);
        }
    }
}

// Keyboard shortcuts for zoom control
document.addEventListener('keydown', function(e) {
    if (e.key === 'r' || e.key === 'R') {
        // Reset all charts zoom and reapply admin settings
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    } else if (e.key === '0') {
        // Reset all charts zoom with 0 key and reapply admin settings
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    }
});

// Double-click to reset zoom on individual charts
function addDoubleClickReset(lipidId, chartType) {
    const canvas = document.getElementById(`${chartType}-${lipidId}`);
    if (canvas) {
        canvas.addEventListener('dblclick', function() {
            if (chartInstances[lipidId] && chartInstances[lipidId][chartType]) {
                chartInstances[lipidId][chartType].resetZoom();
                
                // Reapply individual zoom settings for Chart 2
                if (chartType === 'chart2') {
                    setTimeout(() => {
                        if (individualZoomSettings[lipidId]) {
                            applyIndividualZoom(lipidId);
                        }
                    }, 100);
                }
            }
        });
    }
}

// Deactivate chart function
function deactivateChart(chart, canvas) {
    chart.options.plugins.zoom.zoom.wheel.enabled = false;
    chart.options.plugins.zoom.zoom.pinch.enabled = false;
    chart.options.plugins.zoom.zoom.drag.enabled = false;
    chart.options.plugins.zoom.pan.enabled = false;
    canvas.style.border = '';
    canvas.style.borderRadius = '';
    chart.resetZoom();
    chart.update('none');
    
    // Reapply individual zoom settings if this is Chart 2
    const canvasId = canvas.id;
    const matches = canvasId.match(/chart2-(\d+)/);
    if (matches) {
        const lipidId = matches[1];
        setTimeout(() => {
            if (individualZoomSettings[lipidId]) {
                applyIndividualZoom(lipidId);
            }
        }, 100);
    }
}

// Global click handler to deactivate charts when clicking outside
document.addEventListener('click', function(event) {
    if (window.allChartInstances) {
        let clickedOnChart = false;
        
        // Check if click was on any chart canvas
        window.allChartInstances.forEach(({canvas}) => {
            if (canvas.contains(event.target) || canvas === event.target) {
                clickedOnChart = true;
            }
        });
        
        // If clicked outside all charts, deactivate all
        if (!clickedOnChart) {
            window.allChartInstances.forEach(({chart, canvas}) => {
                deactivateChart(chart, canvas);
            });
        }
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('zoom-modal');
    if (event.target === modal) {
        closeZoomModal();
    }
});

// Resize handler
window.addEventListener('resize', function() {
    Object.keys(chartInstances).forEach(lipidId => {
        Object.keys(chartInstances[lipidId]).forEach(chartType => {
            chartInstances[lipidId][chartType].resize();
        });
    });
});
</script>
{% endblock %}