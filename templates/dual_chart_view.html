{% extends "base.html" %}

{% block title %}Interactive Dual Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }
    
    .lipid-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .lipid-title {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 18px;
        color: #2c3e50;
        margin: 0;
    }
    
    .lipid-info {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .info-badge {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    /* Shared legend container */
    .shared-legend {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .legend-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .legend-items {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }
    
    .legend-color {
        width: 16px;
        height: 3px;
        border-radius: 2px;
    }
    
    .legend-color.dashed {
        border: 1px dashed;
        background: none;
        height: 1px;
    }
    
    /* Custom tooltip styling */
    .chartjs-tooltip {
        position: absolute;
        background: rgba(255, 255, 255, 0.98) !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        padding: 12px 15px !important;
        font-size: 13px !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        color: #2c3e50 !important;
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3) !important;
        z-index: 10000 !important;
        pointer-events: none !important;
        line-height: 1.4 !important;
        max-width: 280px !important;
        word-wrap: break-word !important;
        white-space: normal !important;
    }
    
    .chartjs-tooltip::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid #007bff;
    }
    
    .single-chart-container {
        position: relative;
        background: #fafafa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
    }
    
    .chart-canvas {
        position: relative;
        height: 350px;
        cursor: pointer;
    }
    
    .chart-canvas canvas {
        transition: border 0.2s ease;
    }
    
    .chart-canvas canvas:hover {
        border: 1px solid #ccc !important;
    }
    
    .chart-title {
        font-size: 14px;
        font-weight: bold;
        color: #495057;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .loading-state {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        color: #666;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .error-state {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 6px;
        border: 1px solid #f5c6cb;
        text-align: center;
    }
    
    .annotated-ions-section {
        margin-top: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
    }
    
    .section-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .ions-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .ion-item {
        background: white;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        font-size: 12px;
    }
    
    .ion-name {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .ion-details {
        color: #666;
        margin-top: 4px;
    }
    
    .back-button {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #f8f9fa;
        color: #495057;
        text-decoration: none;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        transition: all 0.2s ease;
    }
    
    .back-button:hover {
        background: #e9ecef;
        color: #495057;
        text-decoration: none;
    }
    
    .instructions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 13px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr !important;
        }
        
        .legend-items {
            justify-content: flex-start;
            gap: 15px;
        }
    }
    
    @media (max-width: 768px) {
        .lipid-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .legend-items {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <a href="{{ url_for('clean_dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
    
    <!-- Instructions -->
    <div class="instructions">
        <strong>üìä Dual Chart View:</strong> Chart 1 shows focused view (RT ¬± 0.6 min) | Chart 2 shows full overview (0-16 min)<br>
        <strong>üñ±Ô∏è Interactive:</strong> Hover over colored areas for lipid details | <strong>Click chart to activate zoom</strong> | Mouse wheel to zoom | Shift+drag to pan | Double-click to deactivate zoom
    </div>

    <!-- Charts for each selected lipid -->
    {% for lipid in selected_lipids %}
    <div class="chart-container" id="lipid-container-{{ lipid.lipid_id }}">
        <!-- Lipid Header -->
        <div class="lipid-header">
            <h2 class="lipid-title">{{ lipid.lipid_name }}</h2>
            <div class="lipid-info">
                <span class="info-badge">{{ lipid.class_name }}</span>
                <span class="info-badge">ID: {{ lipid.lipid_id }}</span>
                <span class="info-badge">{{ lipid.annotated_ions_count }} Ions</span>
            </div>
        </div>
        
        <!-- Shared Legend -->
        <div class="shared-legend" id="legend-{{ lipid.lipid_id }}" style="display: none;">
            <div class="legend-title">Chart Legend</div>
            <div class="legend-items" id="legend-items-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Dual Charts Grid -->
        <div class="charts-grid">
            <!-- Chart 1: Focused View -->
            <div class="single-chart-container">
                <div class="chart-title" id="chart1-title-{{ lipid.lipid_id }}">
                    Chart 1: Loading...
                </div>
                <div class="chart-canvas">
                    <canvas id="chart1-{{ lipid.lipid_id }}"></canvas>
                </div>
            </div>
            
            <!-- Chart 2: Full Overview -->
            <div class="single-chart-container">
                <div class="chart-title" id="chart2-title-{{ lipid.lipid_id }}">
                    Chart 2: Loading...
                </div>
                <div class="chart-canvas">
                    <canvas id="chart2-{{ lipid.lipid_id }}"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading-state" id="loading-{{ lipid.lipid_id }}">
            <div>
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Loading dual chart data for {{ lipid.lipid_name }}...</span>
            </div>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="error-{{ lipid.lipid_id }}" style="display: none;">
            <strong>Error loading charts:</strong> 
            <span id="error-message-{{ lipid.lipid_id }}"></span>
        </div>
        
        <!-- Annotated Ions Section -->
        <div class="annotated-ions-section" id="ions-section-{{ lipid.lipid_id }}" style="display: none;">
            <div class="section-title">
                Annotated Ions: <span id="ions-count-{{ lipid.lipid_id }}">0</span>
            </div>
            <div class="ions-summary" id="ions-summary-{{ lipid.lipid_id }}">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// Chart instances storage
const chartInstances = {};
const chartData = {};

// Register Chart.js zoom plugin
Chart.register(ChartZoom);

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    {% for lipid in selected_lipids %}
        initializeDualCharts({{ lipid.lipid_id }});
    {% endfor %}
});

async function initializeDualCharts(lipidId) {
    try {
        // Show loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'flex';
        document.getElementById(`error-${lipidId}`).style.display = 'none';
        
        // Hide charts initially
        const chartsGrid = document.querySelector(`#lipid-container-${lipidId} .charts-grid`);
        chartsGrid.style.display = 'none';
        
        // Fetch dual chart data
        const response = await fetch(`/api/dual-chart-data/${lipidId}`);
        const result = await response.json();
        
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || 'Failed to load chart data');
        }
        
        // Store data
        chartData[lipidId] = result.data;
        
        // Hide loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        
        // Show charts
        chartsGrid.style.display = 'grid';
        
        // Update chart titles
        document.getElementById(`chart1-title-${lipidId}`).textContent = 
            `Chart 1: Focused View (${result.data.lipid_info.chart1_range})`;
        document.getElementById(`chart2-title-${lipidId}`).textContent = 
            `Chart 2: Full Overview (${result.data.lipid_info.chart2_range})`;
        
        // Create both charts
        createChart(lipidId, 'chart1', result.data.chart1);
        createChart(lipidId, 'chart2', result.data.chart2);
        
        // Add double-click reset functionality
        addDoubleClickReset(lipidId, 'chart1');
        addDoubleClickReset(lipidId, 'chart2');
        
        // Create shared legend
        createSharedLegend(lipidId, result.data.chart1.data.datasets);
        
        // Populate annotated ions section
        populateAnnotatedIons(lipidId, result.data.annotated_ions);
        
    } catch (error) {
        console.error(`Error initializing charts for lipid ${lipidId}:`, error);
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        document.getElementById(`error-${lipidId}`).style.display = 'block';
        document.getElementById(`error-message-${lipidId}`).textContent = error.message;
    }
}

function createChart(lipidId, chartType, chartConfig) {
    const canvasId = `${chartType}-${lipidId}`;
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Enhance chart config with JavaScript callbacks for better formatting
    if (chartConfig.options && chartConfig.options.scales && chartConfig.options.scales.y) {
        chartConfig.options.scales.y.ticks = {
            ...chartConfig.options.scales.y.ticks,
            callback: function(value, index) {
                // HIDE the first (lowest) intensity axis number to avoid ugly small numbers
                // but keep the chart drawing exactly as before
                if (index === 0) {
                    return ''; // Hide the first/lowest tick label
                }
                
                // Format remaining numbers normally
                if (value >= 1000) {
                    return value.toExponential(1);
                } else if (value >= 100) {
                    return Math.round(value).toString();
                } else if (value >= 10) {
                    return value.toFixed(1);
                } else {
                    return value.toFixed(2);
                }
            }
        };
    }
    
    // Add zoom and pan functionality - CLICK TO ACTIVATE
    if (!chartConfig.options.plugins) {
        chartConfig.options.plugins = {};
    }
    
    // Store chart active state
    if (!window.activeCharts) {
        window.activeCharts = new Set();
    }
    
    const chartId = `${chartType}-${lipidId}`;
    
    chartConfig.options.plugins.zoom = {
        zoom: {
            wheel: {
                enabled: false,  // Disabled by default
                speed: 0.1
            },
            pinch: {
                enabled: false   // Disabled by default
            },
            drag: {
                enabled: false,  // Disabled by default
                backgroundColor: 'rgba(225, 225, 225, 0.3)'
            },
            mode: 'x'  // Only zoom/pan on X-axis (retention time)
        },
        pan: {
            enabled: false,  // Disabled by default
            mode: 'x',       // Only pan on X-axis
            modifierKey: 'shift'  // Hold shift to pan
        }
    };
    
    // Enhanced tooltip callbacks for targeted lipid information only
    if (chartConfig.options && chartConfig.options.plugins && chartConfig.options.plugins.tooltip) {
        chartConfig.options.plugins.tooltip.external = function(context) {
            // Custom external tooltip - CHART-SPECIFIC to avoid overlapping
            const {chart, tooltip} = context;
            
            // Create chart-specific tooltip ID
            const tooltipId = `chartjs-tooltip-${chartType}-${lipidId}`;
            
            // PRECISE TOOLTIP: Only show for the EXACT integration area being hovered
            let hoveredPoint = null;
            
            if (tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                // Find the specific dataset being hovered within its integration range
                hoveredPoint = tooltip.dataPoints.find(point => {
                    const dataset = point.dataset;
                    return dataset.lipid_info && 
                           !dataset.skip_tooltip && 
                           !dataset.label?.startsWith('_boundary_line') &&
                           dataset.integration_range &&
                           point.parsed.x >= dataset.integration_range.start &&
                           point.parsed.x <= dataset.integration_range.end;
                });
            }
            
            const hasLipidInfo = !!hoveredPoint;
            
            // CRITICAL: Hide ALL other tooltips immediately
            document.querySelectorAll('.chartjs-tooltip').forEach(tip => {
                if (tip.id !== tooltipId) {
                    tip.style.opacity = 0;
                }
            });
            
            // Get or create CHART-SPECIFIC tooltip element
            let tooltipEl = document.getElementById(tooltipId);
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = tooltipId;
                tooltipEl.className = 'chartjs-tooltip';
                tooltipEl.style.cssText = `
                    position: absolute;
                    background: rgba(255, 255, 255, 0.98);
                    border: 2px solid #007bff;
                    border-radius: 8px;
                    padding: 12px 15px;
                    font-size: 13px;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    color: #2c3e50;
                    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                    max-width: 280px;
                    white-space: normal;
                    line-height: 1.4;
                `;
                chart.canvas.parentNode.appendChild(tooltipEl);
            }
            
            // Already handled above
            
            // Hide tooltip if no content, no opacity, or no lipid info
            if (tooltip.opacity === 0 || !hasLipidInfo) {
                tooltipEl.style.opacity = 0;
                return;
            }
            
            // Get canvas position and size
            const canvasRect = chart.canvas.getBoundingClientRect();
            
            // Position tooltip to the right of the cursor, but ensure it stays within bounds
            let left = tooltip.caretX + 25; // 25px to the right of cursor
            let top = tooltip.caretY - 20;  // Slightly above cursor
            
            // Adjust if tooltip would go off the right edge
            if (left + 280 > canvasRect.width) {
                left = tooltip.caretX - 305; // Position to the left instead
            }
            
            // Adjust if tooltip would go off the bottom edge
            if (top + 200 > canvasRect.height) {
                top = canvasRect.height - 200 - 15;
            }
            
            // Adjust if tooltip would go off the top edge
            if (top < 0) {
                top = 15;
            }
            
            tooltipEl.style.left = left + 'px';
            tooltipEl.style.top = top + 'px';
            tooltipEl.style.opacity = 1;
            
            // Set STATIC tooltip content - ONLY for integration areas, NO dynamic RT info
            if (hoveredPoint && hoveredPoint.dataset.lipid_info) {
                const info = hoveredPoint.dataset.lipid_info;
                const tooltipContent = [
                    `<strong>Lipid name:</strong> ${info.lipid_name}`,
                    `<strong>Lipid class:</strong> ${info.lipid_class}`,
                    `<strong>Retention time:</strong> ${info.retention_time}`,
                    `<strong>Integration start:</strong> ${info.integration_start}`,
                    `<strong>Integration end:</strong> ${info.integration_end}`,
                    `<strong>Precursor mass:</strong> ${info.precursor_mass}`,
                    `<strong>Product mass:</strong> ${info.product_mass}`,
                    `<strong>Annotation:</strong> ${info.annotation}`
                ].join('<br>');
                
                tooltipEl.innerHTML = tooltipContent;
            } else {
                tooltipEl.style.opacity = 0; // Hide if not hovering over integration area
            }
        };
        
        // DISABLE all default tooltips - we only want static lipid info tooltips
        chartConfig.options.plugins.tooltip.enabled = false;
    }
    
    // Store chart instance
    if (!chartInstances[lipidId]) {
        chartInstances[lipidId] = {};
    }
    
    const chart = new Chart(ctx, chartConfig);
    chartInstances[lipidId][chartType] = chart;
    
    // Add click-to-activate zoom functionality
    ctx.canvas.addEventListener('click', function() {
        // Activate zoom for this chart
        chart.options.plugins.zoom.zoom.wheel.enabled = true;
        chart.options.plugins.zoom.zoom.pinch.enabled = true;
        chart.options.plugins.zoom.zoom.drag.enabled = true;
        chart.options.plugins.zoom.pan.enabled = true;
        
        // Add visual indicator that chart is active
        ctx.canvas.style.border = '2px solid #007bff';
        ctx.canvas.style.borderRadius = '4px';
        
        // Deactivate other charts
        Object.keys(chartInstances).forEach(lid => {
            Object.keys(chartInstances[lid]).forEach(ctype => {
                if (lid != lipidId || ctype != chartType) {
                    const otherChart = chartInstances[lid][ctype];
                    otherChart.options.plugins.zoom.zoom.wheel.enabled = false;
                    otherChart.options.plugins.zoom.zoom.pinch.enabled = false;
                    otherChart.options.plugins.zoom.zoom.drag.enabled = false;
                    otherChart.options.plugins.zoom.pan.enabled = false;
                    otherChart.canvas.style.border = '';
                    otherChart.canvas.style.borderRadius = '';
                }
            });
        });
        
        chart.update('none');
    });
    
    // Add double-click to deactivate
    ctx.canvas.addEventListener('dblclick', function() {
        deactivateChart(chart, ctx.canvas);
    });
    
    // Store chart reference for global deactivation
    if (!window.allChartInstances) {
        window.allChartInstances = [];
    }
    window.allChartInstances.push({chart: chart, canvas: ctx.canvas});
}

function createSharedLegend(lipidId, datasets) {
    const legendContainer = document.getElementById(`legend-items-${lipidId}`);
    const legendSection = document.getElementById(`legend-${lipidId}`);
    
    if (!legendContainer || !datasets) return;
    
    let legendHTML = '';
    
    // Add main chromatogram line
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color" style="background-color: #1f77b4;"></div>
            <span>Chromatogram</span>
        </div>
    `;
    
    // Add integration areas (skip boundary lines and chromatogram)
    datasets.forEach(dataset => {
        if (dataset.label !== 'Chromatogram' && 
            !dataset.label.startsWith('_boundary_line') && 
            dataset.lipid_info) {
            
            const color = dataset.borderColor || '#40E0D0';
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${color}; opacity: 0.3;"></div>
                    <span>${dataset.lipid_info.lipid_name} (${dataset.lipid_info.annotation})</span>
                </div>
            `;
        }
    });
    
    // Add boundary lines
    legendHTML += `
        <div class="legend-item">
            <div class="legend-color dashed" style="border-color: rgba(70, 130, 180, 0.9);"></div>
            <span>Integration Boundaries</span>
        </div>
    `;
    
    legendContainer.innerHTML = legendHTML;
    legendSection.style.display = 'block';
}

function populateAnnotatedIons(lipidId, annotatedIons) {
    const ionsSection = document.getElementById(`ions-section-${lipidId}`);
    const ionsCount = document.getElementById(`ions-count-${lipidId}`);
    const ionsSummary = document.getElementById(`ions-summary-${lipidId}`);
    
    if (!annotatedIons || annotatedIons.length === 0) {
        ionsSection.style.display = 'none';
        return;
    }
    
    // Update count
    ionsCount.textContent = annotatedIons.length;
    
    // Build ions summary
    let summaryHTML = '';
    annotatedIons.forEach(ion => {
        const borderColor = ion.color || '#007bff';
        
        summaryHTML += `
            <div class="ion-item" style="border-left-color: ${borderColor};">
                <div class="ion-name">${ion.lipid_name}</div>
                <div class="ion-details">
                    <div><strong>Type:</strong> ${ion.annotation_type}</div>
                    <div><strong>RT:</strong> ${ion.retention_time} min</div>
                    <div><strong>MS/MS:</strong> ${ion.precursor_ion} ‚Üí ${ion.product_ion} m/z</div>
                    <div><strong>Integration:</strong> ${ion.integration_start} - ${ion.integration_end} min</div>
                </div>
            </div>
        `;
    });
    
    ionsSummary.innerHTML = summaryHTML;
    ionsSection.style.display = 'block';
}

// Chart interaction handlers
function resetZoom(lipidId) {
    if (chartInstances[lipidId]) {
        if (chartInstances[lipidId].chart1) {
            chartInstances[lipidId].chart1.resetZoom();
        }
        if (chartInstances[lipidId].chart2) {
            chartInstances[lipidId].chart2.resetZoom();
        }
    }
}

// Keyboard shortcuts for zoom control
document.addEventListener('keydown', function(e) {
    if (e.key === 'r' || e.key === 'R') {
        // Reset all charts zoom
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    } else if (e.key === '0') {
        // Reset all charts zoom with 0 key
        Object.keys(chartInstances).forEach(lipidId => {
            resetZoom(lipidId);
        });
    }
});

// Double-click to reset zoom on individual charts
function addDoubleClickReset(lipidId, chartType) {
    const canvas = document.getElementById(`${chartType}-${lipidId}`);
    if (canvas) {
        canvas.addEventListener('dblclick', function() {
            if (chartInstances[lipidId] && chartInstances[lipidId][chartType]) {
                chartInstances[lipidId][chartType].resetZoom();
            }
        });
    }
}

// Deactivate chart function
function deactivateChart(chart, canvas) {
    chart.options.plugins.zoom.zoom.wheel.enabled = false;
    chart.options.plugins.zoom.zoom.pinch.enabled = false;
    chart.options.plugins.zoom.zoom.drag.enabled = false;
    chart.options.plugins.zoom.pan.enabled = false;
    canvas.style.border = '';
    canvas.style.borderRadius = '';
    chart.resetZoom();
    chart.update('none');
}

// Global click handler to deactivate charts when clicking outside
document.addEventListener('click', function(event) {
    if (window.allChartInstances) {
        let clickedOnChart = false;
        
        // Check if click was on any chart canvas
        window.allChartInstances.forEach(({canvas}) => {
            if (canvas.contains(event.target) || canvas === event.target) {
                clickedOnChart = true;
            }
        });
        
        // If clicked outside all charts, deactivate all
        if (!clickedOnChart) {
            window.allChartInstances.forEach(({chart, canvas}) => {
                deactivateChart(chart, canvas);
            });
        }
    }
});

// Resize handler
window.addEventListener('resize', function() {
    Object.keys(chartInstances).forEach(lipidId => {
        Object.keys(chartInstances[lipidId]).forEach(chartType => {
            chartInstances[lipidId][chartType].resize();
        });
    });
});
</script>
{% endblock %}