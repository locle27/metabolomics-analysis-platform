{% extends "base.html" %}

{% block title %}NIST/Agilent Calculation Tool - Metabolomics Platform{% endblock %}

{% block extra_css %}
<style>
    /* Override any Bootstrap container constraints */
    body {
        overflow-x: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .container-fluid {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    .tool-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 40px;
        margin-top: 30px;
    }
    
    .formula-section {
        background: #f8f9fa;
        border-left: 4px solid var(--primary-blue);
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 5px;
    }
    
    .formula-title {
        color: var(--primary-blue);
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .formula-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    /* Detailed Calculation Section Styles */
    .calculation-details-section {
        margin-top: 30px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: #f8f9fa;
    }
    
    .details-header {
        padding: 0;
    }
    
    .details-toggle-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-orange));
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
    }
    
    .details-toggle-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(46, 76, 146, 0.3);
    }
    
    .details-content {
        padding: 20px;
        background: white;
        margin: 10px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .details-explanation h4,
    .data-sources h4,
    .calculation-steps h4 {
        color: var(--primary-blue);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .explanation-grid,
    .source-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .explanation-card,
    .source-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-orange);
    }
    
    .explanation-card h5,
    .source-card h5 {
        color: var(--primary-blue);
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .formula-box {
        background: #e8f4f8;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        border-left: 3px solid var(--primary-blue);
    }
    
    .formula-box code {
        background: none;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 14px;
    }
    
    .steps-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .step-card {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease;
    }
    
    .step-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .step-number {
        background: var(--primary-blue);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .step-content h5 {
        color: var(--primary-blue);
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .step-content code {
        background: #e8f4f8;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        color: var(--primary-blue);
    }
    
    .step-content small {
        color: #666;
        font-style: italic;
    }
    
    .sample-calculation {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 30px;
        margin: 0;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }
    
    .sample-calculation h4 {
        color: var(--primary-blue);
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 20px;
    }
    
    .sample-calculation p {
        color: #6c757d;
        margin-bottom: 25px;
        font-size: 14px;
    }
    
    .calculation-breakdown {
        background: white;
        padding: 0;
        border-radius: 8px;
        margin-top: 0;
        border: 1px solid #e9ecef;
        overflow: hidden;
    }
    
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #f1f3f5;
        transition: background-color 0.2s ease;
    }
    
    .breakdown-row:hover {
        background-color: #f8f9fa;
    }
    
    .breakdown-row:last-child {
        border-bottom: none;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-orange));
        color: white;
        margin: 0;
        padding: 20px;
    }
    
    .breakdown-row:last-child .breakdown-label,
    .breakdown-row:last-child .breakdown-value {
        color: white;
    }
    
    .breakdown-label {
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }
    
    .breakdown-value {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 14px;
    }
    
    .compound-search-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .compound-search-section h5 {
        color: var(--primary-blue);
        margin-bottom: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .search-input-container {
        position: relative;
        margin-bottom: 10px;
    }
    
    .compound-search-input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .compound-search-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(46, 76, 146, 0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 16px;
    }
    
    .compound-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .compound-option {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f1f3f5;
        transition: background-color 0.2s ease;
        font-size: 14px;
    }
    
    .compound-option:hover {
        background-color: #f8f9fa;
    }
    
    .compound-option:last-child {
        border-bottom: none;
    }
    
    .compound-option.selected {
        background-color: var(--primary-blue);
        color: white;
    }
    
    .search-info {
        color: #6c757d;
        font-size: 12px;
        font-style: italic;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .explanation-grid,
        .source-grid,
        .steps-container {
            grid-template-columns: 1fr;
        }
    }
    
    .upload-section {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: border-color 0.3s ease;
    }
    
    .upload-section:hover {
        border-color: var(--primary-orange);
    }
    
    .upload-icon {
        font-size: 48px;
        color: var(--primary-blue);
        margin-bottom: 20px;
    }
    
    .file-input {
        display: none;
    }
    
    .upload-btn {
        background: var(--primary-orange);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }
    
    .upload-btn:hover {
        background: #d74400;
    }
    
    .coefficient-input {
        max-width: 300px;
        margin: 0 auto 30px;
    }
    
    .process-btn {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        transition: background 0.3s ease;
        display: none;
    }
    
    .process-btn:hover {
        background: #253f7a;
    }
    
    .process-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .file-info {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-radius: 5px;
        display: none;
    }
    
    .loading-spinner {
        display: none;
        margin: 20px auto;
        text-align: center;
    }
    
    .error-message {
        color: #dc3545;
        margin-top: 10px;
        display: none;
    }
    
    .success-message {
        color: #28a745;
        margin-top: 10px;
        display: none;
    }
    
    .preview-section {
        display: none;
        margin-top: 30px;
    }
    
    .preview-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }
    
    .preview-tab {
        background: none;
        border: none;
        padding: 10px 20px;
        margin-right: 10px;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .preview-tab.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
    }
    
    .preview-content {
        max-height: 400px;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        background: #f8f9fa;
    }
    
    .preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .preview-table th,
    .preview-table td {
        padding: 8px;
        text-align: left;
        border: 1px solid #dee2e6;
        background: white;
    }
    
    .preview-table th {
        background: var(--primary-blue);
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .compound-name {
        font-weight: 500;
        color: var(--phenikaa-dark-blue);
    }
    
    .preview-table tr:hover td {
        background: #f1f3f5;
    }
    
    .download-section {
        display: none;
        margin-top: 20px;
        text-align: center;
    }
    
    .download-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin: 0 10px;
        transition: background 0.3s ease;
    }
    
    .download-btn:hover {
        background: #218838;
    }
    
    .recalculate-btn {
        background: var(--primary-orange);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin: 0 10px;
        transition: background 0.3s ease;
    }
    
    .recalculate-btn:hover {
        background: #d74400;
    }
    
    .requirements-list {
        text-align: left;
        margin: 20px auto;
        max-width: 600px;
    }
    
    .requirements-list li {
        margin-bottom: 8px;
    }

    /* Professional quality indicator styles for NIST table */
    .high-quality {
        background-color: #f8f9fa !important;
        color: #495057;
        font-weight: 600;
        border-left: 3px solid #28a745;
    }
    
    .medium-quality {
        background-color: #f8f9fa !important;
        color: #495057;
        font-weight: 500;
        border-left: 3px solid #ffc107;
    }
    
    .low-quality {
        background-color: #f8f9fa !important;
        color: #495057;
        font-weight: 500;
        border-left: 3px solid #dc3545;
    }
    
    .compound-header {
        background: #6c757d !important;
        color: white !important;
        font-weight: 600;
    }
    
    .sample-header {
        background: #495057 !important;
        color: white !important;
        font-weight: 500;
        font-size: 12px;
    }
    
    .compound-name {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        border-right: 2px solid #dee2e6;
    }
    
    .preview-table {
        width: 100%;
        font-size: 13px;
    }
    
    .preview-table td {
        padding: 8px 12px;
        text-align: center;
        vertical-align: middle;
    }
    
    .preview-table th {
        padding: 12px 8px;
        text-align: center;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* Search template styling */
    .search-templates {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
    }
    
    .template-buttons .btn {
        font-size: 12px;
        padding: 6px 12px;
        border-width: 1px;
        transition: all 0.2s ease;
    }
    
    .template-buttons .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .compound-search-input {
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
    }
    
    .compound-search-input:focus {
        border-color: #6c757d;
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    }
    
    /* Less colorful alert styles */
    .alert-info {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #495057;
    }
    
    .alert-info .alert-heading {
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0" style="width: 100vw; margin: 0; padding: 0;">
    <div class="row g-0">
        <div class="col-12">
            <div class="tool-container" style="margin: 20px; padding: 30px; border-radius: 10px;">
                <h1 class="text-center text-metabolomics-blue mb-4">NIST/Agilent Calculation Tool</h1>
                
                <!-- Formula Section -->
                <div class="formula-section">
                    <h3 class="formula-title">Calculation Formulas</h3>
                    <div class="formula-item">
                        <strong>Step 1 - Ratio:</strong> Area of Compound / Area of Internal Standard (ISTD)
                    </div>
                    <div class="formula-item">
                        <strong>Step 2 - NIST:</strong> Ratio / NIST value (from ratio sheet)
                    </div>
                    <div class="formula-item">
                        <strong>Step 3 - Agilent:</strong> Ratio × Conc.(nM) × Response Factor × Coefficient
                    </div>
                </div>
                
                <!-- Upload Section -->
                <form id="calculationForm" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="upload-section" id="uploadSection">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4 class="mb-3">Upload Excel File</h4>
                        <p class="text-muted mb-4">Select your Excel file containing the following sheets:</p>
                        <ul class="requirements-list">
                            <li><strong>Compound Index</strong> - Contains compound names, ISTD mappings, concentrations, and response factors</li>
                            <li><strong>Ratio</strong> - Contains NIST ratio values for each compound/sample</li>
                            <li><strong>Area</strong> - Contains peak area data for all compounds and samples</li>
                        </ul>
                        <input type="file" id="excelFile" name="excel_file" class="file-input" accept=".xlsx,.xls">
                        <button type="button" class="upload-btn" onclick="document.getElementById('excelFile').click()">
                            <i class="fas fa-folder-open"></i> Choose File
                        </button>
                        <div class="file-info" id="fileInfo"></div>
                    </div>
                    
                    <!-- Coefficient Input -->
                    <div class="coefficient-input">
                        <label for="coefficient" class="form-label">Coefficient Value:</label>
                        <input type="number" class="form-control" id="coefficient" name="coefficient" value="500" step="any" required>
                        <small class="text-muted">Enter the coefficient for Agilent calculation (default: 500)</small>
                    </div>
                    
                    <!-- Process Button -->
                    <div class="text-center">
                        <button type="submit" class="process-btn" id="processBtn">
                            <i class="fas fa-cog"></i> Process Calculations
                        </button>
                    </div>
                    
                    <!-- Loading and Messages -->
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2">Processing your file...</p>
                    </div>
                    
                    <div class="error-message" id="errorMessage"></div>
                    <div class="success-message" id="successMessage"></div>
                </form>
                
                <!-- Preview Section -->
                <div class="preview-section" id="previewSection">
                    <h3 class="text-center mb-4">Calculation Results Preview</h3>
                    
                    <div class="preview-tabs">
                        <button class="preview-tab active" onclick="showTab('nist')">NIST Results</button>
                        <button class="preview-tab" onclick="showTab('agilent')">Agilent Results</button>
                        <button class="preview-tab" onclick="showTab('ratio')">Sample Normalization</button>
                    </div>
                    
                    <div class="preview-content">
                        <div id="nistPreview" class="tab-content">
                            <!-- NIST table will be inserted here -->
                        </div>
                        <div id="agilentPreview" class="tab-content" style="display: none;">
                            <!-- Agilent table will be inserted here -->
                        </div>
                        <div id="ratioPreview" class="tab-content" style="display: none;">
                            <!-- Ratio matrix table will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="download-section">
                        <button class="download-btn" onclick="downloadResults()">
                            <i class="fas fa-download"></i> Download Excel File
                        </button>
                        <button class="recalculate-btn" onclick="resetCalculator()">
                            <i class="fas fa-redo"></i> Calculate Another File
                        </button>
                    </div>
                    
                    <!-- Ratio Analysis Info -->
                    <div class="ratio-info-section" style="margin-top: 20px;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line me-2"></i>Sample Normalization Analysis</h6>
                            <p class="mb-0">View the complete sample normalization showing Sample Ratio, NIST Ratio, and normalized results in the "Sample Normalization" tab above.</p>
                        </div>
                    </div>
                    
                    <!-- Detailed Calculation Preview Section -->
                    <div class="calculation-details-section" id="calculationDetailsSection">
                        <div class="details-header">
                            <button class="details-toggle-btn" onclick="toggleCalculationDetails()">
                                <i class="fas fa-calculator"></i> 
                                <span id="detailsToggleText">Show Detailed Calculation Breakdown</span>
                                <i class="fas fa-chevron-down" id="detailsToggleIcon"></i>
                            </button>
                        </div>
                        
                        <div class="details-content" id="calculationDetailsContent" style="display: none;">
                            <!-- Compound Search Section -->
                            <div class="compound-search-section" id="compoundSearchSection" style="display: none;">
                                <h5><i class="fas fa-search"></i> Search Compound</h5>
                                
                                <!-- Search Templates -->
                                <div class="search-templates mb-3">
                                    <h6 class="small text-muted mb-2"><i class="fas fa-templates me-1"></i>Quick Search Templates:</h6>
                                    <div class="template-buttons">
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('AcylCarnitine')">
                                            <i class="fas fa-molecule me-1"></i>AcylCarnitine
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('TG')">
                                            <i class="fas fa-flask me-1"></i>Triacylglycerol (TG)
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('PC')">
                                            <i class="fas fa-atom me-1"></i>Phosphatidylcholine (PC)
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('PE')">
                                            <i class="fas fa-dna me-1"></i>Phosphatidylethanolamine (PE)
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('SM')">
                                            <i class="fas fa-ring me-1"></i>Sphingomyelin (SM)
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="searchTemplate('Cer')">
                                            <i class="fas fa-circle-nodes me-1"></i>Ceramide (Cer)
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm me-2 mb-2" onclick="searchTemplate('LPC')">
                                            <i class="fas fa-droplet me-1"></i>Lysophosphatidylcholine (LPC)
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm me-2 mb-2" onclick="searchTemplate('LPE')">
                                            <i class="fas fa-water me-1"></i>Lysophosphatidylethanolamine (LPE)
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm me-2 mb-2" onclick="searchTemplate('FA')">
                                            <i class="fas fa-chain-broken me-1"></i>Fatty Acid (FA)
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm me-2 mb-2" onclick="searchTemplate('MAG')">
                                            <i class="fas fa-hexagon me-1"></i>Monoacylglycerol (MAG)
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="searchTemplate('d7')">
                                            <i class="fas fa-star me-1"></i>Internal Standards (d7)
                                        </button>
                                        <button type="button" class="btn btn-outline-dark btn-sm me-2 mb-2" onclick="clearSearch()">
                                            <i class="fas fa-times me-1"></i>Clear Search
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="search-input-container">
                                    <input type="text" 
                                           id="compoundSearchInput" 
                                           class="compound-search-input" 
                                           placeholder="Type compound name or use templates above..." 
                                           autocomplete="off">
                                    <i class="fas fa-search search-icon"></i>
                                    <div id="compoundDropdown" class="compound-dropdown">
                                        <!-- Compound options will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div class="search-info" id="searchInfo">
                                    <!-- Search info will be updated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="sample-calculation" id="sampleCalculationBreakdown">
                                <!-- Sample calculation will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables to store results
let calculationResults = null;
let availableCompounds = [];
let currentUploadedData = null;

// Tab switching
function showTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.preview-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide content
    document.getElementById('nistPreview').style.display = tabName === 'nist' ? 'block' : 'none';
    document.getElementById('agilentPreview').style.display = tabName === 'agilent' ? 'block' : 'none';
    document.getElementById('ratioPreview').style.display = tabName === 'ratio' ? 'block' : 'none';
}

// Create enhanced preview table with quality indicators and NIST ratios
function createPreviewTable(data, totalRows = null, tableType = 'standard') {
    if (!data || data.length === 0) return '<p>No data available</p>';
    
    const headers = Object.keys(data[0]);
    
    // Enhanced header for NIST table
    let html = '';
    if (tableType === 'nist') {
        html += `
            <div class="mb-3">
                <h5 class="text-muted"><i class="fas fa-table me-2"></i>NIST Results with Database Ratio Standards</h5>
                <div class="row">
                    <div class="col-md-8">
                        <div class="border border-secondary rounded p-3 bg-light" role="alert">
                            <i class="fas fa-database me-2 text-muted"></i>
                            <strong>Database Standards:</strong> Values calculated using permanent ratio standards from Ratio-database.xlsx. 
                            Each compound uses its specific database reference ratio for normalization.
                        </div>
                    </div>
                    <div class="col-md-4 text-end d-flex align-items-center justify-content-end gap-2">
                        <span class="badge bg-secondary p-2">Standards Active</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showNistRatioInfo()" title="View NIST ratio information">
                            <i class="fas fa-info-circle me-1"></i>Details
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '<div class="table-responsive"><table class="preview-table"><thead><tr>';
    
    // Headers with enhanced styling for NIST table
    headers.forEach(header => {
        if (header === 'Compound') {
            html += `<th class="compound-header"><i class="fas fa-molecule me-1"></i>${header}</th>`;
        } else {
            // Add quality indicator for sample columns
            const qualityBadge = tableType === 'nist' ? ' <span class="badge bg-primary ms-1">Q✓</span>' : '';
            html += `<th class="sample-header">${header}${qualityBadge}</th>`;
        }
    });
    html += '</tr></thead><tbody>';
    
    // Data rows with enhanced formatting
    for (let i = 0; i < data.length; i++) {
        html += '<tr>';
        headers.forEach((header, index) => {
            const value = data[i][header] || '';
            
            if (header === 'Compound') {
                html += `<td class="compound-name">${value}</td>`;
            } else {
                // Format numerical values with quality indicator
                if (typeof value === 'number' || (!isNaN(parseFloat(value)) && isFinite(value))) {
                    const numValue = parseFloat(value);
                    let qualityClass = '';
                    let qualityIcon = '';
                    
                    if (tableType === 'nist') {
                        // Get NIST standard for this compound to show in tooltip
                        const compoundName = data[i]['Compound'];
                        const nistStandard = (calculationResults && calculationResults.nist_standards && 
                                             calculationResults.nist_standards[compoundName]) ? 
                                             calculationResults.nist_standards[compoundName].nist_standard : null;
                        
                        // Add quality indicators based on value ranges (subtle professional style)
                        if (numValue >= 2.0) {
                            qualityClass = 'high-quality';
                            qualityIcon = '<span class="badge badge-sm bg-success me-1" title="High Quality">H</span>';
                        } else if (numValue >= 1.0) {
                            qualityClass = 'medium-quality';
                            qualityIcon = '<span class="badge badge-sm bg-warning me-1" title="Medium Quality">M</span>';
                        } else if (numValue > 0) {
                            qualityClass = 'low-quality';
                            qualityIcon = '<span class="badge badge-sm bg-secondary me-1" title="Low Quality">L</span>';
                        }
                        
                        // Add tooltip with NIST standard ratio information
                        const tooltipTitle = nistStandard ? 
                            `NIST Result: ${numValue.toFixed(4)}\\nDatabase Ratio: ${nistStandard.toFixed(4)}\\nFormula: Sample Ratio ÷ Database Ratio` :
                            `NIST Result: ${numValue.toFixed(4)}\\nUsing database reference standards`;
                        
                        html += `<td class="${qualityClass}" title="${tooltipTitle}" style="cursor: help;">
                                    ${qualityIcon}${numValue.toFixed(4)}
                                    ${nistStandard ? `<div class="small text-muted">DB: ${nistStandard.toFixed(4)}</div>` : ''}
                                 </td>`;
                    } else {
                        html += `<td>${numValue.toFixed(4)}</td>`;
                    }
                } else {
                    html += `<td>${value}</td>`;
                }
            }
        });
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    
    if (totalRows && totalRows > data.length) {
        html += `<div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i> 
            Preview shows first ${data.length} of ${totalRows} rows. Download Excel file for complete results.
        </div>`;
    }
    
    return html;
}

// Reset calculator
function resetCalculator() {
    document.getElementById('calculationForm').reset();
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('processBtn').style.display = 'none';
    document.getElementById('previewSection').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
    
    // Restore hidden sections for multiple file processing
    document.querySelector('.upload-section').style.display = 'block';
    document.querySelector('.coefficient-input').style.display = 'block';
    
    // Ensure process button is enabled and loading spinner is hidden
    document.getElementById('processBtn').disabled = false;
    const loadingSpinner = document.querySelector('.loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
    }
    
    calculationResults = null;
}

// Download results
function downloadResults() {
    if (!calculationResults) return;
    
    if (calculationResults === 'large_file') {
        // Large file - download via separate endpoint
        window.location.href = '/protocols/download-excel';
    } else {
        // Small file - download from blob
        const url = window.URL.createObjectURL(calculationResults);
        const a = document.createElement('a');
        a.href = url;
        a.download = window.downloadFilename || `calculation_results_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
}

// Generate ratio matrix table
function generateRatioMatrix(result) {
    try {
        // Generate sample ratio data from the results
        const ratioData = [];
        
        // Take first few compounds and samples for the ratio matrix
        const nistData = result.nist_data || [];
        const maxCompounds = Math.min(nistData.length, 10); // Show first 10 compounds
        
        if (maxCompounds > 0) {
            // Get sample columns (exclude 'Compound' column)
            const sampleColumns = Object.keys(nistData[0]).filter(key => key !== 'Compound').slice(0, 5); // Show first 5 samples
            
            for (let i = 0; i < maxCompounds; i++) {
                const compound = nistData[i];
                const compoundName = compound.Compound || `Compound_${i+1}`;
                
                for (const sampleCol of sampleColumns) {
                    // Get actual NIST result from the calculated data
                    const nistResult = compound[sampleCol] || 0;
                    
                    // For Sample Normalization display, we need to show the reverse calculation
                    // Since NIST Result = Sample Ratio ÷ NIST Standard
                    // We can display: Sample Ratio ≈ NIST Result × NIST Standard (estimated)
                    // But the actual important value is the final NIST Result
                    
                    ratioData.push({
                        Compound: compoundName,
                        Sample: sampleCol,
                        Sample_Ratio: 'Calculated',  // Don't show confusing intermediate values
                        NIST_Standard: 'Database',   // NIST standards come from database
                        NIST_Result: typeof nistResult === 'number' ? nistResult.toFixed(4) : nistResult
                    });
                }
            }
        }
        
        // Create ratio matrix table HTML
        let html = '';
        if (ratioData.length > 0) {
            html = `
                <div style="margin-bottom: 15px;">
                    <h6><i class="fas fa-table me-2"></i>Sample Normalization (Sample vs NIST)</h6>
                    <p class="text-muted small">Showing normalized ratios for compounds relative to NIST standards</p>
                </div>
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Compound</th>
                            <th>Sample</th>
                            <th>Sample Ratio</th>
                            <th>NIST Standard</th>
                            <th>Final Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            ratioData.forEach(row => {
                html += `
                    <tr>
                        <td class="compound-name">${row.Compound}</td>
                        <td style="font-family: monospace; color: #555;">${row.Sample}</td>
                        <td style="font-family: monospace; color: #666;">${row.Sample_Ratio}</td>
                        <td style="font-family: monospace; color: #666;">${row.NIST_Standard}</td>
                        <td style="font-family: monospace; font-weight: bold; color: #E94B00;">${row.NIST_Result}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div class="alert alert-info mt-3" style="font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> 
                    Normalization shows ${ratioData.length} compound-sample combinations. Download Excel for complete data.
                </div>
            `;
        } else {
            html = '<p class="text-muted">No ratio data available</p>';
        }
        
        document.getElementById('ratioPreview').innerHTML = html;
        
    } catch (error) {
        console.error('Error generating sample normalization:', error);
        document.getElementById('ratioPreview').innerHTML = '<p class="text-danger">Error generating sample normalization</p>';
    }
}

// File upload handling
document.getElementById('excelFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('fileInfo').innerHTML = `
            <i class="fas fa-file-excel text-success"></i> 
            <strong>${file.name}</strong> 
            <span class="text-muted">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
        `;
        document.getElementById('processBtn').style.display = 'inline-block';
    }
});

// Form submission
document.getElementById('calculationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('excelFile');
    const coefficientInput = document.getElementById('coefficient');
    const loadingSpinner = document.querySelector('.loading-spinner');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const processBtn = document.getElementById('processBtn');
    
    // Reset messages
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    // Validate file
    if (!fileInput.files[0]) {
        errorMessage.textContent = 'Please select an Excel file';
        errorMessage.style.display = 'block';
        return;
    }
    
    // Show loading
    loadingSpinner.style.display = 'block';
    processBtn.disabled = true;
    
    // Prepare form data
    const formData = new FormData();
    formData.append('excel_file', fileInput.files[0]);
    formData.append('coefficient', coefficientInput.value);
    
    try {
        // Get CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);
        
        const response = await fetch('/protocols/calculate', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            console.log('🔍 Full server response received:', result);
            console.log('🔍 sample_breakdown in response:', result.sample_breakdown);
            
            if (result.success) {
                // Handle small vs large files differently
                if (result.large_file) {
                    // Large file - will download via separate endpoint
                    calculationResults = 'large_file';  // Flag for download function
                } else {
                    // Small file - included in response
                    const binaryString = atob(result.excel_file);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    calculationResults = new Blob([bytes], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                }
                
                // Store filename for download
                window.downloadFilename = result.filename;
                
                // Display enhanced preview with quality indicators
                document.getElementById('nistPreview').innerHTML = createPreviewTable(result.nist_data, result.total_rows, 'nist');
                document.getElementById('agilentPreview').innerHTML = createPreviewTable(result.agilent_data, result.total_rows, 'agilent');
                
                // Generate and display ratio matrix
                generateRatioMatrix(result);
                
                // Store uploaded data for compound search feature
                currentUploadedData = result;
                if (result.sample_breakdown && result.sample_breakdown.available_compounds) {
                    availableCompounds = result.sample_breakdown.available_compounds;
                    console.log(`📊 Loaded ${availableCompounds.length} compounds for search`);
                }
                
                // Update sample calculation breakdown with real uploaded data
                console.log('🔍 Before calling generateSampleCalculation, result.sample_breakdown:', result.sample_breakdown);
                if (result.sample_breakdown) {
                    generateSampleCalculation(result);
                } else {
                    console.log('⚠️ No sample_breakdown in result. Available keys:', Object.keys(result));
                    // Still call it for debugging
                    generateSampleCalculation(result);
                }
                
                // Show preview section
                document.getElementById('previewSection').style.display = 'block';
                document.querySelector('.download-section').style.display = 'block';
                
                // Hide form section
                document.querySelector('.upload-section').style.display = 'none';
                document.querySelector('.coefficient-input').style.display = 'none';
                document.getElementById('processBtn').style.display = 'none';
                
                let message = 'Calculations completed successfully!';
                if (result.large_file) {
                    message += ` Large file (${Math.round(result.total_rows * 197 / 1000)}k cells) ready for download.`;
                }
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                
                // Scroll to preview
                document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                errorMessage.textContent = result.error || 'An error occurred during processing';
                errorMessage.style.display = 'block';
            }
        } else {
            const error = await response.json();
            errorMessage.textContent = error.error || 'An error occurred during processing';
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        errorMessage.textContent = 'Network error: ' + error.message;
        errorMessage.style.display = 'block';
    } finally {
        loadingSpinner.style.display = 'none';
        processBtn.disabled = false;
    }
});

// Toggle detailed calculation section
function toggleCalculationDetails() {
    const content = document.getElementById('calculationDetailsContent');
    const toggleText = document.getElementById('detailsToggleText');
    const toggleIcon = document.getElementById('detailsToggleIcon');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        toggleText.textContent = 'Hide Detailed Calculation Breakdown';
        toggleIcon.className = 'fas fa-chevron-up';
        
        // Don't regenerate - the calculation should already be there from file processing
        // generateSampleCalculation(); // REMOVED - was causing the second call with null data
    } else {
        content.style.display = 'none';
        toggleText.textContent = 'Show Detailed Calculation Breakdown';
        toggleIcon.className = 'fas fa-chevron-down';
    }
}

// Generate sample calculation breakdown using data from uploaded file
function generateSampleCalculation(uploadedFileData = null) {
    const sampleDiv = document.getElementById('sampleCalculationBreakdown');
    
    console.log('🔍 JavaScript Debug - generateSampleCalculation called');
    console.log('uploadedFileData:', uploadedFileData);
    console.log('sample_breakdown exists:', uploadedFileData?.sample_breakdown);
    
    let sampleData;
    
    // Use actual data from the uploaded file if available
    if (uploadedFileData && uploadedFileData.sample_breakdown) {
        sampleData = uploadedFileData.sample_breakdown;
        console.log('✅ Using uploaded file data:', sampleData);
        console.log(`📊 Detailed data available for ${sampleData.detailed_compounds_count || 0} compounds`);
        
        // Show compound search section if compounds are available
        if (sampleData.available_compounds && sampleData.available_compounds.length > 0) {
            document.getElementById('compoundSearchSection').style.display = 'block';
            setupCompoundSearch(sampleData);
        }
    } else {
        // Fallback to default example
        sampleData = {
            compound: 'First compound from uploaded file',
            sample: 'First sample from uploaded file',
            area: 0,
            istd_area: 212434.0,
            nist_standard: 0.1769,
            concentration: 25.0,
            response_factor: 1.0,
            coefficient: parseInt(document.getElementById('coefficient')?.value) || 500
        };
        console.log('⚠️ Using fallback data - uploadedFileData missing or invalid');
        if (uploadedFileData) {
            console.log('Available keys in uploadedFileData:', Object.keys(uploadedFileData));
        }
    }
    
    // Use pre-calculated values if available, otherwise calculate step by step
    const ratio = sampleData.ratio || (sampleData.area / sampleData.istd_area);
    const nist_result = sampleData.nist_result || (ratio / sampleData.nist_standard);
    const agilent_result = sampleData.agilent_result || (ratio * sampleData.concentration * sampleData.response_factor * sampleData.coefficient);
    
    const html = `
        <h4>Sample Calculation Breakdown</h4>
        <p><strong>Example:</strong> ${sampleData.compound} (First compound from uploaded data) in ${sampleData.sample} (First sample)</p>
        
        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
            <strong>Debug Info:</strong><br>
            Data Source: ${uploadedFileData && uploadedFileData.sample_breakdown ? '✅ Real uploaded data' : '⚠️ Fallback data'}<br>
            Current Compound: ${sampleData.compound}<br>
            Area Value: ${sampleData.area} (${typeof sampleData.area})<br>
            ${sampleData.istd_name ? `ISTD: ${sampleData.istd_name}<br>` : ''}
            ${uploadedFileData?.sample_breakdown?.detailed_compounds_count ? `Detailed data available for first ${uploadedFileData.sample_breakdown.detailed_compounds_count} compounds` : ''}
        </div>
        
        <div class="calculation-breakdown">
            <div class="breakdown-row">
                <span class="breakdown-label">Raw Compound Area</span>
                <span class="breakdown-value">${sampleData.area.toLocaleString()}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Internal Standard (ISTD) Area</span>
                <span class="breakdown-value">${sampleData.istd_area.toLocaleString()}</span>
            </div>
            ${sampleData.istd_warning ? `
            <div class="breakdown-row" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding-left: 15px;">
                <span class="breakdown-label" style="color: #856404; font-weight: bold;">⚠️ ISTD Notice</span>
                <span class="breakdown-value" style="color: #856404;">${sampleData.istd_warning}</span>
            </div>
            ` : ''}
            <div class="breakdown-row">
                <span class="breakdown-label">Ratio = Area ÷ ISTD</span>
                <span class="breakdown-value">${sampleData.area.toLocaleString()} ÷ ${sampleData.istd_area.toLocaleString()} (= ${ratio.toFixed(6)})</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">NIST Ratio (same substance)</span>
                <span class="breakdown-value">${sampleData.nist_standard} (from ${sampleData.nist_column || 'Standard NIST'})</span>
            </div>
            ${sampleData.matrix_info ? `
            <div class="breakdown-row" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <span class="breakdown-label">🎯 Matrix Lookup Info</span>
                <div style="font-size: 12px; margin-top: 5px;">
                    <div><strong>Position:</strong> Row[${sampleData.matrix_info.compound_index}] × Column[${sampleData.matrix_info.matched_nist_column || 'NOT_FOUND'}]</div>
                    <div><strong>Success:</strong> ${sampleData.matrix_info.matrix_lookup_success ? '✅ YES' : '❌ NO'}</div>
                    ${sampleData.matrix_info.fallback_reason ? `<div><strong>Issue:</strong> ${sampleData.matrix_info.fallback_reason}</div>` : ''}
                    <div><strong>Source:</strong> ${sampleData.matrix_info.mapping_source} mapping</div>
                </div>
            </div>
            ` : ''}
            <div class="breakdown-row">
                <span class="breakdown-label">NIST Result = Sample Ratio ÷ NIST Ratio</span>
                <span class="breakdown-value">${ratio.toFixed(6)} ÷ ${sampleData.nist_standard} (= ${nist_result.toFixed(6)})</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Concentration (nM)</span>
                <span class="breakdown-value">${sampleData.concentration}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Response Factor</span>
                <span class="breakdown-value">${sampleData.response_factor}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Coefficient</span>
                <span class="breakdown-value">${sampleData.coefficient}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Final Agilent Result</span>
                <span class="breakdown-value">${ratio.toFixed(6)} × ${sampleData.concentration} × ${sampleData.response_factor} × ${sampleData.coefficient} (= ${agilent_result.toFixed(6)})</span>
            </div>
        </div>
    `;
    
    sampleDiv.innerHTML = html;
}

// Setup compound search functionality
function setupCompoundSearch(sampleData) {
    const searchInput = document.getElementById('compoundSearchInput');
    const searchInfo = document.getElementById('searchInfo');
    const dropdown = document.getElementById('compoundDropdown');
    
    // Set current compound as default
    searchInput.value = sampleData.compound;
    
    // Update info text to show detailed data availability
    const detailedCount = sampleData.detailed_compounds_count || 0;
    const totalCount = sampleData.total_compounds || 0;
    
    if (detailedCount > 0) {
        searchInfo.textContent = `${totalCount} compounds available (${detailedCount} with detailed data). Currently: ${sampleData.compound}`;
    } else {
        searchInfo.textContent = `${totalCount} compounds available. Currently showing: ${sampleData.compound}`;
    }
    
    // Setup event listeners
    searchInput.addEventListener('input', handleCompoundSearch);
    searchInput.addEventListener('focus', handleCompoundSearch);
    searchInput.addEventListener('blur', hideDropdownDelayed);
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-input-container')) {
            hideDropdown();
        }
    });
    
    console.log('🔍 Compound search setup complete');
}

// Handle compound search input
function handleCompoundSearch(event) {
    const searchTerm = event.target.value.toLowerCase();
    const dropdown = document.getElementById('compoundDropdown');
    
    if (!availableCompounds || availableCompounds.length === 0) {
        console.log('⚠️ No compounds available for search');
        return;
    }
    
    // Filter compounds based on search term
    const filteredCompounds = availableCompounds.filter(compound => 
        compound.name.toLowerCase().includes(searchTerm)
    );
    
    // Populate dropdown
    populateCompoundDropdown(filteredCompounds);
    showDropdown();
}

// 🚀 ON-DEMAND: Populate compound dropdown with filtered results (all compounds supported)
function populateCompoundDropdown(compounds) {
    const dropdown = document.getElementById('compoundDropdown');
    
    if (compounds.length === 0) {
        dropdown.innerHTML = '<div class="compound-option">No compounds found</div>';
        return;
    }
    
    // Check if on-demand calculation is available
    const onDemandAvailable = currentUploadedData?.sample_breakdown?.on_demand_calculation || false;
    
    // Limit results to first 10 for performance
    const limitedCompounds = compounds.slice(0, 10);
    
    dropdown.innerHTML = limitedCompounds
        .map(compound => {
            // With on-demand calculation, all compounds have real-time data
            const indicator = onDemandAvailable ? '🚀 ' : '✅ ';
            const title = onDemandAvailable ? 
                'Real-time calculation available' : 
                'Real calculation data available';
            
            return `
                <div class="compound-option" 
                     data-compound-name="${compound.name}" 
                     data-compound-index="${compound.index}"
                     title="${title}"
                     onclick="selectCompound('${compound.name}', ${compound.index})">
                    ${indicator}${compound.name}
                </div>
            `;
        }).join('');
    
    if (compounds.length > 10) {
        const remainingCount = compounds.length - 10;
        const moreMessage = onDemandAvailable ? 
            `...and ${remainingCount} more compounds (all with real-time calculation)` :
            `...and ${remainingCount} more results`;
        dropdown.innerHTML += `<div class="compound-option" style="font-style: italic; color: #6c757d;">${moreMessage}</div>`;
    }
}

// Select a compound and update calculation
function selectCompound(compoundName, compoundIndex) {
    const searchInput = document.getElementById('compoundSearchInput');
    const searchInfo = document.getElementById('searchInfo');
    
    // Update input value
    searchInput.value = compoundName;
    searchInfo.textContent = `Selected: ${compoundName} (Index: ${compoundIndex})`;
    
    // Hide dropdown
    hideDropdown();
    
    // Update calculation breakdown for selected compound
    updateCompoundCalculation(compoundName, compoundIndex);
    
    console.log(`✅ Selected compound: ${compoundName} (Index: ${compoundIndex})`);
}

// 🚀 ON-DEMAND: Update calculation breakdown for selected compound via real-time API
async function updateCompoundCalculation(compoundName, compoundIndex) {
    try {
        console.log(`🔄 ON-DEMAND CALCULATION: ${compoundName} (Index: ${compoundIndex})`);
        
        // Show loading state
        const sampleDiv = document.getElementById('sampleCalculationBreakdown');
        if (sampleDiv) {
            sampleDiv.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Calculating...</span>
                    </div>
                    <p class="mt-2">🔄 Calculating real-time data for <strong>${compoundName}</strong>...</p>
                </div>
            `;
        }
        
        // Check if we should use on-demand calculation
        if (currentUploadedData.sample_breakdown && currentUploadedData.sample_breakdown.on_demand_calculation) {
            console.log(`🚀 Using ON-DEMAND API calculation for ${compoundName}`);
            
            // Make API call to calculate compound breakdown in real-time
            const requestData = {
                compound_index: compoundIndex,
                compound_name: compoundName,
                coefficient: currentUploadedData.sample_breakdown.coefficient || 500
            };
            
            console.log(`📡 API Request:`, requestData);
            
            const response = await fetch('/protocols/calculate-compound-breakdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error(`❌ API Error: ${response.status}`, errorData);
                
                if (errorData.requires_upload) {
                    // Session expired or no data
                    generateCompoundBreakdownHTML({
                        compound: compoundName,
                        note: `❌ Session expired. Please upload your Excel file again.`
                    });
                    return;
                }
                
                throw new Error(`API Error: ${errorData.error || 'Unknown error'}`);
            }
            
            const result = await response.json();
            console.log(`✅ ON-DEMAND API Response:`, result);
            
            if (result.success && result.breakdown) {
                // Use real-time calculated data
                const apiData = result.breakdown;
                const updatedSampleData = {
                    compound: apiData.compound,
                    sample: apiData.sample,
                    area: apiData.area,
                    istd_area: apiData.istd_area,
                    istd_name: apiData.istd_name,
                    nist_standard: apiData.nist_standard,
                    concentration: apiData.concentration,
                    response_factor: apiData.response_factor,
                    coefficient: apiData.coefficient,
                    ratio: apiData.ratio,
                    nist_result: apiData.nist_result,
                    agilent_result: apiData.agilent_result,
                    compound_index: apiData.compound_index,
                    note: `🚀 ${apiData.note || 'Real-time calculation complete'}`
                };
                
                console.log(`✅ Using real-time calculated data for ${compoundName}`, updatedSampleData);
                generateCompoundBreakdownHTML(updatedSampleData);
            } else {
                throw new Error('Invalid API response format');
            }
            
        } else {
            // Fallback to old method for backwards compatibility
            console.log(`📋 Using legacy pre-calculated data for ${compoundName}`);
            
            let updatedSampleData = null;
            
            // Check if we have detailed data for this compound (legacy)
            if (currentUploadedData.sample_breakdown.compound_data_list) {
                const compoundData = currentUploadedData.sample_breakdown.compound_data_list.find(
                    comp => comp.name === compoundName && comp.index === compoundIndex
                );
                
                if (compoundData) {
                    updatedSampleData = {
                        compound: compoundData.name,
                        sample: currentUploadedData.sample_breakdown.sample,
                        area: compoundData.area,
                        istd_area: compoundData.istd_area,
                        istd_name: compoundData.istd_name,
                        nist_standard: currentUploadedData.sample_breakdown.nist_standard,
                        concentration: compoundData.concentration,
                        response_factor: compoundData.response_factor,
                        coefficient: currentUploadedData.sample_breakdown.coefficient,
                        ratio: compoundData.ratio,
                        nist_result: compoundData.nist_result,
                        agilent_result: compoundData.agilent_result,
                        note: `✅ Pre-calculated data for ${compoundData.name}`
                    };
                } else {
                    updatedSampleData = {
                        ...currentUploadedData.sample_breakdown,
                        compound: compoundName,
                        note: `⚠️ Legacy mode: Detailed data not available.`
                    };
                }
            } else {
                updatedSampleData = {
                    ...currentUploadedData.sample_breakdown,
                    compound: compoundName,
                    note: `⚠️ Legacy mode: Using placeholder data`
                };
            }
            
            generateCompoundBreakdownHTML(updatedSampleData);
        }
        
    } catch (error) {
        console.error('❌ Error in on-demand calculation:', error);
        
        // Error fallback display
        const fallbackData = {
            compound: compoundName,
            sample: currentUploadedData?.sample_breakdown?.sample || 'Unknown',
            area: 0,
            istd_area: 212434.0,
            nist_standard: 0.1769,
            concentration: 25.0,
            response_factor: 1.0,
            coefficient: 500,
            ratio: 0,
            nist_result: 0,
            agilent_result: 0,
            note: `❌ Error calculating ${compoundName}: ${error.message}`
        };
        generateCompoundBreakdownHTML(fallbackData);
    }
}

// Generate breakdown HTML for selected compound
function generateCompoundBreakdownHTML(sampleData) {
    const sampleDiv = document.getElementById('sampleCalculationBreakdown');
    
    // Use pre-calculated values if available, otherwise calculate step by step
    const ratio = sampleData.ratio || (sampleData.area / sampleData.istd_area);
    const nist_result = sampleData.nist_result || (ratio / sampleData.nist_standard);
    const agilent_result = sampleData.agilent_result || (ratio * sampleData.concentration * sampleData.response_factor * sampleData.coefficient);
    
    const html = `
        <h4>Sample Calculation Breakdown</h4>
        <p><strong>Example:</strong> ${sampleData.compound} (Selected compound) in ${sampleData.sample} (First sample)</p>
        
        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
            <strong>Debug Info:</strong><br>
            Data Source: ${currentUploadedData && currentUploadedData.sample_breakdown ? '✅ Real uploaded data' : '⚠️ Fallback data'}<br>
            Selected Compound: ${sampleData.compound}<br>
            Area Value: ${sampleData.area} (${typeof sampleData.area})<br>
            ${sampleData.istd_name ? `ISTD: ${sampleData.istd_name}<br>` : ''}
            ${sampleData.note ? `Note: ${sampleData.note}` : ''}
        </div>
        
        <div class="calculation-breakdown">
            <div class="breakdown-row">
                <span class="breakdown-label">Raw Compound Area</span>
                <span class="breakdown-value">${sampleData.area.toLocaleString()}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Internal Standard (ISTD) Area</span>
                <span class="breakdown-value">${sampleData.istd_area.toLocaleString()}</span>
            </div>
            ${sampleData.istd_warning ? `
            <div class="breakdown-row" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding-left: 15px;">
                <span class="breakdown-label" style="color: #856404; font-weight: bold;">⚠️ ISTD Notice</span>
                <span class="breakdown-value" style="color: #856404;">${sampleData.istd_warning}</span>
            </div>
            ` : ''}
            <div class="breakdown-row">
                <span class="breakdown-label">Ratio = Area ÷ ISTD</span>
                <span class="breakdown-value">${sampleData.area.toLocaleString()} ÷ ${sampleData.istd_area.toLocaleString()} (= ${ratio.toFixed(6)})</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">NIST Ratio (same substance)</span>
                <span class="breakdown-value">${sampleData.nist_standard} (from ${sampleData.nist_column || 'Standard NIST'})</span>
            </div>
            ${sampleData.matrix_info ? `
            <div class="breakdown-row" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <span class="breakdown-label">🎯 Matrix Lookup Info</span>
                <div style="font-size: 12px; margin-top: 5px;">
                    <div><strong>Position:</strong> Row[${sampleData.matrix_info.compound_index}] × Column[${sampleData.matrix_info.matched_nist_column || 'NOT_FOUND'}]</div>
                    <div><strong>Success:</strong> ${sampleData.matrix_info.matrix_lookup_success ? '✅ YES' : '❌ NO'}</div>
                    ${sampleData.matrix_info.fallback_reason ? `<div><strong>Issue:</strong> ${sampleData.matrix_info.fallback_reason}</div>` : ''}
                    <div><strong>Source:</strong> ${sampleData.matrix_info.mapping_source} mapping</div>
                </div>
            </div>
            ` : ''}
            <div class="breakdown-row">
                <span class="breakdown-label">NIST Result = Sample Ratio ÷ NIST Ratio</span>
                <span class="breakdown-value">${ratio.toFixed(6)} ÷ ${sampleData.nist_standard} (= ${nist_result.toFixed(6)})</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Concentration (nM)</span>
                <span class="breakdown-value">${sampleData.concentration}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Response Factor</span>
                <span class="breakdown-value">${sampleData.response_factor}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Coefficient</span>
                <span class="breakdown-value">${sampleData.coefficient}</span>
            </div>
            <div class="breakdown-row">
                <span class="breakdown-label">Final Agilent Result</span>
                <span class="breakdown-value">${ratio.toFixed(6)} × ${sampleData.concentration} × ${sampleData.response_factor} × ${sampleData.coefficient} (= ${agilent_result.toFixed(6)})</span>
            </div>
        </div>
    `;
    
    sampleDiv.innerHTML = html;
}

// Show dropdown
function showDropdown() {
    document.getElementById('compoundDropdown').style.display = 'block';
}

// Hide dropdown
function hideDropdown() {
    document.getElementById('compoundDropdown').style.display = 'none';
}

// Hide dropdown with delay (for blur event)
function hideDropdownDelayed() {
    setTimeout(hideDropdown, 200);
}

// Search template functions
function searchTemplate(templateTerm) {
    const searchInput = document.getElementById('compoundSearchInput');
    if (searchInput) {
        searchInput.value = templateTerm;
        handleCompoundSearch({ target: searchInput });
        searchInput.focus();
        
        // Update search info
        const searchInfo = document.getElementById('searchInfo');
        if (searchInfo) {
            const templateDescriptions = {
                'AcylCarnitine': 'Acyl carnitines - fatty acid transport molecules',
                'TG': 'Triacylglycerols - neutral lipids with three fatty acids',
                'PC': 'Phosphatidylcholines - major membrane phospholipids',
                'PE': 'Phosphatidylethanolamines - membrane building blocks',
                'SM': 'Sphingomyelins - sphingolipid membrane components',
                'Cer': 'Ceramides - bioactive sphingolipid signaling molecules',
                'LPC': 'Lysophosphatidylcholines - signaling and membrane remodeling',
                'LPE': 'Lysophosphatidylethanolamines - bioactive lysolipids',
                'FA': 'Fatty acids - fundamental building blocks',
                'MAG': 'Monoacylglycerols - partial glyceride lipids',
                'd7': 'Deuterated internal standards - stable isotope references'
            };
            
            const description = templateDescriptions[templateTerm] || 'Searching for compounds containing this term';
            searchInfo.innerHTML = `
                <div class="alert alert-info alert-sm mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>${templateTerm}</strong>: ${description}
                </div>
            `;
        }
    }
}

function clearSearch() {
    const searchInput = document.getElementById('compoundSearchInput');
    const searchInfo = document.getElementById('searchInfo');
    
    if (searchInput) {
        searchInput.value = '';
        hideDropdown();
    }
    
    if (searchInfo) {
        searchInfo.innerHTML = `
            <div class="text-muted small mt-2">
                <i class="fas fa-lightbulb me-1"></i>
                Use the template buttons above or type to search through all available compounds
            </div>
        `;
    }
}

// Show detailed NIST ratio information modal
function showNistRatioInfo() {
    if (!calculationResults || !calculationResults.nist_standards) {
        alert('No NIST standards data available. Please upload and process an Excel file first.');
        return;
    }
    
    const nistStandards = calculationResults.nist_standards;
    const compounds = Object.keys(nistStandards);
    
    let modalContent = `
        <div class="modal fade" id="nistRatioModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-database me-2"></i>Database NIST Ratio Standards
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            These ratio standards are permanently stored in the database from your Ratio-database.xlsx file. 
                            They are used to normalize all NIST calculations.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Compound</th>
                                        <th>NIST Standard Ratio</th>
                                        <th>ISTD</th>
                                        <th>Concentration (nM)</th>
                                        <th>Response Factor</th>
                                    </tr>
                                </thead>
                                <tbody>
    `;
    
    compounds.forEach(compound => {
        const info = nistStandards[compound];
        modalContent += `
            <tr>
                <td class="fw-bold text-primary">${compound}</td>
                <td class="fw-bold text-success">${info.nist_standard.toFixed(6)}</td>
                <td class="text-muted">${info.istd}</td>
                <td>${info.conc_nm.toFixed(1)}</td>
                <td>${info.response_factor.toFixed(2)}</td>
            </tr>
        `;
    });
    
    modalContent += `
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <h6 class="text-primary">Calculation Formula:</h6>
                            <div class="bg-light p-3 rounded">
                                <code>NIST Result = Sample Ratio ÷ Database NIST Standard</code>
                                <br><small class="text-muted">Where Sample Ratio = Compound Area ÷ ISTD Area</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('nistRatioModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('nistRatioModal'));
    modal.show();
}
</script>
{% endblock %}