{% extends "base.html" %}

{% block title %}Interactive Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .chart-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .chart-title {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 18px;
        color: #2c3e50;
        margin: 0;
    }
    
    .interactive-charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        min-height: 400px;
    }
    
    .chart-canvas {
        position: relative;
        height: 350px;
        cursor: grab;
    }
    
    .chart-canvas:active {
        cursor: grabbing;
    }
    
    .chart-controls {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .zoom-info {
        background: #e3f2fd;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        color: #1976d2;
        font-weight: bold;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
    }
    
    .back-button {
        background: #6c757d;
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 20px;
        transition: background 0.2s ease;
    }
    
    .back-button:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    
    .instructions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .interactive-charts {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <a href="{{ url_for('clean_dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left me-2"></i>Back to Lipid Selection
    </a>
    
    <!-- Instructions -->
    <div class="instructions">
        <h4>üñ±Ô∏è Interactive Chromatogram Viewer</h4>
        <p class="mb-2">
            <strong>Mouse Controls:</strong> 
            Scroll wheel to zoom in/out | Click and drag to pan left/right | Double-click to reset zoom
        </p>
        <p class="mb-0">
            <strong>Keyboard:</strong> 
            + to zoom in | - to zoom out | 0 to reset all | Arrow keys to pan
        </p>
    </div>

    <!-- Individual Charts -->
    {% for lipid in selected_lipids %}
    <div class="chart-container" id="chart-{{ lipid.lipid_id }}">
        <div class="chart-header">
            <div>
                <h3 class="chart-title">{{ lipid.lipid_name }}</h3>
                <div class="chart-controls">
                    <span class="zoom-info" id="zoom-info-{{ lipid.lipid_id }}">
                        üìä Full Range: 0.0 - 16.0 min
                    </span>
                    <button class="btn btn-sm btn-outline-primary" onclick="resetZoom({{ lipid.lipid_id }})">
                        <i class="fas fa-expand me-1"></i>Reset Zoom
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="centerOnPeak({{ lipid.lipid_id }})">
                        <i class="fas fa-crosshairs me-1"></i>Center on Peak
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="exportChart({{ lipid.lipid_id }})">
                        <i class="fas fa-download me-1"></i>Export PNG
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Interactive Charts -->
        <div class="interactive-charts" id="charts-{{ lipid.lipid_id }}">
            <!-- Chart 1: Focused View -->
            <div>
                <h6>Chart 1: Focused View (RT ¬± 0.6 min)</h6>
                <div class="chart-canvas">
                    <canvas id="chart1-{{ lipid.lipid_id }}"></canvas>
                </div>
            </div>
            
            <!-- Chart 2: Overview -->
            <div>
                <h6>Chart 2: Full Overview (0-16 min)</h6>
                <div class="chart-canvas">
                    <canvas id="chart2-{{ lipid.lipid_id }}"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading-spinner" id="loading-{{ lipid.lipid_id }}">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3">Loading interactive chart for {{ lipid.lipid_name }}...</p>
        </div>
    </div>
    {% endfor %}
    
    {% if not selected_lipids %}
    <div class="text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Lipids Selected</h4>
        <p class="text-muted">Please go back and select lipids to view their interactive charts.</p>
        <a href="{{ url_for('clean_dashboard') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Selection
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

<script>
// Store lipid IDs and chart instances
const selectedLipidIds = {{ selected_lipid_ids | tojson }};
const chartInstances = {};
let lipidData = {};

// Register Chart.js plugins properly
console.log('üì¶ Chart.js version:', Chart.version);

// Check if plugins are available
if (typeof window.ChartjsPluginZoom !== 'undefined') {
    Chart.register(window.ChartjsPluginZoom);
    console.log('‚úÖ Zoom plugin registered');
} else if (typeof chartjsPluginZoom !== 'undefined') {
    Chart.register(chartjsPluginZoom);
    console.log('‚úÖ Zoom plugin registered (alternative)');
} else {
    console.warn('‚ö†Ô∏è  Zoom plugin not found - zoom functionality disabled');
}

// Register annotation plugin
if (typeof window.ChartjsPluginAnnotation !== 'undefined') {
    Chart.register(window.ChartjsPluginAnnotation);
    console.log('‚úÖ Annotation plugin registered');
} else if (typeof chartjsPluginAnnotation !== 'undefined') {
    Chart.register(chartjsPluginAnnotation);
    console.log('‚úÖ Annotation plugin registered (alternative)');
} else {
    console.warn('‚ö†Ô∏è  Annotation plugin not found - line annotations disabled');
}

// Initialize all interactive charts
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Starting interactive chart generation...');
    generateAllInteractiveCharts();
});

async function generateAllInteractiveCharts() {
    for (let lipidId of selectedLipidIds) {
        try {
            await generateInteractiveChart(lipidId);
        } catch (error) {
            console.error(`Failed to generate interactive chart for lipid ${lipidId}:`, error);
            showChartError(lipidId, error.message);
        }
    }
}

async function generateInteractiveChart(lipidId) {
    const loadingDiv = document.getElementById(`loading-${lipidId}`);
    const chartsDiv = document.getElementById(`charts-${lipidId}`);
    
    try {
        // Fetch interactive chart data
        const response = await fetch(`/api/chart-data-interactive/${lipidId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            const data = result.data;
            lipidData[lipidId] = data;
            
            // Hide loading, show charts
            loadingDiv.style.display = 'none';
            chartsDiv.style.display = 'grid';
            
            // Create Chart 1 (Focused)
            createChart1(lipidId, data);
            
            // Create Chart 2 (Overview)
            createChart2(lipidId, data);
            
            console.log(`‚úÖ Interactive chart generated for lipid ${lipidId}`);
        } else {
            throw new Error(result.message || 'Chart data fetch failed');
        }
        
    } catch (error) {
        showChartError(lipidId, error.message);
    }
}

function createChart1(lipidId, data) {
    console.log(`üîß Creating Chart 1 for lipid ${lipidId}...`);
    console.log('Data received:', data);
    
    const ctx = document.getElementById(`chart1-${lipidId}`).getContext('2d');
    const metadata = data.metadata;
    const [chart1Start, chart1End] = metadata.chart1_range;
    
    // Filter data to Chart 1 range
    const filteredData = data.xic_data.filter(point => 
        point.x >= chart1Start && point.x <= chart1End
    );
    
    console.log(`üìä Chart 1 data points: ${filteredData.length}, range: ${chart1Start}-${chart1End}`);
    
    if (filteredData.length === 0) {
        console.error('‚ùå No data points in Chart 1 range!');
        return;
    }

    // Find main ion for integration area
    const mainIon = data.ions_data.find(ion => ion.is_main);
    
    // Prepare datasets
    const datasets = [{
        label: 'XIC Chromatogram',
        data: filteredData,
        borderColor: '#1f77b4',
        backgroundColor: 'rgba(31, 119, 180, 0.1)',
        borderWidth: 2,
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 4,
        tension: 0
    }];

    // Add integration area if main ion has integration bounds
    if (mainIon && mainIon.int_start && mainIon.int_end) {
        const integrationData = filteredData.filter(point => 
            point.x >= mainIon.int_start && point.x <= mainIon.int_end
        );
        
        if (integrationData.length > 0) {
            datasets.push({
                label: 'Integration Area',
                data: integrationData,
                borderColor: 'lightblue',
                backgroundColor: 'rgba(173, 216, 230, 0.7)',
                borderWidth: 0,
                fill: 'origin',
                pointRadius: 0,
                tension: 0,
                order: 1
            });
        }
    }
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 0
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x',
                        onPanComplete: function(context) {
                            updateZoomInfo(lipidId, 1, context.chart);
                        }
                    },
                    zoom: {
                        wheel: {
                            enabled: true,
                            speed: 0.1
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                        onZoomComplete: function(context) {
                            updateZoomInfo(lipidId, 1, context.chart);
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `RT: ${context[0].parsed.x.toFixed(3)} min`;
                        },
                        label: function(context) {
                            return `Intensity: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                },
                // Add integration boundary lines
                annotation: {
                    annotations: getChart1Annotations(data.ions_data, chart1Start, chart1End)
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Retention Time (minutes)',
                        color: '#333',
                        font: {
                            size: 12
                        }
                    },
                    min: chart1Start,
                    max: chart1End,
                    ticks: {
                        color: '#666',
                        stepSize: 0.1
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Intensity',
                        color: '#333',
                        font: {
                            size: 12
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        color: '#666',
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
    
    console.log(`‚úÖ Chart 1 created successfully for lipid ${lipidId}`);
    chartInstances[`${lipidId}_1`] = chart;
}

function createChart2(lipidId, data) {
    console.log(`üîß Creating Chart 2 for lipid ${lipidId}...`);
    
    const ctx = document.getElementById(`chart2-${lipidId}`).getContext('2d');
    const metadata = data.metadata;
    const [chart1Start, chart1End] = metadata.chart1_range;
    
    console.log(`üìä Chart 2 data points: ${data.xic_data.length}`);
    
    if (data.xic_data.length === 0) {
        console.error('‚ùå No data points for Chart 2!');
        return;
    }

    // Prepare datasets with integration areas for all ions
    const datasets = [{
        label: 'XIC Chromatogram',
        data: data.xic_data,
        borderColor: '#1f77b4',
        backgroundColor: 'rgba(31, 119, 180, 0.05)',
        borderWidth: 1.5,
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 4,
        tension: 0,
        order: 2
    }];

    // Add integration areas for all ions with different colors
    data.ions_data.forEach((ion, index) => {
        if (ion.int_start && ion.int_end) {
            const integrationData = data.xic_data.filter(point => 
                point.x >= ion.int_start && point.x <= ion.int_end
            );
            
            if (integrationData.length > 0) {
                datasets.push({
                    label: `${ion.ion_name} Integration`,
                    data: integrationData,
                    borderColor: ion.color,
                    backgroundColor: ion.color.replace(')', ', 0.3)').replace('rgb', 'rgba'),
                    borderWidth: 0,
                    fill: 'origin',
                    pointRadius: 0,
                    tension: 0,
                    order: 1
                });
            }
        }
    });
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 0
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        filter: function(legendItem) {
                            // Only show XIC Chromatogram and ion annotations in legend
                            return legendItem.text === 'XIC Chromatogram' || 
                                   legendItem.text.includes('Chart 1 zoom') ||
                                   legendItem.text.includes('Integration');
                        }
                    }
                },
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x',
                        onPanComplete: function(context) {
                            updateZoomInfo(lipidId, 2, context.chart);
                        }
                    },
                    zoom: {
                        wheel: {
                            enabled: true,
                            speed: 0.1
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                        onZoomComplete: function(context) {
                            updateZoomInfo(lipidId, 2, context.chart);
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `RT: ${context[0].parsed.x.toFixed(3)} min`;
                        },
                        label: function(context) {
                            return `Intensity: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                },
                // Add Chart 1 zoom indicators and ion annotation lines
                annotation: {
                    annotations: getChart2Annotations(data.ions_data, chart1Start, chart1End)
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Retention Time (minutes)',
                        color: '#333',
                        font: {
                            size: 12
                        }
                    },
                    min: 0,
                    max: 16,
                    ticks: {
                        color: '#666',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Intensity',
                        color: '#333',
                        font: {
                            size: 12
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        color: '#666',
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
    
    console.log(`‚úÖ Chart 2 created successfully for lipid ${lipidId}`);
    chartInstances[`${lipidId}_2`] = chart;
}

function getChart1Annotations(ionsData, chartStart, chartEnd) {
    const annotations = [];
    
    // Add integration boundary lines for main ion
    const mainIon = ionsData.find(ion => ion.is_main);
    if (mainIon && mainIon.int_start && mainIon.int_end) {
        // Integration start line
        annotations.push({
            type: 'line',
            scaleID: 'x',
            value: mainIon.int_start,
            borderColor: 'lightblue',
            borderWidth: 2,
            borderDash: [5, 5],
            label: {
                display: true,
                content: 'Int Start',
                position: 'start'
            }
        });
        
        // Integration end line
        annotations.push({
            type: 'line',
            scaleID: 'x',
            value: mainIon.int_end,
            borderColor: 'lightblue',
            borderWidth: 2,
            borderDash: [5, 5],
            label: {
                display: true,
                content: 'Int End',
                position: 'end'
            }
        });
    }
    
    // Add ion retention time markers for ions in chart range
    ionsData.forEach(ion => {
        if (ion.retention_time >= chartStart && ion.retention_time <= chartEnd) {
            annotations.push({
                type: 'line',
                scaleID: 'x',
                value: ion.retention_time,
                borderColor: ion.color,
                borderWidth: 2,
                borderDash: ion.is_main ? [] : [3, 3],
                label: {
                    display: true,
                    content: ion.ion_name,
                    position: 'start',
                    rotation: 90
                }
            });
        }
    });
    
    return annotations;
}

function getChart2Annotations(ionsData, chart1Start, chart1End) {
    const annotations = [];
    
    // Add Chart 1 zoom range indicators (orange dashed lines)
    annotations.push({
        type: 'line',
        scaleID: 'x',
        value: chart1Start,
        borderColor: 'orange',
        borderWidth: 2,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Chart 1 Start',
            position: 'start'
        }
    });
    
    annotations.push({
        type: 'line',
        scaleID: 'x',
        value: chart1End,
        borderColor: 'orange',
        borderWidth: 2,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Chart 1 End',
            position: 'end'
        }
    });
    
    // Add all ion retention time markers
    ionsData.forEach(ion => {
        if (ion.retention_time) {
            annotations.push({
                type: 'line',
                scaleID: 'x',
                value: ion.retention_time,
                borderColor: ion.color,
                borderWidth: 2,
                borderDash: ion.is_main ? [] : [3, 3],
                label: {
                    display: true,
                    content: ion.ion_name,
                    position: 'start',
                    rotation: 90
                }
            });
            
            // Add integration boundary lines if available
            if (ion.int_start && ion.int_end) {
                annotations.push({
                    type: 'line',
                    scaleID: 'x',
                    value: ion.int_start,
                    borderColor: ion.color,
                    borderWidth: 1,
                    borderDash: [2, 2],
                    label: {
                        display: false
                    }
                });
                
                annotations.push({
                    type: 'line',
                    scaleID: 'x',
                    value: ion.int_end,
                    borderColor: ion.color,
                    borderWidth: 1,
                    borderDash: [2, 2],
                    label: {
                        display: false
                    }
                });
            }
        }
    });
    
    return annotations;
}

function updateZoomInfo(lipidId, chartNum, chart) {
    const xAxis = chart.scales.x;
    const min = xAxis.min.toFixed(2);
    const max = xAxis.max.toFixed(2);
    const range = (max - min).toFixed(2);
    
    const infoElement = document.getElementById(`zoom-info-${lipidId}`);
    infoElement.innerHTML = `üîç Chart ${chartNum}: ${min} - ${max} min (${range} min range)`;
}

function resetZoom(lipidId) {
    const chart1 = chartInstances[`${lipidId}_1`];
    const chart2 = chartInstances[`${lipidId}_2`];
    
    if (chart1) chart1.resetZoom();
    if (chart2) chart2.resetZoom();
    
    const infoElement = document.getElementById(`zoom-info-${lipidId}`);
    infoElement.innerHTML = `üìä Full Range: 0.0 - 16.0 min`;
}

function centerOnPeak(lipidId) {
    const data = lipidData[lipidId];
    if (!data) return;
    
    const mainRT = data.metadata.main_rt;
    const chart1 = chartInstances[`${lipidId}_1`];
    const chart2 = chartInstances[`${lipidId}_2`];
    
    // Center Chart 1 on main retention time ¬± 0.6 min
    if (chart1) {
        chart1.zoomScale('x', {min: mainRT - 0.6, max: mainRT + 0.6});
    }
    
    // Center Chart 2 on main retention time ¬± 2 min
    if (chart2) {
        chart2.zoomScale('x', {min: Math.max(0, mainRT - 2), max: Math.min(16, mainRT + 2)});
    }
}

function exportChart(lipidId) {
    const chart1 = chartInstances[`${lipidId}_1`];
    if (chart1) {
        const url = chart1.toBase64Image();
        const link = document.createElement('a');
        link.href = url;
        link.download = `lipid_${lipidId}_interactive_chart.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function showChartError(lipidId, errorMessage) {
    const loadingDiv = document.getElementById(`loading-${lipidId}`);
    loadingDiv.innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Interactive Chart Generation Failed</strong><br>
            ${errorMessage}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-danger" onclick="generateInteractiveChart(${lipidId})">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        </div>
    `;
}

// Global keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // + key to zoom in on all charts
    if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        Object.values(chartInstances).forEach(chart => {
            chart.zoom(1.5);
        });
    }
    
    // - key to zoom out on all charts
    if (e.key === '-' || e.key === '_') {
        e.preventDefault();
        Object.values(chartInstances).forEach(chart => {
            chart.zoom(0.67);
        });
    }
    
    // 0 key to reset zoom on all charts
    if (e.key === '0') {
        e.preventDefault();
        selectedLipidIds.forEach(lipidId => {
            resetZoom(lipidId);
        });
    }
    
    // Arrow keys for panning
    if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
        const direction = e.key === 'ArrowLeft' ? -0.5 : 0.5;
        Object.values(chartInstances).forEach(chart => {
            chart.pan({x: direction * 50});
        });
    }
});
</script>
{% endblock %}