{% extends "base.html" %}

{% block title %}Optimized Interactive Charts - {{ selected_lipids|length }} Selected Lipids{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .lipid-title {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 16px;
        color: #2c3e50;
        margin: 0;
    }
    
    .lipid-class-badge {
        background: #007bff;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .chart-canvas-container {
        position: relative;
        height: 400px;
        margin-bottom: 15px;
    }
    
    .chart-canvas {
        cursor: crosshair;
    }
    
    /* Peak details popup */
    .peak-details-popup {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 200px;
        display: none;
        font-size: 12px;
    }
    
    .popup-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
        border-bottom: 1px solid #eee;
        padding-bottom: 4px;
    }
    
    .popup-row {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
    }
    
    .popup-label {
        font-weight: 500;
        color: #666;
    }
    
    .popup-value {
        font-family: 'Courier New', monospace;
        color: #333;
    }
    
    /* Annotated ions table */
    .annotated-ions-section {
        margin-top: 20px;
    }
    
    .section-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .ions-table-container {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        border: 1px solid #e9ecef;
    }
    
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .entries-control select {
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .search-control input {
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
        width: 150px;
    }
    
    .ions-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
    }
    
    .ions-table th {
        background: #e9ecef;
        padding: 8px 6px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    
    .ions-table td {
        padding: 6px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .ions-table tr:hover {
        background: #f0f0f0;
    }
    
    .main-ion-row {
        background: #f0f9f0 !important;
        font-weight: 600;
    }
    
    .annotation-badge {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
    }
    
    .annotation-current { background: #cce5ff; color: #004085; }
    .annotation-isotope { background: #f8d7da; color: #721c24; }
    .annotation-similar { background: #fff3cd; color: #856404; }
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #666;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="display-6">üìà Interactive Chromatograms</h2>
                <div>
                    <span class="badge bg-primary">{{ selected_lipids|length }} Lipids Selected</span>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="window.history.back()">
                        ‚Üê Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row">
        <div class="col-12">
            {% for lipid in selected_lipids %}
            <div class="chart-container" id="chart-container-{{ lipid.lipid_id }}">
                <div class="chart-header">
                    <h3 class="lipid-title">{{ lipid.lipid_name }}</h3>
                    <div>
                        <span class="lipid-class-badge">{{ lipid.class_name }}</span>
                        <small class="text-muted ms-2">ID: {{ lipid.lipid_id }} | Ions: {{ lipid.annotated_ions_count }}</small>
                    </div>
                </div>
                
                <!-- Chart Canvas -->
                <div class="chart-canvas-container">
                    <canvas class="chart-canvas" id="chart-{{ lipid.lipid_id }}"></canvas>
                    
                    <!-- Peak Details Popup -->
                    <div class="peak-details-popup" id="popup-{{ lipid.lipid_id }}">
                        <div class="popup-title" id="popup-title-{{ lipid.lipid_id }}"></div>
                        <div id="popup-content-{{ lipid.lipid_id }}"></div>
                    </div>
                    
                    <!-- Loading State -->
                    <div class="loading-spinner" id="loading-{{ lipid.lipid_id }}">
                        <div>
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">Loading chromatogram data...</span>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div class="error-message" id="error-{{ lipid.lipid_id }}" style="display: none;">
                        <strong>Error:</strong> <span id="error-message-{{ lipid.lipid_id }}"></span>
                    </div>
                </div>
                
                <!-- Annotated Ions Section -->
                <div class="annotated-ions-section">
                    <div class="section-title">Annotated ions:</div>
                    <div class="ions-table-container">
                        <div class="table-controls">
                            <div class="entries-control">
                                Show 
                                <select id="entries-select-{{ lipid.lipid_id }}" onchange="updateIonsTable({{ lipid.lipid_id }})">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                entries
                            </div>
                            <div class="search-control">
                                Search: <input type="text" id="search-ions-{{ lipid.lipid_id }}" 
                                             onkeyup="searchIonsTable({{ lipid.lipid_id }})" placeholder="...">
                            </div>
                        </div>
                        
                        <table class="ions-table" id="ions-table-{{ lipid.lipid_id }}">
                            <thead>
                                <tr>
                                    <th>Lipid name</th>
                                    <th>Annotation</th>
                                    <th>Retention time</th>
                                    <th>Integration start</th>
                                    <th>Integration end</th>
                                    <th>Precursor mass</th>
                                    <th>Product mass</th>
                                </tr>
                            </thead>
                            <tbody id="ions-tbody-{{ lipid.lipid_id }}">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
// Chart instances storage
const chartInstances = {};
const chartData = {};
const ionsData = {};

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    {% for lipid in selected_lipids %}
        initializeChart({{ lipid.lipid_id }});
    {% endfor %}
});

async function initializeChart(lipidId) {
    try {
        // Show loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'flex';
        document.getElementById(`error-${lipidId}`).style.display = 'none';
        
        // Fetch chart data
        const response = await fetch(`/api/optimized-chart-data/${lipidId}`);
        const result = await response.json();
        
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || 'Failed to load chart data');
        }
        
        // Store data for later use
        chartData[lipidId] = result.data;
        ionsData[lipidId] = result.annotated_ions;
        
        // Hide loading state
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        
        // Create chart
        createInteractiveChart(lipidId, result.data);
        
        // Populate annotated ions table
        populateIonsTable(lipidId, result.annotated_ions);
        
    } catch (error) {
        console.error(`Error initializing chart ${lipidId}:`, error);
        document.getElementById(`loading-${lipidId}`).style.display = 'none';
        document.getElementById(`error-${lipidId}`).style.display = 'block';
        document.getElementById(`error-message-${lipidId}`).textContent = error.message;
    }
}

function createInteractiveChart(lipidId, data) {
    const ctx = document.getElementById(`chart-${lipidId}`).getContext('2d');
    
    // Enhanced chart configuration
    const config = {
        ...data.chart_config,
        options: {
            ...data.chart_config.options,
            onClick: (event, activeElements) => handleChartClick(event, activeElements, lipidId),
            onHover: (event, activeElements) => handleChartHover(event, activeElements, lipidId)
        }
    };
    
    // Create chart instance
    chartInstances[lipidId] = new Chart(ctx, config);
}

function handleChartClick(event, activeElements, lipidId) {
    if (activeElements.length > 0) {
        const datasetIndex = activeElements[0].datasetIndex;
        const dataIndex = activeElements[0].index;
        const chart = chartInstances[lipidId];
        const clickedPoint = chart.data.datasets[datasetIndex].data[dataIndex];
        
        // Find the closest peak
        const peak = findClosestPeak(lipidId, clickedPoint.x);
        if (peak) {
            showPeakDetails(lipidId, peak, event);
        }
    }
}

function handleChartHover(event, activeElements, lipidId) {
    const chart = chartInstances[lipidId];
    chart.canvas.style.cursor = activeElements.length > 0 ? 'pointer' : 'crosshair';
}

function findClosestPeak(lipidId, clickTime) {
    const data = chartData[lipidId];
    if (!data || !data.clickable_peaks) return null;
    
    let closestPeak = null;
    let minDistance = Infinity;
    
    for (const peak of data.clickable_peaks) {
        const distance = Math.abs(peak.retention_time - clickTime);
        if (distance < minDistance && distance < 0.5) { // Within 0.5 minutes
            minDistance = distance;
            closestPeak = peak;
        }
    }
    
    return closestPeak;
}

function showPeakDetails(lipidId, peak, event) {
    const popup = document.getElementById(`popup-${lipidId}`);
    const title = document.getElementById(`popup-title-${lipidId}`);
    const content = document.getElementById(`popup-content-${lipidId}`);
    
    // Set popup content (matching reference image format)
    title.textContent = `${peak.lipid_name}`;
    
    content.innerHTML = `
        <div class="popup-row">
            <span class="popup-label">Lipid class:</span>
            <span class="popup-value">${peak.lipid_class}</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Retention time:</span>
            <span class="popup-value">${peak.retention_time} minutes</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Integration start:</span>
            <span class="popup-value">${peak.integration_start} minutes</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Integration end:</span>
            <span class="popup-value">${peak.integration_end} minutes</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Precursor mass:</span>
            <span class="popup-value">${peak.precursor_mass} m/z</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Product mass:</span>
            <span class="popup-value">${peak.product_mass} m/z</span>
        </div>
        <div class="popup-row">
            <span class="popup-label">Annotation:</span>
            <span class="popup-value">${peak.annotation_type}</span>
        </div>
    `;
    
    // Position popup near click point
    const rect = event.target.getBoundingClientRect();
    popup.style.left = `${event.layerX + 10}px`;
    popup.style.top = `${event.layerY - 10}px`;
    popup.style.display = 'block';
    
    // Hide popup after 5 seconds or on next click
    setTimeout(() => {
        popup.style.display = 'none';
    }, 5000);
}

function populateIonsTable(lipidId, ions) {
    const tbody = document.getElementById(`ions-tbody-${lipidId}`);
    
    let html = '';
    for (const ion of ions) {
        const annotationClass = getAnnotationClass(ion.annotation_type);
        const rowClass = ion.is_main ? 'main-ion-row' : '';
        
        html += `
            <tr class="${rowClass}">
                <td><strong>${ion.lipid_name}</strong></td>
                <td><span class="annotation-badge ${annotationClass}">${ion.annotation_type}</span></td>
                <td>${ion.retention_time} min</td>
                <td>${ion.integration_start} min</td>
                <td>${ion.integration_end} min</td>
                <td>${ion.precursor_ion} m/z</td>
                <td>${ion.product_ion} m/z</td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}

function getAnnotationClass(annotationType) {
    if (annotationType === 'Current lipid') return 'annotation-current';
    if (annotationType.includes('isotope')) return 'annotation-isotope';
    return 'annotation-similar';
}

function updateIonsTable(lipidId) {
    // Implementation for pagination
    const entriesSelect = document.getElementById(`entries-select-${lipidId}`);
    const limit = parseInt(entriesSelect.value);
    
    // Re-populate table with new limit
    if (ionsData[lipidId]) {
        const limitedIons = ionsData[lipidId].slice(0, limit);
        populateIonsTable(lipidId, limitedIons);
    }
}

function searchIonsTable(lipidId) {
    const searchInput = document.getElementById(`search-ions-${lipidId}`);
    const searchTerm = searchInput.value.toLowerCase();
    
    if (ionsData[lipidId]) {
        const filteredIons = ionsData[lipidId].filter(ion => 
            ion.lipid_name.toLowerCase().includes(searchTerm) ||
            ion.annotation_type.toLowerCase().includes(searchTerm)
        );
        populateIonsTable(lipidId, filteredIons);
    }
}

// Hide popups when clicking elsewhere
document.addEventListener('click', function(event) {
    if (!event.target.closest('.peak-details-popup') && !event.target.closest('.chart-canvas')) {
        const popups = document.querySelectorAll('.peak-details-popup');
        popups.forEach(popup => popup.style.display = 'none');
    }
});
</script>
{% endblock %}