<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phenikaa Analysis Tool - Excel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2E4C92, #213671);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .form-section h3 {
            color: #2E4C92;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #E94B00;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2E4C92;
        }
        
        .admin-only {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .admin-mode .admin-only {
            opacity: 1;
            pointer-events: auto;
        }
        
        .toggle-admin {
            background: #E94B00;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #2E4C92, #213671);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            transition: transform 0.3s;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
        }
        
        .preview-container {
            margin-top: 40px;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        .preview-table th {
            background: #2E4C92;
            color: white;
            font-weight: 600;
        }
        
        .preview-table tr:hover {
            background: #f5f5f5;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1.1rem;
        }
        
        .sample-type-carryover {
            background-color: #fff3cd !important;
        }
        
        .sample-type-nist {
            background-color: #d1ecf1 !important;
        }
        
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Phenikaa Analysis Tool</h1>
            <p>Excel Generator for Sample Analysis Workflow</p>
        </div>
        
        <div class="form-container">
            <button class="toggle-admin" onclick="toggleAdminMode()">üîë Toggle Admin Mode</button>
            
            <!-- Position Management Section -->
            <div class="form-section admin-only">
                <h3>üóÑÔ∏è Position Database Management (Admin Only)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Position Map Status</label>
                        <p id="positionStatus">Using built-in position mapping (100 positions)</p>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-outline-primary" onclick="exportPositions()">
                            üì§ Export Position Map
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="loadCustomPositions()">
                            üì• Load Custom Positions
                        </button>
                    </div>
                </div>
                <input type="file" id="positionFileInput" accept=".json" style="display: none;" onchange="handlePositionFile()">
            </div>
            
            <!-- Project Information -->
            <div class="form-section">
                <h3>üìä Project Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="project">Project *</label>
                        <select id="project" required>
                            <option value="">Select Project</option>
                            <option value="PH-HC">PH-HC</option>
                            <option value="Phenikaa">Phenikaa</option>
                            <option value="BachMai">BachMai</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date">Analysis Date *</label>
                        <input type="date" id="date" required>
                    </div>
                </div>
            </div>
            
            <!-- Sample Information -->
            <div class="form-section">
                <h3>üß™ Sample Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sampleName">Sample Name *</label>
                        <input type="text" id="sampleName" placeholder="Enter sample name" required>
                    </div>
                    <div class="form-group">
                        <label for="batch">Batch Number *</label>
                        <input type="number" id="batch" placeholder="e.g., 100" required>
                    </div>
                    <div class="form-group">
                        <label for="sampleMethod">Method *</label>
                        <input type="text" id="sampleMethod" placeholder="e.g., 2025_Aug_05 (no guard) Plasma Method 6495D.m" required>
                    </div>
                </div>
            </div>
            
            <!-- Carry Over Configuration -->
            <div class="form-section">
                <h3>üîÑ Carry Over Configuration</h3>
                <div class="form-row">
                    <div class="form-group admin-only">
                        <label for="carryStep">Step (Admin Only)</label>
                        <input type="number" id="carryStep" value="3" min="1">
                    </div>
                    <div class="form-group">
                        <label for="carryMethod">Carry Over Method *</label>
                        <input type="text" id="carryMethod" placeholder="Enter carry over method" required>
                    </div>
                </div>
            </div>
            
            <!-- NIST Configuration -->
            <div class="form-section">
                <h3>üî¨ NIST Configuration</h3>
                <div class="form-row">
                    <div class="form-group admin-only">
                        <label for="nistStep">Step (Admin Only)</label>
                        <input type="number" id="nistStep" value="25" min="1">
                    </div>
                    <div class="form-group">
                        <label for="nistMethod">NIST Method *</label>
                        <input type="text" id="nistMethod" placeholder="Enter NIST method" required>
                    </div>
                </div>
            </div>
            
            <div class="status" id="status"></div>
            
            <button class="generate-btn" onclick="generateTable()">üöÄ Generate Analysis Table</button>
            
            <div class="preview-container" id="previewContainer" style="display: none;">
                <h3>üìã Preview Table</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewTable">
                        <!-- Table will be generated here -->
                    </table>
                </div>
                <button class="download-btn" onclick="downloadExcel()">üíæ Download Excel File</button>
            </div>
        </div>
    </div>

    <script>
        let isAdminMode = false;
        let generatedData = [];
        
        // Position mapping for plates - Based on your data pattern
        const POSITION_MAP = [
            // Plate 1
            'P1-B1', 'P1-B2', 'P1-B3', 'P1-B4', 'P1-B5', 'P1-B6', 'P1-B7', 'P1-B8', 'P1-B9', 'P1-B10', 'P1-B11',
            'P1-C1', 'P1-C2', 'P1-C3', 'P1-C4', 'P1-C5', 'P1-C6', 'P1-C7', 'P1-C8', 'P1-C9', 'P1-C10', 'P1-C11',
            'P1-D1', 'P1-D2', 'P1-D3', 'P1-D4', 'P1-D5', 'P1-D6', 'P1-D7', 'P1-D8', 'P1-D9', 'P1-D10', 'P1-D11',
            'P1-E1', 'P1-E2', 'P1-E3', 'P1-E4', 'P1-E5', 'P1-E6', 'P1-E7', 'P1-E8', 'P1-E9', 'P1-E10', 'P1-E11',
            'P1-F1', 'P1-F2', 'P1-F3', 'P1-F4', 'P1-F5', 'P1-F6', 'P1-F7', 'P1-F8', 'P1-F9', 'P1-F10', 'P1-F11',
            // Plate 2
            'P2-A1', 'P2-A2', 'P2-A3', 'P2-A4', 'P2-A5', 'P2-A6', 'P2-A7', 'P2-A8', 'P2-A9', 'P2-A10', 'P2-A11',
            'P2-B1', 'P2-B2', 'P2-B3', 'P2-B4', 'P2-B5', 'P2-B6', 'P2-B7', 'P2-B8', 'P2-B9', 'P2-B10', 'P2-B11',
            'P2-C1', 'P2-C2', 'P2-C3', 'P2-C4', 'P2-C5', 'P2-C6', 'P2-C7', 'P2-C8', 'P2-C9', 'P2-C10', 'P2-C11',
            'P2-D1', 'P2-D2', 'P2-D3', 'P2-D4', 'P2-D5', 'P2-D6', 'P2-D7', 'P2-D8', 'P2-D9', 'P2-D10', 'P2-D11',
            'P2-E1'
        ];
        
        // Fixed positions for special samples
        const CARRYOVER_POS = 'P1-A1';
        const NIST_POS = 'P2-F1';
        
        // Set default date to today
        document.getElementById('date').valueAsDate = new Date();
        
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            document.body.classList.toggle('admin-mode', isAdminMode);
            
            const btn = document.querySelector('.toggle-admin');
            btn.textContent = isAdminMode ? 'üîì Admin Mode ON' : 'üîë Toggle Admin Mode';
            btn.style.background = isAdminMode ? '#28a745' : '#E94B00';
        }
        
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        function validateInputs() {
            const project = document.getElementById('project').value;
            const date = document.getElementById('date').value;
            const sampleName = document.getElementById('sampleName').value;
            const batch = document.getElementById('batch').value;
            const sampleMethod = document.getElementById('sampleMethod').value;
            const carryMethod = document.getElementById('carryMethod').value;
            const nistMethod = document.getElementById('nistMethod').value;
            
            if (!project || !date || !sampleName || !batch || !sampleMethod || !carryMethod || !nistMethod) {
                showStatus('Please fill in all required fields', 'error');
                return false;
            }
            
            return true;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function generateTable() {
            if (!validateInputs()) return;
            
            // Get form values
            const project = document.getElementById('project').value;
            const date = document.getElementById('date').value;
            const sampleName = document.getElementById('sampleName').value;
            const batch = parseInt(document.getElementById('batch').value);
            const sampleMethod = document.getElementById('sampleMethod').value;
            const carryStep = parseInt(document.getElementById('carryStep').value);
            const carryMethod = document.getElementById('carryMethod').value;
            const nistStep = parseInt(document.getElementById('nistStep').value);
            const nistMethod = document.getElementById('nistMethod').value;
            
            // Format date for file paths
            const formattedDate = formatDate(date);
            
            // Calculate batch range for folder name
            const batchStart = batch + 1;
            const batchEnd = batch + 100; // Assuming 100 samples per batch
            const folderName = `${project}_${batchStart.toString().padStart(4, '0')}-${batchEnd.toString().padStart(4, '0')}(${formattedDate})`;
            
            // Generate all entries first, then sort by order
            const allEntries = [];
            let samplePosIndex = 0;
            let order = 1;
            
            // Generate samples
            for (let i = 1; i <= 100; i++) { // 100 samples
                const sampleNumber = batch + i;
                
                // Add regular sample
                const sampleRow = {
                    sampleName: `${project}_${sampleNumber.toString().padStart(4, '0')}`,
                    pos: POSITION_MAP[samplePosIndex] || `P2-E${i}`, // Use position map
                    method: sampleMethod,
                    dataFile: `D:\\Projects\\OQ-2024\\Data\\${project}\\${folderName}\\${project}_${sampleNumber.toString().padStart(4, '0')}.d`,
                    order: order,
                    type: 'sample'
                };
                allEntries.push(sampleRow);
                samplePosIndex++;
                order++;
                
                // Add carry over every carryStep samples
                if (i % carryStep === 0) {
                    const carryOverRow = {
                        sampleName: `carryover_${Math.floor(i/carryStep).toString().padStart(2, '0')}`,
                        pos: CARRYOVER_POS,
                        method: carryMethod,
                        dataFile: `D:\\Projects\\OQ-2024\\Data\\${project}\\${folderName}\\carryover_${Math.floor(i/carryStep).toString().padStart(2, '0')}.d`,
                        order: order,
                        type: 'carryover'
                    };
                    allEntries.push(carryOverRow);
                    order++;
                }
                
                // Add NIST every nistStep samples
                if (i % nistStep === 0) {
                    const nistNumber = Math.floor(i/nistStep);
                    const nistRow = {
                        sampleName: `NIST_${batch+1}-${batch+100} (${nistNumber})`,
                        pos: NIST_POS,
                        method: nistMethod,
                        dataFile: `D:\\Projects\\OQ-2024\\Data\\${project}\\${folderName}\\NIST_${batch+1}-${batch+100}_${nistNumber}.d`,
                        order: order,
                        type: 'nist'
                    };
                    allEntries.push(nistRow);
                    order++;
                }
            }
            
            // Sort by order and assign to generatedData
            generatedData = allEntries.sort((a, b) => a.order - b.order);
            
            // Display preview table
            displayPreviewTable();
            document.getElementById('previewContainer').style.display = 'block';
            showStatus(`Generated ${generatedData.length} rows successfully!`, 'success');
        }
        
        function displayPreviewTable() {
            const table = document.getElementById('previewTable');
            
            // Create table header - matching your format
            const headers = ['Order', 'Sample Name (thay ƒë·ªïi)', 'Pos (fixed)', 'Method', 'Data File'];
            
            let tableHTML = '<thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Create table rows
            generatedData.forEach((row, index) => {
                const rowClass = row.type === 'carryover' ? 'sample-type-carryover' : 
                                row.type === 'nist' ? 'sample-type-nist' : '';
                
                tableHTML += `<tr class="${rowClass}">
                    <td>${row.order}</td>
                    <td>${row.sampleName}</td>
                    <td>${row.pos}</td>
                    <td>${row.method}</td>
                    <td style="font-size: 0.8rem;">${row.dataFile}</td>
                </tr>`;
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
        }
        
        function calculateChange(index) {
            // Placeholder calculation - replace with actual formula
            // This would be based on your Vietnamese "Change" column requirements
            return (index + 1) * 1.5;
        }
        
        function downloadExcel() {
            if (generatedData.length === 0) {
                showStatus('No data to export. Please generate table first.', 'error');
                return;
            }
            
            // Prepare data for Excel export - removed Change and Type columns
            const excelData = generatedData.map((row, index) => ({
                'Order': row.order,
                'Sample Name (thay ƒë·ªïi)': row.sampleName,
                'Pos (fixed)': row.pos,
                'Method': row.method,
                'Data File': row.dataFile
            }));
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Analysis Data');
            
            // Generate filename
            const project = document.getElementById('project').value;
            const date = formatDate(document.getElementById('date').value);
            const batch = document.getElementById('batch').value;
            const filename = `${project}_${batch}_${date}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
            showStatus(`Excel file "${filename}" downloaded successfully!`, 'success');
        }
        
        // Position management functions
        function exportPositions() {
            const positionData = {
                positions: POSITION_MAP,
                carryover_pos: CARRYOVER_POS,
                nist_pos: NIST_POS,
                exported_date: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(positionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'position_mapping.json';
            link.click();
            
            showStatus('Position mapping exported successfully!', 'success');
        }
        
        function loadCustomPositions() {
            document.getElementById('positionFileInput').click();
        }
        
        function handlePositionFile() {
            const file = document.getElementById('positionFileInput').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const positionData = JSON.parse(e.target.result);
                    
                    if (positionData.positions && Array.isArray(positionData.positions)) {
                        // Update the position map
                        POSITION_MAP.length = 0; // Clear array
                        POSITION_MAP.push(...positionData.positions);
                        
                        if (positionData.carryover_pos) CARRYOVER_POS = positionData.carryover_pos;
                        if (positionData.nist_pos) NIST_POS = positionData.nist_pos;
                        
                        document.getElementById('positionStatus').textContent = 
                            `Using custom position mapping (${POSITION_MAP.length} positions)`;
                        
                        showStatus('Custom position mapping loaded successfully!', 'success');
                    } else {
                        showStatus('Invalid position file format!', 'error');
                    }
                } catch (error) {
                    showStatus('Error loading position file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Phenikaa Analysis Tool initialized');
        });
    </script>
</body>
</html>